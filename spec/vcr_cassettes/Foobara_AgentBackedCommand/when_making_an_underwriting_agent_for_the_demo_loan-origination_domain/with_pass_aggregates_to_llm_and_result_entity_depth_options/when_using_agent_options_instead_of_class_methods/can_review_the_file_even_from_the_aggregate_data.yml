---
http_interactions:
- request:
    method: post
    uri: https://api.anthropic.com/v1/messages
    body:
      encoding: UTF-8
      string: '{"model":"claude-opus-4-20250514","max_tokens":1024,"messages":[{"role":"assistant","content":"{\"command\":\"Foobara::Agent::DescribeCommand\",\"inputs\":{\"command_name\":\"Foobara::Agent::ListCommands\"}}"},{"role":"user","content":"{\"success\":true,\"result\":{\"full_command_name\":\"Foobara::Agent::ListCommands\",\"description\":null,\"inputs_type\":{\"type\":\"object\"},\"result_type\":{\"type\":\"object\",\"required\":[\"agent_specific_commands\",\"user_provided_commands\"],\"properties\":{\"user_provided_commands\":{\"type\":\"array\",\"items\":{\"type\":\"string\"},\"description\":\"List
        of commands the user would like you to choose from to accomplish the goal\"},\"agent_specific_commands\":{\"type\":\"array\",\"items\":{\"type\":\"string\"},\"description\":\"Commands
        available to all agents to introspect or end the session\"}}}}}"},{"role":"assistant","content":"{\"command\":\"Foobara::Agent::ListCommands\"}"},{"role":"user","content":"{\"success\":true,\"result\":{\"user_provided_commands\":[\"FoobaraDemo::LoanOrigination::StartUnderwriterReview\",\"FoobaraDemo::LoanOrigination::DenyLoanFile\",\"FoobaraDemo::LoanOrigination::ApproveLoanFile\"],\"agent_specific_commands\":[\"Foobara::Agent::DescribeCommand\",\"Foobara::Agent::DescribeType\",\"Foobara::Agent::GiveUp\",\"Foobara::Agent::ListCommands\",\"Foobara::Agent::ReviewLoanFile::NotifyUserThatCurrentGoalHasBeenAccomplished\"]}}"}],"temperature":0.0,"system":"You
        are part of an agent implementation. Your task is to decide which command
        to run next.\n\nYou are working towards accomplishing the following goal:
        Review loan file\n\nYour behavior has been described to the person or agent
        that chose to run you as: Checks the LoanFile against all requirements in
        its CreditPolicy. Denies the LoanFile that has any unsatisfied requirements.\n\nYour
        inputs to this command have the following type:\n\n{\"type\":\"object\",\"required\":[\"loan_file\"],\"properties\":{\"loan_file\":{\"type\":\"object\",\"required\":[\"credit_scores\",\"loan_application\",\"pay_stubs\",\"state\"],\"properties\":{\"id\":{\"type\":\"number\"},\"loan_application\":{\"type\":\"object\",\"required\":[\"applicant\"],\"properties\":{\"applicant\":{\"type\":\"object\",\"required\":[\"name\"],\"properties\":{\"name\":{\"type\":\"string\"}}}}},\"state\":{\"type\":\"string\",\"enum\":[\"building_loan_file\",\"denied\",\"drafting_docs\",\"in_escrow\",\"in_review\",\"needs_review\",\"recorded\"]},\"pay_stubs\":{\"type\":\"array\",\"items\":{\"type\":\"object\",\"required\":[\"amount\",\"date\",\"employer\"],\"properties\":{\"amount\":{\"type\":\"number\",\"description\":\"Amount
        in dollars of the pay check\"},\"date\":{\"type\":\"string\",\"format\":\"date\",\"description\":\"Date
        the paycheck was issued\"},\"employer\":{\"type\":\"string\",\"description\":\"Name
        of the employer that issued this paycheck\"}}}},\"credit_scores\":{\"type\":\"array\",\"items\":{\"type\":\"object\",\"properties\":{\"score\":{\"type\":\"number\"},\"reporting_agency\":{\"type\":\"string\",\"enum\":[\"equifax\",\"experian\",\"transunion\"]}}}},\"underwriter_decision\":{\"type\":[\"object\",\"null\"],\"required\":[\"credit_score_used\",\"decision\"],\"properties\":{\"decision\":{\"type\":\"string\",\"enum\":[\"approved\",\"denied\"]},\"credit_score_used\":{\"type\":\"number\"},\"denied_reasons\":{\"type\":\"array\",\"items\":{\"type\":\"string\",\"enum\":[\"insufficient_pay_stubs_provided\",\"low_credit_score\"]}}}},\"credit_policy\":{\"type\":\"object\",\"required\":[\"credit_score_to_use\",\"institution\",\"minimum_credit_score\",\"minimum_pay_stub_count\"],\"properties\":{\"id\":{\"type\":\"number\"},\"institution\":{\"type\":\"string\"},\"minimum_pay_stub_count\":{\"type\":\"number\",\"description\":\"The
        loan file must have at least this many pay stubs.\"},\"minimum_credit_score\":{\"type\":\"number\"},\"credit_score_to_use\":{\"type\":\"string\",\"enum\":[\"median\",\"maximum\"],\"description\":\"If
        the scores are 500, 650, and 700, then maximum will compare the biggest (700)
        against minimum_credit_score and median will compare the median (650) against
        minimum_credit_score.\"}}}}}}}\n\nYou have been ran with the following inputs:\n\n{\"loan_file\":{\"id\":1,\"state\":\"needs_review\",\"pay_stubs\":[{\"amount\":3000,\"date\":\"2025-06-25\",\"employer\":\"Some
        Employer\"}],\"credit_scores\":[{\"reporting_agency\":\"experian\",\"score\":600},{\"reporting_agency\":\"equifax\",\"score\":650},{\"reporting_agency\":\"transunion\",\"score\":750}],\"loan_application\":{\"applicant\":{\"name\":\"Barbara\"}},\"credit_policy\":{\"id\":1,\"institution\":\"Bank
        A\",\"minimum_credit_score\":700,\"credit_score_to_use\":\"median\",\"minimum_pay_stub_count\":1}}}\n\nYou
        will answer with the name of the next command to run and, if needed, its inputs.
        Choose whichever command is best to make progress towards accomplishing the
        current goal based on the progress made so far. If the goal has been accomplished
        then choose the NotifyUserThatCurrentGoalHasBeenAccomplished command. If you
        are stuck either due to errors or because you do not have the command you
        need to accomplish the goal, then choose GiveUp.\n\nYou can get more details
        about the inputs and result schemas for a specific command by choosing the
        DescribeCommand command.\n\nYour result type is described by the following
        JSON schema:\n\n{\"type\":\"object\",\"required\":[\"command\"],\"properties\":{\"command\":{\"type\":\"string\"},\"inputs\":{\"type\":[\"object\",\"null\"]}}}\n\nYou
        will reply with nothing more than the JSON that you''ve generated that adheres
        to this result type schema so that the calling code can successfully parse
        your answer."}'
    headers:
      Content-Type:
      - application/json
      X-Api-Key:
      - "<SCRUBBED_ANTHROPIC_API_KEY>"
      Anthropic-Version:
      - '2023-06-01'
      Accept-Encoding:
      - gzip;q=1.0,deflate;q=0.6,identity;q=0.3
      Accept:
      - "*/*"
      User-Agent:
      - Ruby
  response:
    status:
      code: 200
      message: OK
    headers:
      Date:
      - Wed, 23 Jul 2025 20:41:47 GMT
      Content-Type:
      - application/json
      Transfer-Encoding:
      - chunked
      Connection:
      - keep-alive
      Anthropic-Ratelimit-Input-Tokens-Limit:
      - '80000'
      Anthropic-Ratelimit-Input-Tokens-Remaining:
      - '80000'
      Anthropic-Ratelimit-Input-Tokens-Reset:
      - '2025-07-23T20:41:43Z'
      Anthropic-Ratelimit-Output-Tokens-Limit:
      - '16000'
      Anthropic-Ratelimit-Output-Tokens-Remaining:
      - '16000'
      Anthropic-Ratelimit-Output-Tokens-Reset:
      - '2025-07-23T20:41:48Z'
      Anthropic-Ratelimit-Requests-Limit:
      - '2000'
      Anthropic-Ratelimit-Requests-Remaining:
      - '1999'
      Anthropic-Ratelimit-Requests-Reset:
      - '2025-07-23T20:41:42Z'
      Anthropic-Ratelimit-Tokens-Limit:
      - '96000'
      Anthropic-Ratelimit-Tokens-Remaining:
      - '96000'
      Anthropic-Ratelimit-Tokens-Reset:
      - '2025-07-23T20:41:43Z'
      Request-Id:
      - req_011CRQbhgPJDaA616Xup49Cs
      Strict-Transport-Security:
      - max-age=31536000; includeSubDomains; preload
      Anthropic-Organization-Id:
      - 7a8e3751-3b70-4f90-a3ce-07f57c9d0bfc
      Via:
      - 1.1 google
      Cf-Cache-Status:
      - DYNAMIC
      X-Robots-Tag:
      - none
      Server:
      - cloudflare
      Cf-Ray:
      - 963e000609f8ed3b-SJC
    body:
      encoding: ASCII-8BIT
      string: '{"id":"msg_01MwYtN65vaipoBCrhrFuDtD","type":"message","role":"assistant","model":"claude-opus-4-20250514","content":[{"type":"text","text":"I
        need to review the loan file against the credit policy requirements. Let me
        check what the requirements are:\n\n1. The credit policy requires a minimum
        credit score of 700\n2. The credit score to use is \"median\" \n3. The minimum
        pay stub count is 1\n\nLooking at the loan file:\n- Credit scores: 600 (Experian),
        650 (Equifax), 750 (TransUnion)\n- The median credit score is 650\n- Pay stubs:
        1 pay stub provided (meets the minimum requirement of 1)\n\nSince the median
        credit score (650) is below the minimum required credit score (700), this
        loan file does not meet the credit policy requirements and should be denied.\n\n{\"command\":\"FoobaraDemo::LoanOrigination::DenyLoanFile\",\"inputs\":{\"loan_file_id\":1,\"denied_reasons\":[\"low_credit_score\"]}}"}],"stop_reason":"end_turn","stop_sequence":null,"usage":{"input_tokens":1373,"cache_creation_input_tokens":0,"cache_read_input_tokens":0,"output_tokens":206,"service_tier":"standard"}}'
  recorded_at: Wed, 23 Jul 2025 20:41:47 GMT
- request:
    method: post
    uri: https://api.anthropic.com/v1/messages
    body:
      encoding: UTF-8
      string: '{"model":"claude-opus-4-20250514","max_tokens":1024,"messages":[{"role":"assistant","content":"{\"command\":\"Foobara::Agent::DescribeCommand\",\"inputs\":{\"command_name\":\"Foobara::Agent::ListCommands\"}}"},{"role":"user","content":"{\"success\":true,\"result\":{\"full_command_name\":\"Foobara::Agent::ListCommands\",\"description\":null,\"inputs_type\":{\"type\":\"object\"},\"result_type\":{\"type\":\"object\",\"required\":[\"agent_specific_commands\",\"user_provided_commands\"],\"properties\":{\"user_provided_commands\":{\"type\":\"array\",\"items\":{\"type\":\"string\"},\"description\":\"List
        of commands the user would like you to choose from to accomplish the goal\"},\"agent_specific_commands\":{\"type\":\"array\",\"items\":{\"type\":\"string\"},\"description\":\"Commands
        available to all agents to introspect or end the session\"}}}}}"},{"role":"assistant","content":"{\"command\":\"Foobara::Agent::ListCommands\"}"},{"role":"user","content":"{\"success\":true,\"result\":{\"user_provided_commands\":[\"FoobaraDemo::LoanOrigination::StartUnderwriterReview\",\"FoobaraDemo::LoanOrigination::DenyLoanFile\",\"FoobaraDemo::LoanOrigination::ApproveLoanFile\"],\"agent_specific_commands\":[\"Foobara::Agent::DescribeCommand\",\"Foobara::Agent::DescribeType\",\"Foobara::Agent::GiveUp\",\"Foobara::Agent::ListCommands\",\"Foobara::Agent::ReviewLoanFile::NotifyUserThatCurrentGoalHasBeenAccomplished\"]}}"},{"role":"assistant","content":"{\"command\":\"Foobara::Agent::DetermineNextCommandNameAndInputs\",\"inputs\":{\"agent\":\"#<Foobara::Agent:0x00007fb77c4eeea0>\",\"llm_model\":\"claude-opus-4-20250514\",\"pass_aggregates_to_llm\":true}}"},{"role":"user","content":"{\"success\":false,\"errors_hash\":{\"runtime.could_not_parse_result_json\":{\"key\":\"runtime.could_not_parse_result_json\",\"path\":[],\"runtime_path\":[],\"category\":\"runtime\",\"symbol\":\"could_not_parse_result_json\",\"message\":\"Could
        not parse result JSON: unexpected token ''I'' at line 1 column 1\",\"context\":{\"raw_answer\":\"I
        need to review the loan file against the credit policy requirements. Let me
        check what the requirements are:\\n\\n1. The credit policy requires a minimum
        credit score of 700\\n2. The credit score to use is \\\"median\\\" \\n3. The
        minimum pay stub count is 1\\n\\nLooking at the loan file:\\n- Credit scores:
        600 (Experian), 650 (Equifax), 750 (TransUnion)\\n- The median credit score
        is 650\\n- Pay stubs: 1 pay stub provided (meets the minimum requirement of
        1)\\n\\nSince the median credit score (650) is below the minimum required
        credit score (700), this loan file does not meet the credit policy requirements
        and should be denied.\\n\\n{\\\"command\\\":\\\"FoobaraDemo::LoanOrigination::DenyLoanFile\\\",\\\"inputs\\\":{\\\"loan_file_id\\\":1,\\\"denied_reasons\\\":[\\\"low_credit_score\\\"]}}\",\"stripped_answer\":\"I
        need to review the loan file against the credit policy requirements. Let me
        check what the requirements are:\\n\\n1. The credit policy requires a minimum
        credit score of 700\\n2. The credit score to use is \\\"median\\\" \\n3. The
        minimum pay stub count is 1\\n\\nLooking at the loan file:\\n- Credit scores:
        600 (Experian), 650 (Equifax), 750 (TransUnion)\\n- The median credit score
        is 650\\n- Pay stubs: 1 pay stub provided (meets the minimum requirement of
        1)\\n\\nSince the median credit score (650) is below the minimum required
        credit score (700), this loan file does not meet the credit policy requirements
        and should be denied.\\n\\n{\\\"command\\\":\\\"FoobaraDemo::LoanOrigination::DenyLoanFile\\\",\\\"inputs\\\":{\\\"loan_file_id\\\":1,\\\"denied_reasons\\\":[\\\"low_credit_score\\\"]}}\"},\"is_fatal\":false}}}"}],"temperature":0.0,"system":"You
        are part of an agent implementation. Your task is to decide which command
        to run next.\n\nYou are working towards accomplishing the following goal:
        Review loan file\n\nYour behavior has been described to the person or agent
        that chose to run you as: Checks the LoanFile against all requirements in
        its CreditPolicy. Denies the LoanFile that has any unsatisfied requirements.\n\nYour
        inputs to this command have the following type:\n\n{\"type\":\"object\",\"required\":[\"loan_file\"],\"properties\":{\"loan_file\":{\"type\":\"object\",\"required\":[\"credit_scores\",\"loan_application\",\"pay_stubs\",\"state\"],\"properties\":{\"id\":{\"type\":\"number\"},\"loan_application\":{\"type\":\"object\",\"required\":[\"applicant\"],\"properties\":{\"applicant\":{\"type\":\"object\",\"required\":[\"name\"],\"properties\":{\"name\":{\"type\":\"string\"}}}}},\"state\":{\"type\":\"string\",\"enum\":[\"building_loan_file\",\"denied\",\"drafting_docs\",\"in_escrow\",\"in_review\",\"needs_review\",\"recorded\"]},\"pay_stubs\":{\"type\":\"array\",\"items\":{\"type\":\"object\",\"required\":[\"amount\",\"date\",\"employer\"],\"properties\":{\"amount\":{\"type\":\"number\",\"description\":\"Amount
        in dollars of the pay check\"},\"date\":{\"type\":\"string\",\"format\":\"date\",\"description\":\"Date
        the paycheck was issued\"},\"employer\":{\"type\":\"string\",\"description\":\"Name
        of the employer that issued this paycheck\"}}}},\"credit_scores\":{\"type\":\"array\",\"items\":{\"type\":\"object\",\"properties\":{\"score\":{\"type\":\"number\"},\"reporting_agency\":{\"type\":\"string\",\"enum\":[\"equifax\",\"experian\",\"transunion\"]}}}},\"underwriter_decision\":{\"type\":[\"object\",\"null\"],\"required\":[\"credit_score_used\",\"decision\"],\"properties\":{\"decision\":{\"type\":\"string\",\"enum\":[\"approved\",\"denied\"]},\"credit_score_used\":{\"type\":\"number\"},\"denied_reasons\":{\"type\":\"array\",\"items\":{\"type\":\"string\",\"enum\":[\"insufficient_pay_stubs_provided\",\"low_credit_score\"]}}}},\"credit_policy\":{\"type\":\"object\",\"required\":[\"credit_score_to_use\",\"institution\",\"minimum_credit_score\",\"minimum_pay_stub_count\"],\"properties\":{\"id\":{\"type\":\"number\"},\"institution\":{\"type\":\"string\"},\"minimum_pay_stub_count\":{\"type\":\"number\",\"description\":\"The
        loan file must have at least this many pay stubs.\"},\"minimum_credit_score\":{\"type\":\"number\"},\"credit_score_to_use\":{\"type\":\"string\",\"enum\":[\"median\",\"maximum\"],\"description\":\"If
        the scores are 500, 650, and 700, then maximum will compare the biggest (700)
        against minimum_credit_score and median will compare the median (650) against
        minimum_credit_score.\"}}}}}}}\n\nYou have been ran with the following inputs:\n\n{\"loan_file\":{\"id\":1,\"state\":\"needs_review\",\"pay_stubs\":[{\"amount\":3000,\"date\":\"2025-06-25\",\"employer\":\"Some
        Employer\"}],\"credit_scores\":[{\"reporting_agency\":\"experian\",\"score\":600},{\"reporting_agency\":\"equifax\",\"score\":650},{\"reporting_agency\":\"transunion\",\"score\":750}],\"loan_application\":{\"applicant\":{\"name\":\"Barbara\"}},\"credit_policy\":{\"id\":1,\"institution\":\"Bank
        A\",\"minimum_credit_score\":700,\"credit_score_to_use\":\"median\",\"minimum_pay_stub_count\":1}}}\n\nYou
        will answer with the name of the next command to run and, if needed, its inputs.
        Choose whichever command is best to make progress towards accomplishing the
        current goal based on the progress made so far. If the goal has been accomplished
        then choose the NotifyUserThatCurrentGoalHasBeenAccomplished command. If you
        are stuck either due to errors or because you do not have the command you
        need to accomplish the goal, then choose GiveUp.\n\nYou can get more details
        about the inputs and result schemas for a specific command by choosing the
        DescribeCommand command.\n\nYour result type is described by the following
        JSON schema:\n\n{\"type\":\"object\",\"required\":[\"command\"],\"properties\":{\"command\":{\"type\":\"string\"},\"inputs\":{\"type\":[\"object\",\"null\"]}}}\n\nYou
        will reply with nothing more than the JSON that you''ve generated that adheres
        to this result type schema so that the calling code can successfully parse
        your answer."}'
    headers:
      Content-Type:
      - application/json
      X-Api-Key:
      - "<SCRUBBED_ANTHROPIC_API_KEY>"
      Anthropic-Version:
      - '2023-06-01'
      Accept-Encoding:
      - gzip;q=1.0,deflate;q=0.6,identity;q=0.3
      Accept:
      - "*/*"
      User-Agent:
      - Ruby
  response:
    status:
      code: 200
      message: OK
    headers:
      Date:
      - Wed, 23 Jul 2025 20:41:50 GMT
      Content-Type:
      - application/json
      Transfer-Encoding:
      - chunked
      Connection:
      - keep-alive
      Anthropic-Ratelimit-Input-Tokens-Limit:
      - '80000'
      Anthropic-Ratelimit-Input-Tokens-Remaining:
      - '80000'
      Anthropic-Ratelimit-Input-Tokens-Reset:
      - '2025-07-23T20:41:49Z'
      Anthropic-Ratelimit-Output-Tokens-Limit:
      - '16000'
      Anthropic-Ratelimit-Output-Tokens-Remaining:
      - '16000'
      Anthropic-Ratelimit-Output-Tokens-Reset:
      - '2025-07-23T20:41:50Z'
      Anthropic-Ratelimit-Requests-Limit:
      - '2000'
      Anthropic-Ratelimit-Requests-Remaining:
      - '1999'
      Anthropic-Ratelimit-Requests-Reset:
      - '2025-07-23T20:41:48Z'
      Anthropic-Ratelimit-Tokens-Limit:
      - '96000'
      Anthropic-Ratelimit-Tokens-Remaining:
      - '96000'
      Anthropic-Ratelimit-Tokens-Reset:
      - '2025-07-23T20:41:49Z'
      Request-Id:
      - req_011CRQbi8TSmy8Rskr1jZBL4
      Strict-Transport-Security:
      - max-age=31536000; includeSubDomains; preload
      Anthropic-Organization-Id:
      - 7a8e3751-3b70-4f90-a3ce-07f57c9d0bfc
      Via:
      - 1.1 google
      Cf-Cache-Status:
      - DYNAMIC
      X-Robots-Tag:
      - none
      Server:
      - cloudflare
      Cf-Ray:
      - 963e002c0bbcebf1-SJC
    body:
      encoding: ASCII-8BIT
      string: '{"id":"msg_01CBZp9kxRGBeKNaT347p58t","type":"message","role":"assistant","model":"claude-opus-4-20250514","content":[{"type":"text","text":"{\"command\":\"FoobaraDemo::LoanOrigination::DenyLoanFile\",\"inputs\":{\"loan_file_id\":1,\"denied_reasons\":[\"low_credit_score\"]}}"}],"stop_reason":"end_turn","stop_sequence":null,"usage":{"input_tokens":2011,"cache_creation_input_tokens":0,"cache_read_input_tokens":0,"output_tokens":46,"service_tier":"standard"}}'
  recorded_at: Wed, 23 Jul 2025 20:41:50 GMT
- request:
    method: post
    uri: https://api.anthropic.com/v1/messages
    body:
      encoding: UTF-8
      string: '{"model":"claude-opus-4-20250514","max_tokens":1024,"messages":[{"role":"assistant","content":"{\"command\":\"Foobara::Agent::DescribeCommand\",\"inputs\":{\"command_name\":\"Foobara::Agent::ListCommands\"}}"},{"role":"user","content":"{\"success\":true,\"result\":{\"full_command_name\":\"Foobara::Agent::ListCommands\",\"description\":null,\"inputs_type\":{\"type\":\"object\"},\"result_type\":{\"type\":\"object\",\"required\":[\"agent_specific_commands\",\"user_provided_commands\"],\"properties\":{\"user_provided_commands\":{\"type\":\"array\",\"items\":{\"type\":\"string\"},\"description\":\"List
        of commands the user would like you to choose from to accomplish the goal\"},\"agent_specific_commands\":{\"type\":\"array\",\"items\":{\"type\":\"string\"},\"description\":\"Commands
        available to all agents to introspect or end the session\"}}}}}"},{"role":"assistant","content":"{\"command\":\"Foobara::Agent::ListCommands\"}"},{"role":"user","content":"{\"success\":true,\"result\":{\"user_provided_commands\":[\"FoobaraDemo::LoanOrigination::StartUnderwriterReview\",\"FoobaraDemo::LoanOrigination::DenyLoanFile\",\"FoobaraDemo::LoanOrigination::ApproveLoanFile\"],\"agent_specific_commands\":[\"Foobara::Agent::DescribeCommand\",\"Foobara::Agent::DescribeType\",\"Foobara::Agent::GiveUp\",\"Foobara::Agent::ListCommands\",\"Foobara::Agent::ReviewLoanFile::NotifyUserThatCurrentGoalHasBeenAccomplished\"]}}"},{"role":"assistant","content":"{\"command\":\"Foobara::Agent::DetermineNextCommandNameAndInputs\",\"inputs\":{\"agent\":\"#<Foobara::Agent:0x00007fb77c4eeea0>\",\"llm_model\":\"claude-opus-4-20250514\",\"pass_aggregates_to_llm\":true}}"},{"role":"user","content":"{\"success\":false,\"errors_hash\":{\"runtime.could_not_parse_result_json\":{\"key\":\"runtime.could_not_parse_result_json\",\"path\":[],\"runtime_path\":[],\"category\":\"runtime\",\"symbol\":\"could_not_parse_result_json\",\"message\":\"Could
        not parse result JSON: unexpected token ''I'' at line 1 column 1\",\"context\":{\"raw_answer\":\"I
        need to review the loan file against the credit policy requirements. Let me
        check what the requirements are:\\n\\n1. The credit policy requires a minimum
        credit score of 700\\n2. The credit score to use is \\\"median\\\" \\n3. The
        minimum pay stub count is 1\\n\\nLooking at the loan file:\\n- Credit scores:
        600 (Experian), 650 (Equifax), 750 (TransUnion)\\n- The median credit score
        is 650\\n- Pay stubs: 1 pay stub provided (meets the minimum requirement of
        1)\\n\\nSince the median credit score (650) is below the minimum required
        credit score (700), this loan file does not meet the credit policy requirements
        and should be denied.\\n\\n{\\\"command\\\":\\\"FoobaraDemo::LoanOrigination::DenyLoanFile\\\",\\\"inputs\\\":{\\\"loan_file_id\\\":1,\\\"denied_reasons\\\":[\\\"low_credit_score\\\"]}}\",\"stripped_answer\":\"I
        need to review the loan file against the credit policy requirements. Let me
        check what the requirements are:\\n\\n1. The credit policy requires a minimum
        credit score of 700\\n2. The credit score to use is \\\"median\\\" \\n3. The
        minimum pay stub count is 1\\n\\nLooking at the loan file:\\n- Credit scores:
        600 (Experian), 650 (Equifax), 750 (TransUnion)\\n- The median credit score
        is 650\\n- Pay stubs: 1 pay stub provided (meets the minimum requirement of
        1)\\n\\nSince the median credit score (650) is below the minimum required
        credit score (700), this loan file does not meet the credit policy requirements
        and should be denied.\\n\\n{\\\"command\\\":\\\"FoobaraDemo::LoanOrigination::DenyLoanFile\\\",\\\"inputs\\\":{\\\"loan_file_id\\\":1,\\\"denied_reasons\\\":[\\\"low_credit_score\\\"]}}\"},\"is_fatal\":false}}}"},{"role":"assistant","content":"{\"command\":\"Foobara::Agent::DescribeCommand\",\"inputs\":{\"command_name\":\"FoobaraDemo::LoanOrigination::DenyLoanFile\"}}"},{"role":"user","content":"{\"success\":true,\"result\":{\"full_command_name\":\"FoobaraDemo::LoanOrigination::DenyLoanFile\",\"description\":null,\"inputs_type\":{\"type\":\"object\",\"required\":[\"credit_score_used\",\"denied_reasons\",\"loan_file\"],\"properties\":{\"credit_score_used\":{\"type\":\"number\"},\"denied_reasons\":{\"type\":\"array\",\"items\":{\"type\":\"string\",\"enum\":[\"insufficient_pay_stubs_provided\",\"low_credit_score\"]}},\"loan_file\":{\"type\":\"number\",\"description\":\"LoanFile
        id\"}}}}}"}],"temperature":0.0,"system":"You are part of an agent implementation.
        Your task is to decide which command to run next.\n\nYou are working towards
        accomplishing the following goal: Review loan file\n\nYour behavior has been
        described to the person or agent that chose to run you as: Checks the LoanFile
        against all requirements in its CreditPolicy. Denies the LoanFile that has
        any unsatisfied requirements.\n\nYour inputs to this command have the following
        type:\n\n{\"type\":\"object\",\"required\":[\"loan_file\"],\"properties\":{\"loan_file\":{\"type\":\"object\",\"required\":[\"credit_scores\",\"loan_application\",\"pay_stubs\",\"state\"],\"properties\":{\"id\":{\"type\":\"number\"},\"loan_application\":{\"type\":\"object\",\"required\":[\"applicant\"],\"properties\":{\"applicant\":{\"type\":\"object\",\"required\":[\"name\"],\"properties\":{\"name\":{\"type\":\"string\"}}}}},\"state\":{\"type\":\"string\",\"enum\":[\"building_loan_file\",\"denied\",\"drafting_docs\",\"in_escrow\",\"in_review\",\"needs_review\",\"recorded\"]},\"pay_stubs\":{\"type\":\"array\",\"items\":{\"type\":\"object\",\"required\":[\"amount\",\"date\",\"employer\"],\"properties\":{\"amount\":{\"type\":\"number\",\"description\":\"Amount
        in dollars of the pay check\"},\"date\":{\"type\":\"string\",\"format\":\"date\",\"description\":\"Date
        the paycheck was issued\"},\"employer\":{\"type\":\"string\",\"description\":\"Name
        of the employer that issued this paycheck\"}}}},\"credit_scores\":{\"type\":\"array\",\"items\":{\"type\":\"object\",\"properties\":{\"score\":{\"type\":\"number\"},\"reporting_agency\":{\"type\":\"string\",\"enum\":[\"equifax\",\"experian\",\"transunion\"]}}}},\"underwriter_decision\":{\"type\":[\"object\",\"null\"],\"required\":[\"credit_score_used\",\"decision\"],\"properties\":{\"decision\":{\"type\":\"string\",\"enum\":[\"approved\",\"denied\"]},\"credit_score_used\":{\"type\":\"number\"},\"denied_reasons\":{\"type\":\"array\",\"items\":{\"type\":\"string\",\"enum\":[\"insufficient_pay_stubs_provided\",\"low_credit_score\"]}}}},\"credit_policy\":{\"type\":\"object\",\"required\":[\"credit_score_to_use\",\"institution\",\"minimum_credit_score\",\"minimum_pay_stub_count\"],\"properties\":{\"id\":{\"type\":\"number\"},\"institution\":{\"type\":\"string\"},\"minimum_pay_stub_count\":{\"type\":\"number\",\"description\":\"The
        loan file must have at least this many pay stubs.\"},\"minimum_credit_score\":{\"type\":\"number\"},\"credit_score_to_use\":{\"type\":\"string\",\"enum\":[\"median\",\"maximum\"],\"description\":\"If
        the scores are 500, 650, and 700, then maximum will compare the biggest (700)
        against minimum_credit_score and median will compare the median (650) against
        minimum_credit_score.\"}}}}}}}\n\nYou have been ran with the following inputs:\n\n{\"loan_file\":{\"id\":1,\"state\":\"needs_review\",\"pay_stubs\":[{\"amount\":3000,\"date\":\"2025-06-25\",\"employer\":\"Some
        Employer\"}],\"credit_scores\":[{\"reporting_agency\":\"experian\",\"score\":600},{\"reporting_agency\":\"equifax\",\"score\":650},{\"reporting_agency\":\"transunion\",\"score\":750}],\"loan_application\":{\"applicant\":{\"name\":\"Barbara\"}},\"credit_policy\":{\"id\":1,\"institution\":\"Bank
        A\",\"minimum_credit_score\":700,\"credit_score_to_use\":\"median\",\"minimum_pay_stub_count\":1}}}\n\nYou
        will answer with the name of the next command to run and, if needed, its inputs.
        Choose whichever command is best to make progress towards accomplishing the
        current goal based on the progress made so far. If the goal has been accomplished
        then choose the NotifyUserThatCurrentGoalHasBeenAccomplished command. If you
        are stuck either due to errors or because you do not have the command you
        need to accomplish the goal, then choose GiveUp.\n\nYou can get more details
        about the inputs and result schemas for a specific command by choosing the
        DescribeCommand command.\n\nYour result type is described by the following
        JSON schema:\n\n{\"type\":\"object\",\"required\":[\"command\"],\"properties\":{\"command\":{\"type\":\"string\"},\"inputs\":{\"type\":[\"object\",\"null\"]}}}\n\nYou
        will reply with nothing more than the JSON that you''ve generated that adheres
        to this result type schema so that the calling code can successfully parse
        your answer."}'
    headers:
      Content-Type:
      - application/json
      X-Api-Key:
      - "<SCRUBBED_ANTHROPIC_API_KEY>"
      Anthropic-Version:
      - '2023-06-01'
      Accept-Encoding:
      - gzip;q=1.0,deflate;q=0.6,identity;q=0.3
      Accept:
      - "*/*"
      User-Agent:
      - Ruby
  response:
    status:
      code: 200
      message: OK
    headers:
      Date:
      - Wed, 23 Jul 2025 20:41:53 GMT
      Content-Type:
      - application/json
      Transfer-Encoding:
      - chunked
      Connection:
      - keep-alive
      Anthropic-Ratelimit-Input-Tokens-Limit:
      - '80000'
      Anthropic-Ratelimit-Input-Tokens-Remaining:
      - '79000'
      Anthropic-Ratelimit-Input-Tokens-Reset:
      - '2025-07-23T20:41:52Z'
      Anthropic-Ratelimit-Output-Tokens-Limit:
      - '16000'
      Anthropic-Ratelimit-Output-Tokens-Remaining:
      - '16000'
      Anthropic-Ratelimit-Output-Tokens-Reset:
      - '2025-07-23T20:41:53Z'
      Anthropic-Ratelimit-Requests-Limit:
      - '2000'
      Anthropic-Ratelimit-Requests-Remaining:
      - '1999'
      Anthropic-Ratelimit-Requests-Reset:
      - '2025-07-23T20:41:51Z'
      Anthropic-Ratelimit-Tokens-Limit:
      - '96000'
      Anthropic-Ratelimit-Tokens-Remaining:
      - '95000'
      Anthropic-Ratelimit-Tokens-Reset:
      - '2025-07-23T20:41:52Z'
      Request-Id:
      - req_011CRQbiLymQGm4hDD4AFTH3
      Strict-Transport-Security:
      - max-age=31536000; includeSubDomains; preload
      Anthropic-Organization-Id:
      - 7a8e3751-3b70-4f90-a3ce-07f57c9d0bfc
      Via:
      - 1.1 google
      Cf-Cache-Status:
      - DYNAMIC
      X-Robots-Tag:
      - none
      Server:
      - cloudflare
      Cf-Ray:
      - 963e003e7806cf26-SJC
    body:
      encoding: ASCII-8BIT
      string: '{"id":"msg_01KopyNnKWcpLLutpAZUUcPB","type":"message","role":"assistant","model":"claude-opus-4-20250514","content":[{"type":"text","text":"{\"command\":\"FoobaraDemo::LoanOrigination::DenyLoanFile\",\"inputs\":{\"loan_file\":1,\"credit_score_used\":650,\"denied_reasons\":[\"low_credit_score\"]}}"}],"stop_reason":"end_turn","stop_sequence":null,"usage":{"input_tokens":2188,"cache_creation_input_tokens":0,"cache_read_input_tokens":0,"output_tokens":52,"service_tier":"standard"}}'
  recorded_at: Wed, 23 Jul 2025 20:41:53 GMT
- request:
    method: post
    uri: https://api.anthropic.com/v1/messages
    body:
      encoding: UTF-8
      string: '{"model":"claude-opus-4-20250514","max_tokens":1024,"messages":[{"role":"assistant","content":"{\"command\":\"Foobara::Agent::DescribeCommand\",\"inputs\":{\"command_name\":\"Foobara::Agent::ListCommands\"}}"},{"role":"user","content":"{\"success\":true,\"result\":{\"full_command_name\":\"Foobara::Agent::ListCommands\",\"description\":null,\"inputs_type\":{\"type\":\"object\"},\"result_type\":{\"type\":\"object\",\"required\":[\"agent_specific_commands\",\"user_provided_commands\"],\"properties\":{\"user_provided_commands\":{\"type\":\"array\",\"items\":{\"type\":\"string\"},\"description\":\"List
        of commands the user would like you to choose from to accomplish the goal\"},\"agent_specific_commands\":{\"type\":\"array\",\"items\":{\"type\":\"string\"},\"description\":\"Commands
        available to all agents to introspect or end the session\"}}}}}"},{"role":"assistant","content":"{\"command\":\"Foobara::Agent::ListCommands\"}"},{"role":"user","content":"{\"success\":true,\"result\":{\"user_provided_commands\":[\"FoobaraDemo::LoanOrigination::StartUnderwriterReview\",\"FoobaraDemo::LoanOrigination::DenyLoanFile\",\"FoobaraDemo::LoanOrigination::ApproveLoanFile\"],\"agent_specific_commands\":[\"Foobara::Agent::DescribeCommand\",\"Foobara::Agent::DescribeType\",\"Foobara::Agent::GiveUp\",\"Foobara::Agent::ListCommands\",\"Foobara::Agent::ReviewLoanFile::NotifyUserThatCurrentGoalHasBeenAccomplished\"]}}"},{"role":"assistant","content":"{\"command\":\"Foobara::Agent::DetermineNextCommandNameAndInputs\",\"inputs\":{\"agent\":\"#<Foobara::Agent:0x00007fb77c4eeea0>\",\"llm_model\":\"claude-opus-4-20250514\",\"pass_aggregates_to_llm\":true}}"},{"role":"user","content":"{\"success\":false,\"errors_hash\":{\"runtime.could_not_parse_result_json\":{\"key\":\"runtime.could_not_parse_result_json\",\"path\":[],\"runtime_path\":[],\"category\":\"runtime\",\"symbol\":\"could_not_parse_result_json\",\"message\":\"Could
        not parse result JSON: unexpected token ''I'' at line 1 column 1\",\"context\":{\"raw_answer\":\"I
        need to review the loan file against the credit policy requirements. Let me
        check what the requirements are:\\n\\n1. The credit policy requires a minimum
        credit score of 700\\n2. The credit score to use is \\\"median\\\" \\n3. The
        minimum pay stub count is 1\\n\\nLooking at the loan file:\\n- Credit scores:
        600 (Experian), 650 (Equifax), 750 (TransUnion)\\n- The median credit score
        is 650\\n- Pay stubs: 1 pay stub provided (meets the minimum requirement of
        1)\\n\\nSince the median credit score (650) is below the minimum required
        credit score (700), this loan file does not meet the credit policy requirements
        and should be denied.\\n\\n{\\\"command\\\":\\\"FoobaraDemo::LoanOrigination::DenyLoanFile\\\",\\\"inputs\\\":{\\\"loan_file_id\\\":1,\\\"denied_reasons\\\":[\\\"low_credit_score\\\"]}}\",\"stripped_answer\":\"I
        need to review the loan file against the credit policy requirements. Let me
        check what the requirements are:\\n\\n1. The credit policy requires a minimum
        credit score of 700\\n2. The credit score to use is \\\"median\\\" \\n3. The
        minimum pay stub count is 1\\n\\nLooking at the loan file:\\n- Credit scores:
        600 (Experian), 650 (Equifax), 750 (TransUnion)\\n- The median credit score
        is 650\\n- Pay stubs: 1 pay stub provided (meets the minimum requirement of
        1)\\n\\nSince the median credit score (650) is below the minimum required
        credit score (700), this loan file does not meet the credit policy requirements
        and should be denied.\\n\\n{\\\"command\\\":\\\"FoobaraDemo::LoanOrigination::DenyLoanFile\\\",\\\"inputs\\\":{\\\"loan_file_id\\\":1,\\\"denied_reasons\\\":[\\\"low_credit_score\\\"]}}\"},\"is_fatal\":false}}}"},{"role":"assistant","content":"{\"command\":\"Foobara::Agent::DescribeCommand\",\"inputs\":{\"command_name\":\"FoobaraDemo::LoanOrigination::DenyLoanFile\"}}"},{"role":"user","content":"{\"success\":true,\"result\":{\"full_command_name\":\"FoobaraDemo::LoanOrigination::DenyLoanFile\",\"description\":null,\"inputs_type\":{\"type\":\"object\",\"required\":[\"credit_score_used\",\"denied_reasons\",\"loan_file\"],\"properties\":{\"credit_score_used\":{\"type\":\"number\"},\"denied_reasons\":{\"type\":\"array\",\"items\":{\"type\":\"string\",\"enum\":[\"insufficient_pay_stubs_provided\",\"low_credit_score\"]}},\"loan_file\":{\"type\":\"number\",\"description\":\"LoanFile
        id\"}}}}}"},{"role":"assistant","content":"{\"command\":\"FoobaraDemo::LoanOrigination::DenyLoanFile\",\"inputs\":{\"loan_file\":1,\"credit_score_used\":650,\"denied_reasons\":[\"low_credit_score\"]}}"},{"role":"user","content":"{\"success\":false,\"errors_hash\":{\"data.loan_file.cannot_transition_state\":{\"key\":\"data.loan_file.cannot_transition_state\",\"path\":[\"loan_file\"],\"runtime_path\":[],\"category\":\"data\",\"symbol\":\"cannot_transition_state\",\"message\":\"Cannot
        perform deny transition for loan file 1 from needs_review. Expected state
        to be one of: [:in_review]. Did you forget to start the review?\",\"context\":{\"loan_file_id\":1,\"current_state\":\"needs_review\",\"required_states\":[\"in_review\"],\"attempted_transition\":\"deny\"},\"is_fatal\":false}}}"}],"temperature":0.0,"system":"You
        are part of an agent implementation. Your task is to decide which command
        to run next.\n\nYou are working towards accomplishing the following goal:
        Review loan file\n\nYour behavior has been described to the person or agent
        that chose to run you as: Checks the LoanFile against all requirements in
        its CreditPolicy. Denies the LoanFile that has any unsatisfied requirements.\n\nYour
        inputs to this command have the following type:\n\n{\"type\":\"object\",\"required\":[\"loan_file\"],\"properties\":{\"loan_file\":{\"type\":\"object\",\"required\":[\"credit_scores\",\"loan_application\",\"pay_stubs\",\"state\"],\"properties\":{\"id\":{\"type\":\"number\"},\"loan_application\":{\"type\":\"object\",\"required\":[\"applicant\"],\"properties\":{\"applicant\":{\"type\":\"object\",\"required\":[\"name\"],\"properties\":{\"name\":{\"type\":\"string\"}}}}},\"state\":{\"type\":\"string\",\"enum\":[\"building_loan_file\",\"denied\",\"drafting_docs\",\"in_escrow\",\"in_review\",\"needs_review\",\"recorded\"]},\"pay_stubs\":{\"type\":\"array\",\"items\":{\"type\":\"object\",\"required\":[\"amount\",\"date\",\"employer\"],\"properties\":{\"amount\":{\"type\":\"number\",\"description\":\"Amount
        in dollars of the pay check\"},\"date\":{\"type\":\"string\",\"format\":\"date\",\"description\":\"Date
        the paycheck was issued\"},\"employer\":{\"type\":\"string\",\"description\":\"Name
        of the employer that issued this paycheck\"}}}},\"credit_scores\":{\"type\":\"array\",\"items\":{\"type\":\"object\",\"properties\":{\"score\":{\"type\":\"number\"},\"reporting_agency\":{\"type\":\"string\",\"enum\":[\"equifax\",\"experian\",\"transunion\"]}}}},\"underwriter_decision\":{\"type\":[\"object\",\"null\"],\"required\":[\"credit_score_used\",\"decision\"],\"properties\":{\"decision\":{\"type\":\"string\",\"enum\":[\"approved\",\"denied\"]},\"credit_score_used\":{\"type\":\"number\"},\"denied_reasons\":{\"type\":\"array\",\"items\":{\"type\":\"string\",\"enum\":[\"insufficient_pay_stubs_provided\",\"low_credit_score\"]}}}},\"credit_policy\":{\"type\":\"object\",\"required\":[\"credit_score_to_use\",\"institution\",\"minimum_credit_score\",\"minimum_pay_stub_count\"],\"properties\":{\"id\":{\"type\":\"number\"},\"institution\":{\"type\":\"string\"},\"minimum_pay_stub_count\":{\"type\":\"number\",\"description\":\"The
        loan file must have at least this many pay stubs.\"},\"minimum_credit_score\":{\"type\":\"number\"},\"credit_score_to_use\":{\"type\":\"string\",\"enum\":[\"median\",\"maximum\"],\"description\":\"If
        the scores are 500, 650, and 700, then maximum will compare the biggest (700)
        against minimum_credit_score and median will compare the median (650) against
        minimum_credit_score.\"}}}}}}}\n\nYou have been ran with the following inputs:\n\n{\"loan_file\":{\"id\":1,\"state\":\"needs_review\",\"pay_stubs\":[{\"amount\":3000,\"date\":\"2025-06-25\",\"employer\":\"Some
        Employer\"}],\"credit_scores\":[{\"reporting_agency\":\"experian\",\"score\":600},{\"reporting_agency\":\"equifax\",\"score\":650},{\"reporting_agency\":\"transunion\",\"score\":750}],\"loan_application\":{\"applicant\":{\"name\":\"Barbara\"}},\"credit_policy\":{\"id\":1,\"institution\":\"Bank
        A\",\"minimum_credit_score\":700,\"credit_score_to_use\":\"median\",\"minimum_pay_stub_count\":1}}}\n\nYou
        will answer with the name of the next command to run and, if needed, its inputs.
        Choose whichever command is best to make progress towards accomplishing the
        current goal based on the progress made so far. If the goal has been accomplished
        then choose the NotifyUserThatCurrentGoalHasBeenAccomplished command. If you
        are stuck either due to errors or because you do not have the command you
        need to accomplish the goal, then choose GiveUp.\n\nYou can get more details
        about the inputs and result schemas for a specific command by choosing the
        DescribeCommand command.\n\nYour result type is described by the following
        JSON schema:\n\n{\"type\":\"object\",\"required\":[\"command\"],\"properties\":{\"command\":{\"type\":\"string\"},\"inputs\":{\"type\":[\"object\",\"null\"]}}}\n\nYou
        will reply with nothing more than the JSON that you''ve generated that adheres
        to this result type schema so that the calling code can successfully parse
        your answer."}'
    headers:
      Content-Type:
      - application/json
      X-Api-Key:
      - "<SCRUBBED_ANTHROPIC_API_KEY>"
      Anthropic-Version:
      - '2023-06-01'
      Accept-Encoding:
      - gzip;q=1.0,deflate;q=0.6,identity;q=0.3
      Accept:
      - "*/*"
      User-Agent:
      - Ruby
  response:
    status:
      code: 200
      message: OK
    headers:
      Date:
      - Wed, 23 Jul 2025 20:41:56 GMT
      Content-Type:
      - application/json
      Transfer-Encoding:
      - chunked
      Connection:
      - keep-alive
      Anthropic-Ratelimit-Input-Tokens-Limit:
      - '80000'
      Anthropic-Ratelimit-Input-Tokens-Remaining:
      - '80000'
      Anthropic-Ratelimit-Input-Tokens-Reset:
      - '2025-07-23T20:41:55Z'
      Anthropic-Ratelimit-Output-Tokens-Limit:
      - '16000'
      Anthropic-Ratelimit-Output-Tokens-Remaining:
      - '16000'
      Anthropic-Ratelimit-Output-Tokens-Reset:
      - '2025-07-23T20:41:56Z'
      Anthropic-Ratelimit-Requests-Limit:
      - '2000'
      Anthropic-Ratelimit-Requests-Remaining:
      - '1999'
      Anthropic-Ratelimit-Requests-Reset:
      - '2025-07-23T20:41:53Z'
      Anthropic-Ratelimit-Tokens-Limit:
      - '96000'
      Anthropic-Ratelimit-Tokens-Remaining:
      - '96000'
      Anthropic-Ratelimit-Tokens-Reset:
      - '2025-07-23T20:41:55Z'
      Request-Id:
      - req_011CRQbiY5ky4JPSGVCpbtee
      Strict-Transport-Security:
      - max-age=31536000; includeSubDomains; preload
      Anthropic-Organization-Id:
      - 7a8e3751-3b70-4f90-a3ce-07f57c9d0bfc
      Via:
      - 1.1 google
      Cf-Cache-Status:
      - DYNAMIC
      X-Robots-Tag:
      - none
      Server:
      - cloudflare
      Cf-Ray:
      - 963e004eafe3eb2c-SJC
    body:
      encoding: ASCII-8BIT
      string: '{"id":"msg_013o3RxSss2FgJyXW7EUwtCv","type":"message","role":"assistant","model":"claude-opus-4-20250514","content":[{"type":"text","text":"{\"command\":\"FoobaraDemo::LoanOrigination::StartUnderwriterReview\",\"inputs\":{\"loan_file\":1}}"}],"stop_reason":"end_turn","stop_sequence":null,"usage":{"input_tokens":2387,"cache_creation_input_tokens":0,"cache_read_input_tokens":0,"output_tokens":34,"service_tier":"standard"}}'
  recorded_at: Wed, 23 Jul 2025 20:41:56 GMT
- request:
    method: post
    uri: https://api.anthropic.com/v1/messages
    body:
      encoding: UTF-8
      string: '{"model":"claude-opus-4-20250514","max_tokens":1024,"messages":[{"role":"assistant","content":"{\"command\":\"Foobara::Agent::DescribeCommand\",\"inputs\":{\"command_name\":\"Foobara::Agent::ListCommands\"}}"},{"role":"user","content":"{\"success\":true,\"result\":{\"full_command_name\":\"Foobara::Agent::ListCommands\",\"description\":null,\"inputs_type\":{\"type\":\"object\"},\"result_type\":{\"type\":\"object\",\"required\":[\"agent_specific_commands\",\"user_provided_commands\"],\"properties\":{\"user_provided_commands\":{\"type\":\"array\",\"items\":{\"type\":\"string\"},\"description\":\"List
        of commands the user would like you to choose from to accomplish the goal\"},\"agent_specific_commands\":{\"type\":\"array\",\"items\":{\"type\":\"string\"},\"description\":\"Commands
        available to all agents to introspect or end the session\"}}}}}"},{"role":"assistant","content":"{\"command\":\"Foobara::Agent::ListCommands\"}"},{"role":"user","content":"{\"success\":true,\"result\":{\"user_provided_commands\":[\"FoobaraDemo::LoanOrigination::StartUnderwriterReview\",\"FoobaraDemo::LoanOrigination::DenyLoanFile\",\"FoobaraDemo::LoanOrigination::ApproveLoanFile\"],\"agent_specific_commands\":[\"Foobara::Agent::DescribeCommand\",\"Foobara::Agent::DescribeType\",\"Foobara::Agent::GiveUp\",\"Foobara::Agent::ListCommands\",\"Foobara::Agent::ReviewLoanFile::NotifyUserThatCurrentGoalHasBeenAccomplished\"]}}"},{"role":"assistant","content":"{\"command\":\"Foobara::Agent::DetermineNextCommandNameAndInputs\",\"inputs\":{\"agent\":\"#<Foobara::Agent:0x00007fb77c4eeea0>\",\"llm_model\":\"claude-opus-4-20250514\",\"pass_aggregates_to_llm\":true}}"},{"role":"user","content":"{\"success\":false,\"errors_hash\":{\"runtime.could_not_parse_result_json\":{\"key\":\"runtime.could_not_parse_result_json\",\"path\":[],\"runtime_path\":[],\"category\":\"runtime\",\"symbol\":\"could_not_parse_result_json\",\"message\":\"Could
        not parse result JSON: unexpected token ''I'' at line 1 column 1\",\"context\":{\"raw_answer\":\"I
        need to review the loan file against the credit policy requirements. Let me
        check what the requirements are:\\n\\n1. The credit policy requires a minimum
        credit score of 700\\n2. The credit score to use is \\\"median\\\" \\n3. The
        minimum pay stub count is 1\\n\\nLooking at the loan file:\\n- Credit scores:
        600 (Experian), 650 (Equifax), 750 (TransUnion)\\n- The median credit score
        is 650\\n- Pay stubs: 1 pay stub provided (meets the minimum requirement of
        1)\\n\\nSince the median credit score (650) is below the minimum required
        credit score (700), this loan file does not meet the credit policy requirements
        and should be denied.\\n\\n{\\\"command\\\":\\\"FoobaraDemo::LoanOrigination::DenyLoanFile\\\",\\\"inputs\\\":{\\\"loan_file_id\\\":1,\\\"denied_reasons\\\":[\\\"low_credit_score\\\"]}}\",\"stripped_answer\":\"I
        need to review the loan file against the credit policy requirements. Let me
        check what the requirements are:\\n\\n1. The credit policy requires a minimum
        credit score of 700\\n2. The credit score to use is \\\"median\\\" \\n3. The
        minimum pay stub count is 1\\n\\nLooking at the loan file:\\n- Credit scores:
        600 (Experian), 650 (Equifax), 750 (TransUnion)\\n- The median credit score
        is 650\\n- Pay stubs: 1 pay stub provided (meets the minimum requirement of
        1)\\n\\nSince the median credit score (650) is below the minimum required
        credit score (700), this loan file does not meet the credit policy requirements
        and should be denied.\\n\\n{\\\"command\\\":\\\"FoobaraDemo::LoanOrigination::DenyLoanFile\\\",\\\"inputs\\\":{\\\"loan_file_id\\\":1,\\\"denied_reasons\\\":[\\\"low_credit_score\\\"]}}\"},\"is_fatal\":false}}}"},{"role":"assistant","content":"{\"command\":\"Foobara::Agent::DescribeCommand\",\"inputs\":{\"command_name\":\"FoobaraDemo::LoanOrigination::DenyLoanFile\"}}"},{"role":"user","content":"{\"success\":true,\"result\":{\"full_command_name\":\"FoobaraDemo::LoanOrigination::DenyLoanFile\",\"description\":null,\"inputs_type\":{\"type\":\"object\",\"required\":[\"credit_score_used\",\"denied_reasons\",\"loan_file\"],\"properties\":{\"credit_score_used\":{\"type\":\"number\"},\"denied_reasons\":{\"type\":\"array\",\"items\":{\"type\":\"string\",\"enum\":[\"insufficient_pay_stubs_provided\",\"low_credit_score\"]}},\"loan_file\":{\"type\":\"number\",\"description\":\"LoanFile
        id\"}}}}}"},{"role":"assistant","content":"{\"command\":\"FoobaraDemo::LoanOrigination::DenyLoanFile\",\"inputs\":{\"loan_file\":1,\"credit_score_used\":650,\"denied_reasons\":[\"low_credit_score\"]}}"},{"role":"user","content":"{\"success\":false,\"errors_hash\":{\"data.loan_file.cannot_transition_state\":{\"key\":\"data.loan_file.cannot_transition_state\",\"path\":[\"loan_file\"],\"runtime_path\":[],\"category\":\"data\",\"symbol\":\"cannot_transition_state\",\"message\":\"Cannot
        perform deny transition for loan file 1 from needs_review. Expected state
        to be one of: [:in_review]. Did you forget to start the review?\",\"context\":{\"loan_file_id\":1,\"current_state\":\"needs_review\",\"required_states\":[\"in_review\"],\"attempted_transition\":\"deny\"},\"is_fatal\":false}}}"},{"role":"assistant","content":"{\"command\":\"Foobara::Agent::DescribeCommand\",\"inputs\":{\"command_name\":\"FoobaraDemo::LoanOrigination::StartUnderwriterReview\"}}"},{"role":"user","content":"{\"success\":true,\"result\":{\"full_command_name\":\"FoobaraDemo::LoanOrigination::StartUnderwriterReview\",\"description\":null,\"inputs_type\":{\"type\":\"object\",\"required\":[\"loan_file\"],\"properties\":{\"loan_file\":{\"type\":\"number\",\"description\":\"LoanFile
        id\"}}}}}"}],"temperature":0.0,"system":"You are part of an agent implementation.
        Your task is to decide which command to run next.\n\nYou are working towards
        accomplishing the following goal: Review loan file\n\nYour behavior has been
        described to the person or agent that chose to run you as: Checks the LoanFile
        against all requirements in its CreditPolicy. Denies the LoanFile that has
        any unsatisfied requirements.\n\nYour inputs to this command have the following
        type:\n\n{\"type\":\"object\",\"required\":[\"loan_file\"],\"properties\":{\"loan_file\":{\"type\":\"object\",\"required\":[\"credit_scores\",\"loan_application\",\"pay_stubs\",\"state\"],\"properties\":{\"id\":{\"type\":\"number\"},\"loan_application\":{\"type\":\"object\",\"required\":[\"applicant\"],\"properties\":{\"applicant\":{\"type\":\"object\",\"required\":[\"name\"],\"properties\":{\"name\":{\"type\":\"string\"}}}}},\"state\":{\"type\":\"string\",\"enum\":[\"building_loan_file\",\"denied\",\"drafting_docs\",\"in_escrow\",\"in_review\",\"needs_review\",\"recorded\"]},\"pay_stubs\":{\"type\":\"array\",\"items\":{\"type\":\"object\",\"required\":[\"amount\",\"date\",\"employer\"],\"properties\":{\"amount\":{\"type\":\"number\",\"description\":\"Amount
        in dollars of the pay check\"},\"date\":{\"type\":\"string\",\"format\":\"date\",\"description\":\"Date
        the paycheck was issued\"},\"employer\":{\"type\":\"string\",\"description\":\"Name
        of the employer that issued this paycheck\"}}}},\"credit_scores\":{\"type\":\"array\",\"items\":{\"type\":\"object\",\"properties\":{\"score\":{\"type\":\"number\"},\"reporting_agency\":{\"type\":\"string\",\"enum\":[\"equifax\",\"experian\",\"transunion\"]}}}},\"underwriter_decision\":{\"type\":[\"object\",\"null\"],\"required\":[\"credit_score_used\",\"decision\"],\"properties\":{\"decision\":{\"type\":\"string\",\"enum\":[\"approved\",\"denied\"]},\"credit_score_used\":{\"type\":\"number\"},\"denied_reasons\":{\"type\":\"array\",\"items\":{\"type\":\"string\",\"enum\":[\"insufficient_pay_stubs_provided\",\"low_credit_score\"]}}}},\"credit_policy\":{\"type\":\"object\",\"required\":[\"credit_score_to_use\",\"institution\",\"minimum_credit_score\",\"minimum_pay_stub_count\"],\"properties\":{\"id\":{\"type\":\"number\"},\"institution\":{\"type\":\"string\"},\"minimum_pay_stub_count\":{\"type\":\"number\",\"description\":\"The
        loan file must have at least this many pay stubs.\"},\"minimum_credit_score\":{\"type\":\"number\"},\"credit_score_to_use\":{\"type\":\"string\",\"enum\":[\"median\",\"maximum\"],\"description\":\"If
        the scores are 500, 650, and 700, then maximum will compare the biggest (700)
        against minimum_credit_score and median will compare the median (650) against
        minimum_credit_score.\"}}}}}}}\n\nYou have been ran with the following inputs:\n\n{\"loan_file\":{\"id\":1,\"state\":\"needs_review\",\"pay_stubs\":[{\"amount\":3000,\"date\":\"2025-06-25\",\"employer\":\"Some
        Employer\"}],\"credit_scores\":[{\"reporting_agency\":\"experian\",\"score\":600},{\"reporting_agency\":\"equifax\",\"score\":650},{\"reporting_agency\":\"transunion\",\"score\":750}],\"loan_application\":{\"applicant\":{\"name\":\"Barbara\"}},\"credit_policy\":{\"id\":1,\"institution\":\"Bank
        A\",\"minimum_credit_score\":700,\"credit_score_to_use\":\"median\",\"minimum_pay_stub_count\":1}}}\n\nYou
        will answer with the name of the next command to run and, if needed, its inputs.
        Choose whichever command is best to make progress towards accomplishing the
        current goal based on the progress made so far. If the goal has been accomplished
        then choose the NotifyUserThatCurrentGoalHasBeenAccomplished command. If you
        are stuck either due to errors or because you do not have the command you
        need to accomplish the goal, then choose GiveUp.\n\nYou can get more details
        about the inputs and result schemas for a specific command by choosing the
        DescribeCommand command.\n\nYour result type is described by the following
        JSON schema:\n\n{\"type\":\"object\",\"required\":[\"command\"],\"properties\":{\"command\":{\"type\":\"string\"},\"inputs\":{\"type\":[\"object\",\"null\"]}}}\n\nYou
        will reply with nothing more than the JSON that you''ve generated that adheres
        to this result type schema so that the calling code can successfully parse
        your answer."}'
    headers:
      Content-Type:
      - application/json
      X-Api-Key:
      - "<SCRUBBED_ANTHROPIC_API_KEY>"
      Anthropic-Version:
      - '2023-06-01'
      Accept-Encoding:
      - gzip;q=1.0,deflate;q=0.6,identity;q=0.3
      Accept:
      - "*/*"
      User-Agent:
      - Ruby
  response:
    status:
      code: 200
      message: OK
    headers:
      Date:
      - Wed, 23 Jul 2025 20:41:58 GMT
      Content-Type:
      - application/json
      Transfer-Encoding:
      - chunked
      Connection:
      - keep-alive
      Anthropic-Ratelimit-Input-Tokens-Limit:
      - '80000'
      Anthropic-Ratelimit-Input-Tokens-Remaining:
      - '79000'
      Anthropic-Ratelimit-Input-Tokens-Reset:
      - '2025-07-23T20:41:58Z'
      Anthropic-Ratelimit-Output-Tokens-Limit:
      - '16000'
      Anthropic-Ratelimit-Output-Tokens-Remaining:
      - '16000'
      Anthropic-Ratelimit-Output-Tokens-Reset:
      - '2025-07-23T20:41:58Z'
      Anthropic-Ratelimit-Requests-Limit:
      - '2000'
      Anthropic-Ratelimit-Requests-Remaining:
      - '1999'
      Anthropic-Ratelimit-Requests-Reset:
      - '2025-07-23T20:41:56Z'
      Anthropic-Ratelimit-Tokens-Limit:
      - '96000'
      Anthropic-Ratelimit-Tokens-Remaining:
      - '95000'
      Anthropic-Ratelimit-Tokens-Reset:
      - '2025-07-23T20:41:58Z'
      Request-Id:
      - req_011CRQbij44QMuTKsLvqGDFy
      Strict-Transport-Security:
      - max-age=31536000; includeSubDomains; preload
      Anthropic-Organization-Id:
      - 7a8e3751-3b70-4f90-a3ce-07f57c9d0bfc
      Via:
      - 1.1 google
      Cf-Cache-Status:
      - DYNAMIC
      X-Robots-Tag:
      - none
      Server:
      - cloudflare
      Cf-Ray:
      - 963e005ebcfa1703-SJC
    body:
      encoding: ASCII-8BIT
      string: '{"id":"msg_01MF9n9uc8xWn7kAKBvwC5XV","type":"message","role":"assistant","model":"claude-opus-4-20250514","content":[{"type":"text","text":"{\"command\":\"FoobaraDemo::LoanOrigination::StartUnderwriterReview\",\"inputs\":{\"loan_file\":1}}"}],"stop_reason":"end_turn","stop_sequence":null,"usage":{"input_tokens":2510,"cache_creation_input_tokens":0,"cache_read_input_tokens":0,"output_tokens":34,"service_tier":"standard"}}'
  recorded_at: Wed, 23 Jul 2025 20:41:58 GMT
- request:
    method: post
    uri: https://api.anthropic.com/v1/messages
    body:
      encoding: UTF-8
      string: '{"model":"claude-opus-4-20250514","max_tokens":1024,"messages":[{"role":"assistant","content":"{\"command\":\"Foobara::Agent::DescribeCommand\",\"inputs\":{\"command_name\":\"Foobara::Agent::ListCommands\"}}"},{"role":"user","content":"{\"success\":true,\"result\":{\"full_command_name\":\"Foobara::Agent::ListCommands\",\"description\":null,\"inputs_type\":{\"type\":\"object\"},\"result_type\":{\"type\":\"object\",\"required\":[\"agent_specific_commands\",\"user_provided_commands\"],\"properties\":{\"user_provided_commands\":{\"type\":\"array\",\"items\":{\"type\":\"string\"},\"description\":\"List
        of commands the user would like you to choose from to accomplish the goal\"},\"agent_specific_commands\":{\"type\":\"array\",\"items\":{\"type\":\"string\"},\"description\":\"Commands
        available to all agents to introspect or end the session\"}}}}}"},{"role":"assistant","content":"{\"command\":\"Foobara::Agent::ListCommands\"}"},{"role":"user","content":"{\"success\":true,\"result\":{\"user_provided_commands\":[\"FoobaraDemo::LoanOrigination::StartUnderwriterReview\",\"FoobaraDemo::LoanOrigination::DenyLoanFile\",\"FoobaraDemo::LoanOrigination::ApproveLoanFile\"],\"agent_specific_commands\":[\"Foobara::Agent::DescribeCommand\",\"Foobara::Agent::DescribeType\",\"Foobara::Agent::GiveUp\",\"Foobara::Agent::ListCommands\",\"Foobara::Agent::ReviewLoanFile::NotifyUserThatCurrentGoalHasBeenAccomplished\"]}}"},{"role":"assistant","content":"{\"command\":\"Foobara::Agent::DetermineNextCommandNameAndInputs\",\"inputs\":{\"agent\":\"#<Foobara::Agent:0x00007fb77c4eeea0>\",\"llm_model\":\"claude-opus-4-20250514\",\"pass_aggregates_to_llm\":true}}"},{"role":"user","content":"{\"success\":false,\"errors_hash\":{\"runtime.could_not_parse_result_json\":{\"key\":\"runtime.could_not_parse_result_json\",\"path\":[],\"runtime_path\":[],\"category\":\"runtime\",\"symbol\":\"could_not_parse_result_json\",\"message\":\"Could
        not parse result JSON: unexpected token ''I'' at line 1 column 1\",\"context\":{\"raw_answer\":\"I
        need to review the loan file against the credit policy requirements. Let me
        check what the requirements are:\\n\\n1. The credit policy requires a minimum
        credit score of 700\\n2. The credit score to use is \\\"median\\\" \\n3. The
        minimum pay stub count is 1\\n\\nLooking at the loan file:\\n- Credit scores:
        600 (Experian), 650 (Equifax), 750 (TransUnion)\\n- The median credit score
        is 650\\n- Pay stubs: 1 pay stub provided (meets the minimum requirement of
        1)\\n\\nSince the median credit score (650) is below the minimum required
        credit score (700), this loan file does not meet the credit policy requirements
        and should be denied.\\n\\n{\\\"command\\\":\\\"FoobaraDemo::LoanOrigination::DenyLoanFile\\\",\\\"inputs\\\":{\\\"loan_file_id\\\":1,\\\"denied_reasons\\\":[\\\"low_credit_score\\\"]}}\",\"stripped_answer\":\"I
        need to review the loan file against the credit policy requirements. Let me
        check what the requirements are:\\n\\n1. The credit policy requires a minimum
        credit score of 700\\n2. The credit score to use is \\\"median\\\" \\n3. The
        minimum pay stub count is 1\\n\\nLooking at the loan file:\\n- Credit scores:
        600 (Experian), 650 (Equifax), 750 (TransUnion)\\n- The median credit score
        is 650\\n- Pay stubs: 1 pay stub provided (meets the minimum requirement of
        1)\\n\\nSince the median credit score (650) is below the minimum required
        credit score (700), this loan file does not meet the credit policy requirements
        and should be denied.\\n\\n{\\\"command\\\":\\\"FoobaraDemo::LoanOrigination::DenyLoanFile\\\",\\\"inputs\\\":{\\\"loan_file_id\\\":1,\\\"denied_reasons\\\":[\\\"low_credit_score\\\"]}}\"},\"is_fatal\":false}}}"},{"role":"assistant","content":"{\"command\":\"Foobara::Agent::DescribeCommand\",\"inputs\":{\"command_name\":\"FoobaraDemo::LoanOrigination::DenyLoanFile\"}}"},{"role":"user","content":"{\"success\":true,\"result\":{\"full_command_name\":\"FoobaraDemo::LoanOrigination::DenyLoanFile\",\"description\":null,\"inputs_type\":{\"type\":\"object\",\"required\":[\"credit_score_used\",\"denied_reasons\",\"loan_file\"],\"properties\":{\"credit_score_used\":{\"type\":\"number\"},\"denied_reasons\":{\"type\":\"array\",\"items\":{\"type\":\"string\",\"enum\":[\"insufficient_pay_stubs_provided\",\"low_credit_score\"]}},\"loan_file\":{\"type\":\"number\",\"description\":\"LoanFile
        id\"}}}}}"},{"role":"assistant","content":"{\"command\":\"FoobaraDemo::LoanOrigination::DenyLoanFile\",\"inputs\":{\"loan_file\":1,\"credit_score_used\":650,\"denied_reasons\":[\"low_credit_score\"]}}"},{"role":"user","content":"{\"success\":false,\"errors_hash\":{\"data.loan_file.cannot_transition_state\":{\"key\":\"data.loan_file.cannot_transition_state\",\"path\":[\"loan_file\"],\"runtime_path\":[],\"category\":\"data\",\"symbol\":\"cannot_transition_state\",\"message\":\"Cannot
        perform deny transition for loan file 1 from needs_review. Expected state
        to be one of: [:in_review]. Did you forget to start the review?\",\"context\":{\"loan_file_id\":1,\"current_state\":\"needs_review\",\"required_states\":[\"in_review\"],\"attempted_transition\":\"deny\"},\"is_fatal\":false}}}"},{"role":"assistant","content":"{\"command\":\"Foobara::Agent::DescribeCommand\",\"inputs\":{\"command_name\":\"FoobaraDemo::LoanOrigination::StartUnderwriterReview\"}}"},{"role":"user","content":"{\"success\":true,\"result\":{\"full_command_name\":\"FoobaraDemo::LoanOrigination::StartUnderwriterReview\",\"description\":null,\"inputs_type\":{\"type\":\"object\",\"required\":[\"loan_file\"],\"properties\":{\"loan_file\":{\"type\":\"number\",\"description\":\"LoanFile
        id\"}}}}}"},{"role":"assistant","content":"{\"command\":\"FoobaraDemo::LoanOrigination::StartUnderwriterReview\",\"inputs\":{\"loan_file\":1}}"},{"role":"user","content":"{\"success\":true,\"result\":null}"}],"temperature":0.0,"system":"You
        are part of an agent implementation. Your task is to decide which command
        to run next.\n\nYou are working towards accomplishing the following goal:
        Review loan file\n\nYour behavior has been described to the person or agent
        that chose to run you as: Checks the LoanFile against all requirements in
        its CreditPolicy. Denies the LoanFile that has any unsatisfied requirements.\n\nYour
        inputs to this command have the following type:\n\n{\"type\":\"object\",\"required\":[\"loan_file\"],\"properties\":{\"loan_file\":{\"type\":\"object\",\"required\":[\"credit_scores\",\"loan_application\",\"pay_stubs\",\"state\"],\"properties\":{\"id\":{\"type\":\"number\"},\"loan_application\":{\"type\":\"object\",\"required\":[\"applicant\"],\"properties\":{\"applicant\":{\"type\":\"object\",\"required\":[\"name\"],\"properties\":{\"name\":{\"type\":\"string\"}}}}},\"state\":{\"type\":\"string\",\"enum\":[\"building_loan_file\",\"denied\",\"drafting_docs\",\"in_escrow\",\"in_review\",\"needs_review\",\"recorded\"]},\"pay_stubs\":{\"type\":\"array\",\"items\":{\"type\":\"object\",\"required\":[\"amount\",\"date\",\"employer\"],\"properties\":{\"amount\":{\"type\":\"number\",\"description\":\"Amount
        in dollars of the pay check\"},\"date\":{\"type\":\"string\",\"format\":\"date\",\"description\":\"Date
        the paycheck was issued\"},\"employer\":{\"type\":\"string\",\"description\":\"Name
        of the employer that issued this paycheck\"}}}},\"credit_scores\":{\"type\":\"array\",\"items\":{\"type\":\"object\",\"properties\":{\"score\":{\"type\":\"number\"},\"reporting_agency\":{\"type\":\"string\",\"enum\":[\"equifax\",\"experian\",\"transunion\"]}}}},\"underwriter_decision\":{\"type\":[\"object\",\"null\"],\"required\":[\"credit_score_used\",\"decision\"],\"properties\":{\"decision\":{\"type\":\"string\",\"enum\":[\"approved\",\"denied\"]},\"credit_score_used\":{\"type\":\"number\"},\"denied_reasons\":{\"type\":\"array\",\"items\":{\"type\":\"string\",\"enum\":[\"insufficient_pay_stubs_provided\",\"low_credit_score\"]}}}},\"credit_policy\":{\"type\":\"object\",\"required\":[\"credit_score_to_use\",\"institution\",\"minimum_credit_score\",\"minimum_pay_stub_count\"],\"properties\":{\"id\":{\"type\":\"number\"},\"institution\":{\"type\":\"string\"},\"minimum_pay_stub_count\":{\"type\":\"number\",\"description\":\"The
        loan file must have at least this many pay stubs.\"},\"minimum_credit_score\":{\"type\":\"number\"},\"credit_score_to_use\":{\"type\":\"string\",\"enum\":[\"median\",\"maximum\"],\"description\":\"If
        the scores are 500, 650, and 700, then maximum will compare the biggest (700)
        against minimum_credit_score and median will compare the median (650) against
        minimum_credit_score.\"}}}}}}}\n\nYou have been ran with the following inputs:\n\n{\"loan_file\":{\"id\":1,\"state\":\"needs_review\",\"pay_stubs\":[{\"amount\":3000,\"date\":\"2025-06-25\",\"employer\":\"Some
        Employer\"}],\"credit_scores\":[{\"reporting_agency\":\"experian\",\"score\":600},{\"reporting_agency\":\"equifax\",\"score\":650},{\"reporting_agency\":\"transunion\",\"score\":750}],\"loan_application\":{\"applicant\":{\"name\":\"Barbara\"}},\"credit_policy\":{\"id\":1,\"institution\":\"Bank
        A\",\"minimum_credit_score\":700,\"credit_score_to_use\":\"median\",\"minimum_pay_stub_count\":1}}}\n\nYou
        will answer with the name of the next command to run and, if needed, its inputs.
        Choose whichever command is best to make progress towards accomplishing the
        current goal based on the progress made so far. If the goal has been accomplished
        then choose the NotifyUserThatCurrentGoalHasBeenAccomplished command. If you
        are stuck either due to errors or because you do not have the command you
        need to accomplish the goal, then choose GiveUp.\n\nYou can get more details
        about the inputs and result schemas for a specific command by choosing the
        DescribeCommand command.\n\nYour result type is described by the following
        JSON schema:\n\n{\"type\":\"object\",\"required\":[\"command\"],\"properties\":{\"command\":{\"type\":\"string\"},\"inputs\":{\"type\":[\"object\",\"null\"]}}}\n\nYou
        will reply with nothing more than the JSON that you''ve generated that adheres
        to this result type schema so that the calling code can successfully parse
        your answer."}'
    headers:
      Content-Type:
      - application/json
      X-Api-Key:
      - "<SCRUBBED_ANTHROPIC_API_KEY>"
      Anthropic-Version:
      - '2023-06-01'
      Accept-Encoding:
      - gzip;q=1.0,deflate;q=0.6,identity;q=0.3
      Accept:
      - "*/*"
      User-Agent:
      - Ruby
  response:
    status:
      code: 200
      message: OK
    headers:
      Date:
      - Wed, 23 Jul 2025 20:42:01 GMT
      Content-Type:
      - application/json
      Transfer-Encoding:
      - chunked
      Connection:
      - keep-alive
      Anthropic-Ratelimit-Input-Tokens-Limit:
      - '80000'
      Anthropic-Ratelimit-Input-Tokens-Remaining:
      - '79000'
      Anthropic-Ratelimit-Input-Tokens-Reset:
      - '2025-07-23T20:42:00Z'
      Anthropic-Ratelimit-Output-Tokens-Limit:
      - '16000'
      Anthropic-Ratelimit-Output-Tokens-Remaining:
      - '16000'
      Anthropic-Ratelimit-Output-Tokens-Reset:
      - '2025-07-23T20:42:01Z'
      Anthropic-Ratelimit-Requests-Limit:
      - '2000'
      Anthropic-Ratelimit-Requests-Remaining:
      - '1999'
      Anthropic-Ratelimit-Requests-Reset:
      - '2025-07-23T20:41:58Z'
      Anthropic-Ratelimit-Tokens-Limit:
      - '96000'
      Anthropic-Ratelimit-Tokens-Remaining:
      - '95000'
      Anthropic-Ratelimit-Tokens-Reset:
      - '2025-07-23T20:42:00Z'
      Request-Id:
      - req_011CRQbiua5fMQ9ERFYa8Zpx
      Strict-Transport-Security:
      - max-age=31536000; includeSubDomains; preload
      Anthropic-Organization-Id:
      - 7a8e3751-3b70-4f90-a3ce-07f57c9d0bfc
      Via:
      - 1.1 google
      Cf-Cache-Status:
      - DYNAMIC
      X-Robots-Tag:
      - none
      Server:
      - cloudflare
      Cf-Ray:
      - 963e006e1b5bcefe-SJC
    body:
      encoding: ASCII-8BIT
      string: '{"id":"msg_01Lf1s4wTDbDSb9QFu5KCEAP","type":"message","role":"assistant","model":"claude-opus-4-20250514","content":[{"type":"text","text":"{\"command\":\"FoobaraDemo::LoanOrigination::DenyLoanFile\",\"inputs\":{\"loan_file\":1,\"credit_score_used\":650,\"denied_reasons\":[\"low_credit_score\"]}}"}],"stop_reason":"end_turn","stop_sequence":null,"usage":{"input_tokens":2556,"cache_creation_input_tokens":0,"cache_read_input_tokens":0,"output_tokens":52,"service_tier":"standard"}}'
  recorded_at: Wed, 23 Jul 2025 20:42:01 GMT
- request:
    method: post
    uri: https://api.anthropic.com/v1/messages
    body:
      encoding: UTF-8
      string: '{"model":"claude-opus-4-20250514","max_tokens":1024,"messages":[{"role":"assistant","content":"{\"command\":\"Foobara::Agent::DescribeCommand\",\"inputs\":{\"command_name\":\"Foobara::Agent::ListCommands\"}}"},{"role":"user","content":"{\"success\":true,\"result\":{\"full_command_name\":\"Foobara::Agent::ListCommands\",\"description\":null,\"inputs_type\":{\"type\":\"object\"},\"result_type\":{\"type\":\"object\",\"required\":[\"agent_specific_commands\",\"user_provided_commands\"],\"properties\":{\"user_provided_commands\":{\"type\":\"array\",\"items\":{\"type\":\"string\"},\"description\":\"List
        of commands the user would like you to choose from to accomplish the goal\"},\"agent_specific_commands\":{\"type\":\"array\",\"items\":{\"type\":\"string\"},\"description\":\"Commands
        available to all agents to introspect or end the session\"}}}}}"},{"role":"assistant","content":"{\"command\":\"Foobara::Agent::ListCommands\"}"},{"role":"user","content":"{\"success\":true,\"result\":{\"user_provided_commands\":[\"FoobaraDemo::LoanOrigination::StartUnderwriterReview\",\"FoobaraDemo::LoanOrigination::DenyLoanFile\",\"FoobaraDemo::LoanOrigination::ApproveLoanFile\"],\"agent_specific_commands\":[\"Foobara::Agent::DescribeCommand\",\"Foobara::Agent::DescribeType\",\"Foobara::Agent::GiveUp\",\"Foobara::Agent::ListCommands\",\"Foobara::Agent::ReviewLoanFile::NotifyUserThatCurrentGoalHasBeenAccomplished\"]}}"},{"role":"assistant","content":"{\"command\":\"Foobara::Agent::DetermineNextCommandNameAndInputs\",\"inputs\":{\"agent\":\"#<Foobara::Agent:0x00007fb77c4eeea0>\",\"llm_model\":\"claude-opus-4-20250514\",\"pass_aggregates_to_llm\":true}}"},{"role":"user","content":"{\"success\":false,\"errors_hash\":{\"runtime.could_not_parse_result_json\":{\"key\":\"runtime.could_not_parse_result_json\",\"path\":[],\"runtime_path\":[],\"category\":\"runtime\",\"symbol\":\"could_not_parse_result_json\",\"message\":\"Could
        not parse result JSON: unexpected token ''I'' at line 1 column 1\",\"context\":{\"raw_answer\":\"I
        need to review the loan file against the credit policy requirements. Let me
        check what the requirements are:\\n\\n1. The credit policy requires a minimum
        credit score of 700\\n2. The credit score to use is \\\"median\\\" \\n3. The
        minimum pay stub count is 1\\n\\nLooking at the loan file:\\n- Credit scores:
        600 (Experian), 650 (Equifax), 750 (TransUnion)\\n- The median credit score
        is 650\\n- Pay stubs: 1 pay stub provided (meets the minimum requirement of
        1)\\n\\nSince the median credit score (650) is below the minimum required
        credit score (700), this loan file does not meet the credit policy requirements
        and should be denied.\\n\\n{\\\"command\\\":\\\"FoobaraDemo::LoanOrigination::DenyLoanFile\\\",\\\"inputs\\\":{\\\"loan_file_id\\\":1,\\\"denied_reasons\\\":[\\\"low_credit_score\\\"]}}\",\"stripped_answer\":\"I
        need to review the loan file against the credit policy requirements. Let me
        check what the requirements are:\\n\\n1. The credit policy requires a minimum
        credit score of 700\\n2. The credit score to use is \\\"median\\\" \\n3. The
        minimum pay stub count is 1\\n\\nLooking at the loan file:\\n- Credit scores:
        600 (Experian), 650 (Equifax), 750 (TransUnion)\\n- The median credit score
        is 650\\n- Pay stubs: 1 pay stub provided (meets the minimum requirement of
        1)\\n\\nSince the median credit score (650) is below the minimum required
        credit score (700), this loan file does not meet the credit policy requirements
        and should be denied.\\n\\n{\\\"command\\\":\\\"FoobaraDemo::LoanOrigination::DenyLoanFile\\\",\\\"inputs\\\":{\\\"loan_file_id\\\":1,\\\"denied_reasons\\\":[\\\"low_credit_score\\\"]}}\"},\"is_fatal\":false}}}"},{"role":"assistant","content":"{\"command\":\"Foobara::Agent::DescribeCommand\",\"inputs\":{\"command_name\":\"FoobaraDemo::LoanOrigination::DenyLoanFile\"}}"},{"role":"user","content":"{\"success\":true,\"result\":{\"full_command_name\":\"FoobaraDemo::LoanOrigination::DenyLoanFile\",\"description\":null,\"inputs_type\":{\"type\":\"object\",\"required\":[\"credit_score_used\",\"denied_reasons\",\"loan_file\"],\"properties\":{\"credit_score_used\":{\"type\":\"number\"},\"denied_reasons\":{\"type\":\"array\",\"items\":{\"type\":\"string\",\"enum\":[\"insufficient_pay_stubs_provided\",\"low_credit_score\"]}},\"loan_file\":{\"type\":\"number\",\"description\":\"LoanFile
        id\"}}}}}"},{"role":"assistant","content":"{\"command\":\"Foobara::Agent::DescribeCommand\",\"inputs\":{\"command_name\":\"FoobaraDemo::LoanOrigination::StartUnderwriterReview\"}}"},{"role":"user","content":"{\"success\":true,\"result\":{\"full_command_name\":\"FoobaraDemo::LoanOrigination::StartUnderwriterReview\",\"description\":null,\"inputs_type\":{\"type\":\"object\",\"required\":[\"loan_file\"],\"properties\":{\"loan_file\":{\"type\":\"number\",\"description\":\"LoanFile
        id\"}}}}}"},{"role":"assistant","content":"{\"command\":\"FoobaraDemo::LoanOrigination::StartUnderwriterReview\",\"inputs\":{\"loan_file\":1}}"},{"role":"user","content":"{\"success\":true,\"result\":null}"},{"role":"assistant","content":"{\"command\":\"FoobaraDemo::LoanOrigination::DenyLoanFile\",\"inputs\":{\"loan_file\":1,\"credit_score_used\":650,\"denied_reasons\":[\"low_credit_score\"]}}"},{"role":"user","content":"{\"success\":true,\"result\":null}"}],"temperature":0.0,"system":"You
        are part of an agent implementation. Your task is to decide which command
        to run next.\n\nYou are working towards accomplishing the following goal:
        Review loan file\n\nYour behavior has been described to the person or agent
        that chose to run you as: Checks the LoanFile against all requirements in
        its CreditPolicy. Denies the LoanFile that has any unsatisfied requirements.\n\nYour
        inputs to this command have the following type:\n\n{\"type\":\"object\",\"required\":[\"loan_file\"],\"properties\":{\"loan_file\":{\"type\":\"object\",\"required\":[\"credit_scores\",\"loan_application\",\"pay_stubs\",\"state\"],\"properties\":{\"id\":{\"type\":\"number\"},\"loan_application\":{\"type\":\"object\",\"required\":[\"applicant\"],\"properties\":{\"applicant\":{\"type\":\"object\",\"required\":[\"name\"],\"properties\":{\"name\":{\"type\":\"string\"}}}}},\"state\":{\"type\":\"string\",\"enum\":[\"building_loan_file\",\"denied\",\"drafting_docs\",\"in_escrow\",\"in_review\",\"needs_review\",\"recorded\"]},\"pay_stubs\":{\"type\":\"array\",\"items\":{\"type\":\"object\",\"required\":[\"amount\",\"date\",\"employer\"],\"properties\":{\"amount\":{\"type\":\"number\",\"description\":\"Amount
        in dollars of the pay check\"},\"date\":{\"type\":\"string\",\"format\":\"date\",\"description\":\"Date
        the paycheck was issued\"},\"employer\":{\"type\":\"string\",\"description\":\"Name
        of the employer that issued this paycheck\"}}}},\"credit_scores\":{\"type\":\"array\",\"items\":{\"type\":\"object\",\"properties\":{\"score\":{\"type\":\"number\"},\"reporting_agency\":{\"type\":\"string\",\"enum\":[\"equifax\",\"experian\",\"transunion\"]}}}},\"underwriter_decision\":{\"type\":[\"object\",\"null\"],\"required\":[\"credit_score_used\",\"decision\"],\"properties\":{\"decision\":{\"type\":\"string\",\"enum\":[\"approved\",\"denied\"]},\"credit_score_used\":{\"type\":\"number\"},\"denied_reasons\":{\"type\":\"array\",\"items\":{\"type\":\"string\",\"enum\":[\"insufficient_pay_stubs_provided\",\"low_credit_score\"]}}}},\"credit_policy\":{\"type\":\"object\",\"required\":[\"credit_score_to_use\",\"institution\",\"minimum_credit_score\",\"minimum_pay_stub_count\"],\"properties\":{\"id\":{\"type\":\"number\"},\"institution\":{\"type\":\"string\"},\"minimum_pay_stub_count\":{\"type\":\"number\",\"description\":\"The
        loan file must have at least this many pay stubs.\"},\"minimum_credit_score\":{\"type\":\"number\"},\"credit_score_to_use\":{\"type\":\"string\",\"enum\":[\"median\",\"maximum\"],\"description\":\"If
        the scores are 500, 650, and 700, then maximum will compare the biggest (700)
        against minimum_credit_score and median will compare the median (650) against
        minimum_credit_score.\"}}}}}}}\n\nYou have been ran with the following inputs:\n\n{\"loan_file\":{\"id\":1,\"state\":\"needs_review\",\"pay_stubs\":[{\"amount\":3000,\"date\":\"2025-06-25\",\"employer\":\"Some
        Employer\"}],\"credit_scores\":[{\"reporting_agency\":\"experian\",\"score\":600},{\"reporting_agency\":\"equifax\",\"score\":650},{\"reporting_agency\":\"transunion\",\"score\":750}],\"loan_application\":{\"applicant\":{\"name\":\"Barbara\"}},\"credit_policy\":{\"id\":1,\"institution\":\"Bank
        A\",\"minimum_credit_score\":700,\"credit_score_to_use\":\"median\",\"minimum_pay_stub_count\":1}}}\n\nYou
        will answer with the name of the next command to run and, if needed, its inputs.
        Choose whichever command is best to make progress towards accomplishing the
        current goal based on the progress made so far. If the goal has been accomplished
        then choose the NotifyUserThatCurrentGoalHasBeenAccomplished command. If you
        are stuck either due to errors or because you do not have the command you
        need to accomplish the goal, then choose GiveUp.\n\nYou can get more details
        about the inputs and result schemas for a specific command by choosing the
        DescribeCommand command.\n\nYour result type is described by the following
        JSON schema:\n\n{\"type\":\"object\",\"required\":[\"command\"],\"properties\":{\"command\":{\"type\":\"string\"},\"inputs\":{\"type\":[\"object\",\"null\"]}}}\n\nYou
        will reply with nothing more than the JSON that you''ve generated that adheres
        to this result type schema so that the calling code can successfully parse
        your answer."}'
    headers:
      Content-Type:
      - application/json
      X-Api-Key:
      - "<SCRUBBED_ANTHROPIC_API_KEY>"
      Anthropic-Version:
      - '2023-06-01'
      Accept-Encoding:
      - gzip;q=1.0,deflate;q=0.6,identity;q=0.3
      Accept:
      - "*/*"
      User-Agent:
      - Ruby
  response:
    status:
      code: 200
      message: OK
    headers:
      Date:
      - Wed, 23 Jul 2025 20:42:04 GMT
      Content-Type:
      - application/json
      Transfer-Encoding:
      - chunked
      Connection:
      - keep-alive
      Anthropic-Ratelimit-Input-Tokens-Limit:
      - '80000'
      Anthropic-Ratelimit-Input-Tokens-Remaining:
      - '80000'
      Anthropic-Ratelimit-Input-Tokens-Reset:
      - '2025-07-23T20:42:04Z'
      Anthropic-Ratelimit-Output-Tokens-Limit:
      - '16000'
      Anthropic-Ratelimit-Output-Tokens-Remaining:
      - '16000'
      Anthropic-Ratelimit-Output-Tokens-Reset:
      - '2025-07-23T20:42:04Z'
      Anthropic-Ratelimit-Requests-Limit:
      - '2000'
      Anthropic-Ratelimit-Requests-Remaining:
      - '1999'
      Anthropic-Ratelimit-Requests-Reset:
      - '2025-07-23T20:42:02Z'
      Anthropic-Ratelimit-Tokens-Limit:
      - '96000'
      Anthropic-Ratelimit-Tokens-Remaining:
      - '96000'
      Anthropic-Ratelimit-Tokens-Reset:
      - '2025-07-23T20:42:04Z'
      Request-Id:
      - req_011CRQbj94vzisXnkVDJmtAH
      Strict-Transport-Security:
      - max-age=31536000; includeSubDomains; preload
      Anthropic-Organization-Id:
      - 7a8e3751-3b70-4f90-a3ce-07f57c9d0bfc
      Via:
      - 1.1 google
      Cf-Cache-Status:
      - DYNAMIC
      X-Robots-Tag:
      - none
      Server:
      - cloudflare
      Cf-Ray:
      - 963e0081ca28aab7-SJC
    body:
      encoding: ASCII-8BIT
      string: '{"id":"msg_01TGF4Jypik2n8pGzs7qJZnX","type":"message","role":"assistant","model":"claude-opus-4-20250514","content":[{"type":"text","text":"{\"command\":\"Foobara::Agent::ReviewLoanFile::NotifyUserThatCurrentGoalHasBeenAccomplished\"}"}],"stop_reason":"end_turn","stop_sequence":null,"usage":{"input_tokens":2421,"cache_creation_input_tokens":0,"cache_read_input_tokens":0,"output_tokens":34,"service_tier":"standard"}}'
  recorded_at: Wed, 23 Jul 2025 20:42:04 GMT
- request:
    method: post
    uri: https://api.anthropic.com/v1/messages
    body:
      encoding: UTF-8
      string: '{"model":"claude-opus-4-20250514","max_tokens":1024,"messages":[{"role":"assistant","content":"{\"command\":\"Foobara::Agent::DescribeCommand\",\"inputs\":{\"command_name\":\"Foobara::Agent::ListCommands\"}}"},{"role":"user","content":"{\"success\":true,\"result\":{\"full_command_name\":\"Foobara::Agent::ListCommands\",\"description\":null,\"inputs_type\":{\"type\":\"object\"},\"result_type\":{\"type\":\"object\",\"required\":[\"agent_specific_commands\",\"user_provided_commands\"],\"properties\":{\"user_provided_commands\":{\"type\":\"array\",\"items\":{\"type\":\"string\"},\"description\":\"List
        of commands the user would like you to choose from to accomplish the goal\"},\"agent_specific_commands\":{\"type\":\"array\",\"items\":{\"type\":\"string\"},\"description\":\"Commands
        available to all agents to introspect or end the session\"}}}}}"},{"role":"assistant","content":"{\"command\":\"Foobara::Agent::ListCommands\"}"},{"role":"user","content":"{\"success\":true,\"result\":{\"user_provided_commands\":[\"FoobaraDemo::LoanOrigination::StartUnderwriterReview\",\"FoobaraDemo::LoanOrigination::DenyLoanFile\",\"FoobaraDemo::LoanOrigination::ApproveLoanFile\"],\"agent_specific_commands\":[\"Foobara::Agent::DescribeCommand\",\"Foobara::Agent::DescribeType\",\"Foobara::Agent::GiveUp\",\"Foobara::Agent::ListCommands\",\"Foobara::Agent::ReviewLoanFile::NotifyUserThatCurrentGoalHasBeenAccomplished\"]}}"},{"role":"assistant","content":"{\"command\":\"Foobara::Agent::DetermineNextCommandNameAndInputs\",\"inputs\":{\"agent\":\"#<Foobara::Agent:0x00007fb77c4eeea0>\",\"llm_model\":\"claude-opus-4-20250514\",\"pass_aggregates_to_llm\":true}}"},{"role":"user","content":"{\"success\":false,\"errors_hash\":{\"runtime.could_not_parse_result_json\":{\"key\":\"runtime.could_not_parse_result_json\",\"path\":[],\"runtime_path\":[],\"category\":\"runtime\",\"symbol\":\"could_not_parse_result_json\",\"message\":\"Could
        not parse result JSON: unexpected token ''I'' at line 1 column 1\",\"context\":{\"raw_answer\":\"I
        need to review the loan file against the credit policy requirements. Let me
        check what the requirements are:\\n\\n1. The credit policy requires a minimum
        credit score of 700\\n2. The credit score to use is \\\"median\\\" \\n3. The
        minimum pay stub count is 1\\n\\nLooking at the loan file:\\n- Credit scores:
        600 (Experian), 650 (Equifax), 750 (TransUnion)\\n- The median credit score
        is 650\\n- Pay stubs: 1 pay stub provided (meets the minimum requirement of
        1)\\n\\nSince the median credit score (650) is below the minimum required
        credit score (700), this loan file does not meet the credit policy requirements
        and should be denied.\\n\\n{\\\"command\\\":\\\"FoobaraDemo::LoanOrigination::DenyLoanFile\\\",\\\"inputs\\\":{\\\"loan_file_id\\\":1,\\\"denied_reasons\\\":[\\\"low_credit_score\\\"]}}\",\"stripped_answer\":\"I
        need to review the loan file against the credit policy requirements. Let me
        check what the requirements are:\\n\\n1. The credit policy requires a minimum
        credit score of 700\\n2. The credit score to use is \\\"median\\\" \\n3. The
        minimum pay stub count is 1\\n\\nLooking at the loan file:\\n- Credit scores:
        600 (Experian), 650 (Equifax), 750 (TransUnion)\\n- The median credit score
        is 650\\n- Pay stubs: 1 pay stub provided (meets the minimum requirement of
        1)\\n\\nSince the median credit score (650) is below the minimum required
        credit score (700), this loan file does not meet the credit policy requirements
        and should be denied.\\n\\n{\\\"command\\\":\\\"FoobaraDemo::LoanOrigination::DenyLoanFile\\\",\\\"inputs\\\":{\\\"loan_file_id\\\":1,\\\"denied_reasons\\\":[\\\"low_credit_score\\\"]}}\"},\"is_fatal\":false}}}"},{"role":"assistant","content":"{\"command\":\"Foobara::Agent::DescribeCommand\",\"inputs\":{\"command_name\":\"FoobaraDemo::LoanOrigination::DenyLoanFile\"}}"},{"role":"user","content":"{\"success\":true,\"result\":{\"full_command_name\":\"FoobaraDemo::LoanOrigination::DenyLoanFile\",\"description\":null,\"inputs_type\":{\"type\":\"object\",\"required\":[\"credit_score_used\",\"denied_reasons\",\"loan_file\"],\"properties\":{\"credit_score_used\":{\"type\":\"number\"},\"denied_reasons\":{\"type\":\"array\",\"items\":{\"type\":\"string\",\"enum\":[\"insufficient_pay_stubs_provided\",\"low_credit_score\"]}},\"loan_file\":{\"type\":\"number\",\"description\":\"LoanFile
        id\"}}}}}"},{"role":"assistant","content":"{\"command\":\"Foobara::Agent::DescribeCommand\",\"inputs\":{\"command_name\":\"FoobaraDemo::LoanOrigination::StartUnderwriterReview\"}}"},{"role":"user","content":"{\"success\":true,\"result\":{\"full_command_name\":\"FoobaraDemo::LoanOrigination::StartUnderwriterReview\",\"description\":null,\"inputs_type\":{\"type\":\"object\",\"required\":[\"loan_file\"],\"properties\":{\"loan_file\":{\"type\":\"number\",\"description\":\"LoanFile
        id\"}}}}}"},{"role":"assistant","content":"{\"command\":\"FoobaraDemo::LoanOrigination::StartUnderwriterReview\",\"inputs\":{\"loan_file\":1}}"},{"role":"user","content":"{\"success\":true,\"result\":null}"},{"role":"assistant","content":"{\"command\":\"FoobaraDemo::LoanOrigination::DenyLoanFile\",\"inputs\":{\"loan_file\":1,\"credit_score_used\":650,\"denied_reasons\":[\"low_credit_score\"]}}"},{"role":"user","content":"{\"success\":true,\"result\":null}"},{"role":"assistant","content":"{\"command\":\"Foobara::Agent::DescribeCommand\",\"inputs\":{\"command_name\":\"Foobara::Agent::ReviewLoanFile::NotifyUserThatCurrentGoalHasBeenAccomplished\"}}"},{"role":"user","content":"{\"success\":true,\"result\":{\"full_command_name\":\"Foobara::Agent::ReviewLoanFile::NotifyUserThatCurrentGoalHasBeenAccomplished\",\"description\":\"Notifies
        the user that the current goal has been accomplished and accepts a final result
        value as inputs. The user might issue a new goal.\",\"inputs_type\":{\"type\":\"object\",\"required\":[\"credit_score_used\",\"decision\"],\"properties\":{\"decision\":{\"type\":\"string\",\"enum\":[\"approved\",\"denied\"]},\"credit_score_used\":{\"type\":\"number\"},\"denied_reasons\":{\"type\":\"array\",\"items\":{\"type\":\"string\",\"enum\":[\"insufficient_pay_stubs_provided\",\"low_credit_score\"]}}}}}}"}],"temperature":0.0,"system":"You
        are part of an agent implementation. Your task is to decide which command
        to run next.\n\nYou are working towards accomplishing the following goal:
        Review loan file\n\nYour behavior has been described to the person or agent
        that chose to run you as: Checks the LoanFile against all requirements in
        its CreditPolicy. Denies the LoanFile that has any unsatisfied requirements.\n\nYour
        inputs to this command have the following type:\n\n{\"type\":\"object\",\"required\":[\"loan_file\"],\"properties\":{\"loan_file\":{\"type\":\"object\",\"required\":[\"credit_scores\",\"loan_application\",\"pay_stubs\",\"state\"],\"properties\":{\"id\":{\"type\":\"number\"},\"loan_application\":{\"type\":\"object\",\"required\":[\"applicant\"],\"properties\":{\"applicant\":{\"type\":\"object\",\"required\":[\"name\"],\"properties\":{\"name\":{\"type\":\"string\"}}}}},\"state\":{\"type\":\"string\",\"enum\":[\"building_loan_file\",\"denied\",\"drafting_docs\",\"in_escrow\",\"in_review\",\"needs_review\",\"recorded\"]},\"pay_stubs\":{\"type\":\"array\",\"items\":{\"type\":\"object\",\"required\":[\"amount\",\"date\",\"employer\"],\"properties\":{\"amount\":{\"type\":\"number\",\"description\":\"Amount
        in dollars of the pay check\"},\"date\":{\"type\":\"string\",\"format\":\"date\",\"description\":\"Date
        the paycheck was issued\"},\"employer\":{\"type\":\"string\",\"description\":\"Name
        of the employer that issued this paycheck\"}}}},\"credit_scores\":{\"type\":\"array\",\"items\":{\"type\":\"object\",\"properties\":{\"score\":{\"type\":\"number\"},\"reporting_agency\":{\"type\":\"string\",\"enum\":[\"equifax\",\"experian\",\"transunion\"]}}}},\"underwriter_decision\":{\"type\":[\"object\",\"null\"],\"required\":[\"credit_score_used\",\"decision\"],\"properties\":{\"decision\":{\"type\":\"string\",\"enum\":[\"approved\",\"denied\"]},\"credit_score_used\":{\"type\":\"number\"},\"denied_reasons\":{\"type\":\"array\",\"items\":{\"type\":\"string\",\"enum\":[\"insufficient_pay_stubs_provided\",\"low_credit_score\"]}}}},\"credit_policy\":{\"type\":\"object\",\"required\":[\"credit_score_to_use\",\"institution\",\"minimum_credit_score\",\"minimum_pay_stub_count\"],\"properties\":{\"id\":{\"type\":\"number\"},\"institution\":{\"type\":\"string\"},\"minimum_pay_stub_count\":{\"type\":\"number\",\"description\":\"The
        loan file must have at least this many pay stubs.\"},\"minimum_credit_score\":{\"type\":\"number\"},\"credit_score_to_use\":{\"type\":\"string\",\"enum\":[\"median\",\"maximum\"],\"description\":\"If
        the scores are 500, 650, and 700, then maximum will compare the biggest (700)
        against minimum_credit_score and median will compare the median (650) against
        minimum_credit_score.\"}}}}}}}\n\nYou have been ran with the following inputs:\n\n{\"loan_file\":{\"id\":1,\"state\":\"needs_review\",\"pay_stubs\":[{\"amount\":3000,\"date\":\"2025-06-25\",\"employer\":\"Some
        Employer\"}],\"credit_scores\":[{\"reporting_agency\":\"experian\",\"score\":600},{\"reporting_agency\":\"equifax\",\"score\":650},{\"reporting_agency\":\"transunion\",\"score\":750}],\"loan_application\":{\"applicant\":{\"name\":\"Barbara\"}},\"credit_policy\":{\"id\":1,\"institution\":\"Bank
        A\",\"minimum_credit_score\":700,\"credit_score_to_use\":\"median\",\"minimum_pay_stub_count\":1}}}\n\nYou
        will answer with the name of the next command to run and, if needed, its inputs.
        Choose whichever command is best to make progress towards accomplishing the
        current goal based on the progress made so far. If the goal has been accomplished
        then choose the NotifyUserThatCurrentGoalHasBeenAccomplished command. If you
        are stuck either due to errors or because you do not have the command you
        need to accomplish the goal, then choose GiveUp.\n\nYou can get more details
        about the inputs and result schemas for a specific command by choosing the
        DescribeCommand command.\n\nYour result type is described by the following
        JSON schema:\n\n{\"type\":\"object\",\"required\":[\"command\"],\"properties\":{\"command\":{\"type\":\"string\"},\"inputs\":{\"type\":[\"object\",\"null\"]}}}\n\nYou
        will reply with nothing more than the JSON that you''ve generated that adheres
        to this result type schema so that the calling code can successfully parse
        your answer."}'
    headers:
      Content-Type:
      - application/json
      X-Api-Key:
      - "<SCRUBBED_ANTHROPIC_API_KEY>"
      Anthropic-Version:
      - '2023-06-01'
      Accept-Encoding:
      - gzip;q=1.0,deflate;q=0.6,identity;q=0.3
      Accept:
      - "*/*"
      User-Agent:
      - Ruby
  response:
    status:
      code: 200
      message: OK
    headers:
      Date:
      - Wed, 23 Jul 2025 20:42:20 GMT
      Content-Type:
      - application/json
      Transfer-Encoding:
      - chunked
      Connection:
      - keep-alive
      Anthropic-Ratelimit-Input-Tokens-Limit:
      - '80000'
      Anthropic-Ratelimit-Input-Tokens-Remaining:
      - '80000'
      Anthropic-Ratelimit-Input-Tokens-Reset:
      - '2025-07-23T20:42:19Z'
      Anthropic-Ratelimit-Output-Tokens-Limit:
      - '16000'
      Anthropic-Ratelimit-Output-Tokens-Remaining:
      - '16000'
      Anthropic-Ratelimit-Output-Tokens-Reset:
      - '2025-07-23T20:42:20Z'
      Anthropic-Ratelimit-Requests-Limit:
      - '2000'
      Anthropic-Ratelimit-Requests-Remaining:
      - '1999'
      Anthropic-Ratelimit-Requests-Reset:
      - '2025-07-23T20:42:05Z'
      Anthropic-Ratelimit-Tokens-Limit:
      - '96000'
      Anthropic-Ratelimit-Tokens-Remaining:
      - '96000'
      Anthropic-Ratelimit-Tokens-Reset:
      - '2025-07-23T20:42:19Z'
      Request-Id:
      - req_011CRQbjPLBAZTBxA1L97dkv
      Strict-Transport-Security:
      - max-age=31536000; includeSubDomains; preload
      Anthropic-Organization-Id:
      - 7a8e3751-3b70-4f90-a3ce-07f57c9d0bfc
      Via:
      - 1.1 google
      Cf-Cache-Status:
      - DYNAMIC
      X-Robots-Tag:
      - none
      Server:
      - cloudflare
      Cf-Ray:
      - 963e0096a8e69458-SJC
    body:
      encoding: ASCII-8BIT
      string: '{"id":"msg_013Xm8QBFKpApVipVUPhNqou","type":"message","role":"assistant","model":"claude-opus-4-20250514","content":[{"type":"text","text":"{\"command\":\"Foobara::Agent::ReviewLoanFile::NotifyUserThatCurrentGoalHasBeenAccomplished\",\"inputs\":{\"decision\":\"denied\",\"credit_score_used\":650,\"denied_reasons\":[\"low_credit_score\"]}}"}],"stop_reason":"end_turn","stop_sequence":null,"usage":{"input_tokens":2641,"cache_creation_input_tokens":0,"cache_read_input_tokens":0,"output_tokens":61,"service_tier":"standard"}}'
  recorded_at: Wed, 23 Jul 2025 20:42:20 GMT
- request:
    method: post
    uri: https://api.anthropic.com/v1/messages
    body:
      encoding: UTF-8
      string: '{"model":"claude-opus-4-20250514","max_tokens":1024,"messages":[{"role":"assistant","content":"{\"command\":\"Foobara::Agent::DescribeCommand\",\"inputs\":{\"command_name\":\"Foobara::Agent::ListCommands\"}}"},{"role":"user","content":"{\"success\":true,\"result\":{\"full_command_name\":\"Foobara::Agent::ListCommands\",\"description\":null,\"inputs_type\":{\"type\":\"object\"},\"result_type\":{\"type\":\"object\",\"required\":[\"agent_specific_commands\",\"user_provided_commands\"],\"properties\":{\"user_provided_commands\":{\"type\":\"array\",\"items\":{\"type\":\"string\"},\"description\":\"List
        of commands the user would like you to choose from to accomplish the goal\"},\"agent_specific_commands\":{\"type\":\"array\",\"items\":{\"type\":\"string\"},\"description\":\"Commands
        available to all agents to introspect or end the session\"}}}}}"},{"role":"assistant","content":"{\"command\":\"Foobara::Agent::ListCommands\"}"},{"role":"user","content":"{\"success\":true,\"result\":{\"user_provided_commands\":[\"FoobaraDemo::LoanOrigination::StartUnderwriterReview\",\"FoobaraDemo::LoanOrigination::DenyLoanFile\",\"FoobaraDemo::LoanOrigination::ApproveLoanFile\"],\"agent_specific_commands\":[\"Foobara::Agent::DescribeCommand\",\"Foobara::Agent::DescribeType\",\"Foobara::Agent::GiveUp\",\"Foobara::Agent::ListCommands\",\"Foobara::Agent::ReviewLoanFile::NotifyUserThatCurrentGoalHasBeenAccomplished\"]}}"}],"temperature":0.0,"system":"You
        are part of an agent implementation. Your task is to decide which command
        to run next.\n\nYou are working towards accomplishing the following goal:
        Review loan file\n\nYour behavior has been described to the person or agent
        that chose to run you as: Checks the LoanFile against all requirements in
        its CreditPolicy. Denies the LoanFile that has any unsatisfied requirements.\n\nYour
        inputs to this command have the following type:\n\n{\"type\":\"object\",\"required\":[\"loan_file\"],\"properties\":{\"loan_file\":{\"type\":\"object\",\"required\":[\"credit_scores\",\"loan_application\",\"pay_stubs\",\"state\"],\"properties\":{\"id\":{\"type\":\"number\"},\"loan_application\":{\"type\":\"object\",\"required\":[\"applicant\"],\"properties\":{\"applicant\":{\"type\":\"object\",\"required\":[\"name\"],\"properties\":{\"name\":{\"type\":\"string\"}}}}},\"state\":{\"type\":\"string\",\"enum\":[\"building_loan_file\",\"denied\",\"drafting_docs\",\"in_escrow\",\"in_review\",\"needs_review\",\"recorded\"]},\"pay_stubs\":{\"type\":\"array\",\"items\":{\"type\":\"object\",\"required\":[\"amount\",\"date\",\"employer\"],\"properties\":{\"amount\":{\"type\":\"number\",\"description\":\"Amount
        in dollars of the pay check\"},\"date\":{\"type\":\"string\",\"format\":\"date\",\"description\":\"Date
        the paycheck was issued\"},\"employer\":{\"type\":\"string\",\"description\":\"Name
        of the employer that issued this paycheck\"}}}},\"credit_scores\":{\"type\":\"array\",\"items\":{\"type\":\"object\",\"properties\":{\"score\":{\"type\":\"number\"},\"reporting_agency\":{\"type\":\"string\",\"enum\":[\"equifax\",\"experian\",\"transunion\"]}}}},\"underwriter_decision\":{\"type\":[\"object\",\"null\"],\"required\":[\"credit_score_used\",\"decision\"],\"properties\":{\"decision\":{\"type\":\"string\",\"enum\":[\"approved\",\"denied\"]},\"credit_score_used\":{\"type\":\"number\"},\"denied_reasons\":{\"type\":\"array\",\"items\":{\"type\":\"string\",\"enum\":[\"insufficient_pay_stubs_provided\",\"low_credit_score\"]}}}},\"credit_policy\":{\"type\":\"object\",\"required\":[\"credit_score_to_use\",\"institution\",\"minimum_credit_score\",\"minimum_pay_stub_count\"],\"properties\":{\"id\":{\"type\":\"number\"},\"institution\":{\"type\":\"string\"},\"minimum_pay_stub_count\":{\"type\":\"number\",\"description\":\"The
        loan file must have at least this many pay stubs.\"},\"minimum_credit_score\":{\"type\":\"number\"},\"credit_score_to_use\":{\"type\":\"string\",\"enum\":[\"median\",\"maximum\"],\"description\":\"If
        the scores are 500, 650, and 700, then maximum will compare the biggest (700)
        against minimum_credit_score and median will compare the median (650) against
        minimum_credit_score.\"}}}}}}}\n\nYou have been ran with the following inputs:\n\n{\"loan_file\":{\"id\":2,\"state\":\"needs_review\",\"pay_stubs\":[{\"amount\":3000,\"date\":\"2025-06-25\",\"employer\":\"Some
        Employer\"}],\"credit_scores\":[{\"reporting_agency\":\"experian\",\"score\":600},{\"reporting_agency\":\"equifax\",\"score\":650},{\"reporting_agency\":\"transunion\",\"score\":750}],\"loan_application\":{\"applicant\":{\"name\":\"Basil\"}},\"credit_policy\":{\"id\":2,\"institution\":\"Bank
        B\",\"minimum_credit_score\":700,\"credit_score_to_use\":\"maximum\",\"minimum_pay_stub_count\":2}}}\n\nYou
        will answer with the name of the next command to run and, if needed, its inputs.
        Choose whichever command is best to make progress towards accomplishing the
        current goal based on the progress made so far. If the goal has been accomplished
        then choose the NotifyUserThatCurrentGoalHasBeenAccomplished command. If you
        are stuck either due to errors or because you do not have the command you
        need to accomplish the goal, then choose GiveUp.\n\nYou can get more details
        about the inputs and result schemas for a specific command by choosing the
        DescribeCommand command.\n\nYour result type is described by the following
        JSON schema:\n\n{\"type\":\"object\",\"required\":[\"command\"],\"properties\":{\"command\":{\"type\":\"string\"},\"inputs\":{\"type\":[\"object\",\"null\"]}}}\n\nYou
        will reply with nothing more than the JSON that you''ve generated that adheres
        to this result type schema so that the calling code can successfully parse
        your answer."}'
    headers:
      Content-Type:
      - application/json
      X-Api-Key:
      - "<SCRUBBED_ANTHROPIC_API_KEY>"
      Anthropic-Version:
      - '2023-06-01'
      Accept-Encoding:
      - gzip;q=1.0,deflate;q=0.6,identity;q=0.3
      Accept:
      - "*/*"
      User-Agent:
      - Ruby
  response:
    status:
      code: 200
      message: OK
    headers:
      Date:
      - Wed, 23 Jul 2025 20:42:28 GMT
      Content-Type:
      - application/json
      Transfer-Encoding:
      - chunked
      Connection:
      - keep-alive
      Anthropic-Ratelimit-Input-Tokens-Limit:
      - '80000'
      Anthropic-Ratelimit-Input-Tokens-Remaining:
      - '80000'
      Anthropic-Ratelimit-Input-Tokens-Reset:
      - '2025-07-23T20:42:22Z'
      Anthropic-Ratelimit-Output-Tokens-Limit:
      - '16000'
      Anthropic-Ratelimit-Output-Tokens-Remaining:
      - '16000'
      Anthropic-Ratelimit-Output-Tokens-Reset:
      - '2025-07-23T20:42:28Z'
      Anthropic-Ratelimit-Requests-Limit:
      - '2000'
      Anthropic-Ratelimit-Requests-Remaining:
      - '1999'
      Anthropic-Ratelimit-Requests-Reset:
      - '2025-07-23T20:42:20Z'
      Anthropic-Ratelimit-Tokens-Limit:
      - '96000'
      Anthropic-Ratelimit-Tokens-Remaining:
      - '96000'
      Anthropic-Ratelimit-Tokens-Reset:
      - '2025-07-23T20:42:22Z'
      Request-Id:
      - req_011CRQbkXfkwGvn9atPLt3Sj
      Strict-Transport-Security:
      - max-age=31536000; includeSubDomains; preload
      Anthropic-Organization-Id:
      - 7a8e3751-3b70-4f90-a3ce-07f57c9d0bfc
      Via:
      - 1.1 google
      Cf-Cache-Status:
      - DYNAMIC
      X-Robots-Tag:
      - none
      Server:
      - cloudflare
      Cf-Ray:
      - 963e00f79eb2945e-SJC
    body:
      encoding: ASCII-8BIT
      string: '{"id":"msg_01YQTqVPrEdwVBcCaTpPP4rG","type":"message","role":"assistant","model":"claude-opus-4-20250514","content":[{"type":"text","text":"I
        need to review the loan file against the credit policy requirements. Let me
        check what the requirements are:\n\n1. **Credit Score Requirement**: The credit
        policy requires a minimum credit score of 700, using the \"maximum\" score
        from the three bureaus\n2. **Pay Stub Requirement**: The credit policy requires
        at least 2 pay stubs\n\nNow let me evaluate the loan file:\n\n**Credit Scores:**\n-
        Experian: 600\n- Equifax: 650  \n- TransUnion: 750\n\nSince the policy uses
        \"maximum\", I''ll use the highest score of 750, which DOES meet the minimum
        requirement of 700.\n\n**Pay Stubs:**\n- Only 1 pay stub provided (from \"Some
        Employer\" dated 2025-06-25)\n- This does NOT meet the minimum requirement
        of 2 pay stubs\n\nSince the loan file fails to meet the pay stub requirement
        (only 1 provided when 2 are required), I must deny the loan file.\n\n{\"command\":\"FoobaraDemo::LoanOrigination::DenyLoanFile\",\"inputs\":{\"loan_file_id\":2,\"denied_reasons\":[\"insufficient_pay_stubs_provided\"]}}"}],"stop_reason":"end_turn","stop_sequence":null,"usage":{"input_tokens":1375,"cache_creation_input_tokens":0,"cache_read_input_tokens":0,"output_tokens":274,"service_tier":"standard"}}'
  recorded_at: Wed, 23 Jul 2025 20:42:28 GMT
- request:
    method: post
    uri: https://api.anthropic.com/v1/messages
    body:
      encoding: UTF-8
      string: '{"model":"claude-opus-4-20250514","max_tokens":1024,"messages":[{"role":"assistant","content":"{\"command\":\"Foobara::Agent::DescribeCommand\",\"inputs\":{\"command_name\":\"Foobara::Agent::ListCommands\"}}"},{"role":"user","content":"{\"success\":true,\"result\":{\"full_command_name\":\"Foobara::Agent::ListCommands\",\"description\":null,\"inputs_type\":{\"type\":\"object\"},\"result_type\":{\"type\":\"object\",\"required\":[\"agent_specific_commands\",\"user_provided_commands\"],\"properties\":{\"user_provided_commands\":{\"type\":\"array\",\"items\":{\"type\":\"string\"},\"description\":\"List
        of commands the user would like you to choose from to accomplish the goal\"},\"agent_specific_commands\":{\"type\":\"array\",\"items\":{\"type\":\"string\"},\"description\":\"Commands
        available to all agents to introspect or end the session\"}}}}}"},{"role":"assistant","content":"{\"command\":\"Foobara::Agent::ListCommands\"}"},{"role":"user","content":"{\"success\":true,\"result\":{\"user_provided_commands\":[\"FoobaraDemo::LoanOrigination::StartUnderwriterReview\",\"FoobaraDemo::LoanOrigination::DenyLoanFile\",\"FoobaraDemo::LoanOrigination::ApproveLoanFile\"],\"agent_specific_commands\":[\"Foobara::Agent::DescribeCommand\",\"Foobara::Agent::DescribeType\",\"Foobara::Agent::GiveUp\",\"Foobara::Agent::ListCommands\",\"Foobara::Agent::ReviewLoanFile::NotifyUserThatCurrentGoalHasBeenAccomplished\"]}}"},{"role":"assistant","content":"{\"command\":\"Foobara::Agent::DetermineNextCommandNameAndInputs\",\"inputs\":{\"agent\":\"#<Foobara::Agent:0x00007fb77c022458>\",\"llm_model\":\"claude-opus-4-20250514\",\"pass_aggregates_to_llm\":true}}"},{"role":"user","content":"{\"success\":false,\"errors_hash\":{\"runtime.could_not_parse_result_json\":{\"key\":\"runtime.could_not_parse_result_json\",\"path\":[],\"runtime_path\":[],\"category\":\"runtime\",\"symbol\":\"could_not_parse_result_json\",\"message\":\"Could
        not parse result JSON: unexpected token ''I'' at line 1 column 1\",\"context\":{\"raw_answer\":\"I
        need to review the loan file against the credit policy requirements. Let me
        check what the requirements are:\\n\\n1. **Credit Score Requirement**: The
        credit policy requires a minimum credit score of 700, using the \\\"maximum\\\"
        score from the three bureaus\\n2. **Pay Stub Requirement**: The credit policy
        requires at least 2 pay stubs\\n\\nNow let me evaluate the loan file:\\n\\n**Credit
        Scores:**\\n- Experian: 600\\n- Equifax: 650  \\n- TransUnion: 750\\n\\nSince
        the policy uses \\\"maximum\\\", I''ll use the highest score of 750, which
        DOES meet the minimum requirement of 700.\\n\\n**Pay Stubs:**\\n- Only 1 pay
        stub provided (from \\\"Some Employer\\\" dated 2025-06-25)\\n- This does
        NOT meet the minimum requirement of 2 pay stubs\\n\\nSince the loan file fails
        to meet the pay stub requirement (only 1 provided when 2 are required), I
        must deny the loan file.\\n\\n{\\\"command\\\":\\\"FoobaraDemo::LoanOrigination::DenyLoanFile\\\",\\\"inputs\\\":{\\\"loan_file_id\\\":2,\\\"denied_reasons\\\":[\\\"insufficient_pay_stubs_provided\\\"]}}\",\"stripped_answer\":\"I
        need to review the loan file against the credit policy requirements. Let me
        check what the requirements are:\\n\\n1. **Credit Score Requirement**: The
        credit policy requires a minimum credit score of 700, using the \\\"maximum\\\"
        score from the three bureaus\\n2. **Pay Stub Requirement**: The credit policy
        requires at least 2 pay stubs\\n\\nNow let me evaluate the loan file:\\n\\n**Credit
        Scores:**\\n- Experian: 600\\n- Equifax: 650  \\n- TransUnion: 750\\n\\nSince
        the policy uses \\\"maximum\\\", I''ll use the highest score of 750, which
        DOES meet the minimum requirement of 700.\\n\\n**Pay Stubs:**\\n- Only 1 pay
        stub provided (from \\\"Some Employer\\\" dated 2025-06-25)\\n- This does
        NOT meet the minimum requirement of 2 pay stubs\\n\\nSince the loan file fails
        to meet the pay stub requirement (only 1 provided when 2 are required), I
        must deny the loan file.\\n\\n{\\\"command\\\":\\\"FoobaraDemo::LoanOrigination::DenyLoanFile\\\",\\\"inputs\\\":{\\\"loan_file_id\\\":2,\\\"denied_reasons\\\":[\\\"insufficient_pay_stubs_provided\\\"]}}\"},\"is_fatal\":false}}}"}],"temperature":0.0,"system":"You
        are part of an agent implementation. Your task is to decide which command
        to run next.\n\nYou are working towards accomplishing the following goal:
        Review loan file\n\nYour behavior has been described to the person or agent
        that chose to run you as: Checks the LoanFile against all requirements in
        its CreditPolicy. Denies the LoanFile that has any unsatisfied requirements.\n\nYour
        inputs to this command have the following type:\n\n{\"type\":\"object\",\"required\":[\"loan_file\"],\"properties\":{\"loan_file\":{\"type\":\"object\",\"required\":[\"credit_scores\",\"loan_application\",\"pay_stubs\",\"state\"],\"properties\":{\"id\":{\"type\":\"number\"},\"loan_application\":{\"type\":\"object\",\"required\":[\"applicant\"],\"properties\":{\"applicant\":{\"type\":\"object\",\"required\":[\"name\"],\"properties\":{\"name\":{\"type\":\"string\"}}}}},\"state\":{\"type\":\"string\",\"enum\":[\"building_loan_file\",\"denied\",\"drafting_docs\",\"in_escrow\",\"in_review\",\"needs_review\",\"recorded\"]},\"pay_stubs\":{\"type\":\"array\",\"items\":{\"type\":\"object\",\"required\":[\"amount\",\"date\",\"employer\"],\"properties\":{\"amount\":{\"type\":\"number\",\"description\":\"Amount
        in dollars of the pay check\"},\"date\":{\"type\":\"string\",\"format\":\"date\",\"description\":\"Date
        the paycheck was issued\"},\"employer\":{\"type\":\"string\",\"description\":\"Name
        of the employer that issued this paycheck\"}}}},\"credit_scores\":{\"type\":\"array\",\"items\":{\"type\":\"object\",\"properties\":{\"score\":{\"type\":\"number\"},\"reporting_agency\":{\"type\":\"string\",\"enum\":[\"equifax\",\"experian\",\"transunion\"]}}}},\"underwriter_decision\":{\"type\":[\"object\",\"null\"],\"required\":[\"credit_score_used\",\"decision\"],\"properties\":{\"decision\":{\"type\":\"string\",\"enum\":[\"approved\",\"denied\"]},\"credit_score_used\":{\"type\":\"number\"},\"denied_reasons\":{\"type\":\"array\",\"items\":{\"type\":\"string\",\"enum\":[\"insufficient_pay_stubs_provided\",\"low_credit_score\"]}}}},\"credit_policy\":{\"type\":\"object\",\"required\":[\"credit_score_to_use\",\"institution\",\"minimum_credit_score\",\"minimum_pay_stub_count\"],\"properties\":{\"id\":{\"type\":\"number\"},\"institution\":{\"type\":\"string\"},\"minimum_pay_stub_count\":{\"type\":\"number\",\"description\":\"The
        loan file must have at least this many pay stubs.\"},\"minimum_credit_score\":{\"type\":\"number\"},\"credit_score_to_use\":{\"type\":\"string\",\"enum\":[\"median\",\"maximum\"],\"description\":\"If
        the scores are 500, 650, and 700, then maximum will compare the biggest (700)
        against minimum_credit_score and median will compare the median (650) against
        minimum_credit_score.\"}}}}}}}\n\nYou have been ran with the following inputs:\n\n{\"loan_file\":{\"id\":2,\"state\":\"needs_review\",\"pay_stubs\":[{\"amount\":3000,\"date\":\"2025-06-25\",\"employer\":\"Some
        Employer\"}],\"credit_scores\":[{\"reporting_agency\":\"experian\",\"score\":600},{\"reporting_agency\":\"equifax\",\"score\":650},{\"reporting_agency\":\"transunion\",\"score\":750}],\"loan_application\":{\"applicant\":{\"name\":\"Basil\"}},\"credit_policy\":{\"id\":2,\"institution\":\"Bank
        B\",\"minimum_credit_score\":700,\"credit_score_to_use\":\"maximum\",\"minimum_pay_stub_count\":2}}}\n\nYou
        will answer with the name of the next command to run and, if needed, its inputs.
        Choose whichever command is best to make progress towards accomplishing the
        current goal based on the progress made so far. If the goal has been accomplished
        then choose the NotifyUserThatCurrentGoalHasBeenAccomplished command. If you
        are stuck either due to errors or because you do not have the command you
        need to accomplish the goal, then choose GiveUp.\n\nYou can get more details
        about the inputs and result schemas for a specific command by choosing the
        DescribeCommand command.\n\nYour result type is described by the following
        JSON schema:\n\n{\"type\":\"object\",\"required\":[\"command\"],\"properties\":{\"command\":{\"type\":\"string\"},\"inputs\":{\"type\":[\"object\",\"null\"]}}}\n\nYou
        will reply with nothing more than the JSON that you''ve generated that adheres
        to this result type schema so that the calling code can successfully parse
        your answer."}'
    headers:
      Content-Type:
      - application/json
      X-Api-Key:
      - "<SCRUBBED_ANTHROPIC_API_KEY>"
      Anthropic-Version:
      - '2023-06-01'
      Accept-Encoding:
      - gzip;q=1.0,deflate;q=0.6,identity;q=0.3
      Accept:
      - "*/*"
      User-Agent:
      - Ruby
  response:
    status:
      code: 200
      message: OK
    headers:
      Date:
      - Wed, 23 Jul 2025 20:42:31 GMT
      Content-Type:
      - application/json
      Transfer-Encoding:
      - chunked
      Connection:
      - keep-alive
      Anthropic-Ratelimit-Input-Tokens-Limit:
      - '80000'
      Anthropic-Ratelimit-Input-Tokens-Remaining:
      - '80000'
      Anthropic-Ratelimit-Input-Tokens-Reset:
      - '2025-07-23T20:42:30Z'
      Anthropic-Ratelimit-Output-Tokens-Limit:
      - '16000'
      Anthropic-Ratelimit-Output-Tokens-Remaining:
      - '16000'
      Anthropic-Ratelimit-Output-Tokens-Reset:
      - '2025-07-23T20:42:31Z'
      Anthropic-Ratelimit-Requests-Limit:
      - '2000'
      Anthropic-Ratelimit-Requests-Remaining:
      - '1999'
      Anthropic-Ratelimit-Requests-Reset:
      - '2025-07-23T20:42:28Z'
      Anthropic-Ratelimit-Tokens-Limit:
      - '96000'
      Anthropic-Ratelimit-Tokens-Remaining:
      - '96000'
      Anthropic-Ratelimit-Tokens-Reset:
      - '2025-07-23T20:42:30Z'
      Request-Id:
      - req_011CRQbm6FphXbHGGBMr1WdG
      Strict-Transport-Security:
      - max-age=31536000; includeSubDomains; preload
      Anthropic-Organization-Id:
      - 7a8e3751-3b70-4f90-a3ce-07f57c9d0bfc
      Via:
      - 1.1 google
      Cf-Cache-Status:
      - DYNAMIC
      X-Robots-Tag:
      - none
      Server:
      - cloudflare
      Cf-Ray:
      - 963e01274f5f1682-SJC
    body:
      encoding: ASCII-8BIT
      string: '{"id":"msg_01U8kSWsvbyy3NeS3fPXBPEG","type":"message","role":"assistant","model":"claude-opus-4-20250514","content":[{"type":"text","text":"{\"command\":\"FoobaraDemo::LoanOrigination::DenyLoanFile\",\"inputs\":{\"loan_file_id\":2,\"denied_reasons\":[\"insufficient_pay_stubs_provided\"]}}"}],"stop_reason":"end_turn","stop_sequence":null,"usage":{"input_tokens":2170,"cache_creation_input_tokens":0,"cache_read_input_tokens":0,"output_tokens":49,"service_tier":"standard"}}'
  recorded_at: Wed, 23 Jul 2025 20:42:31 GMT
- request:
    method: post
    uri: https://api.anthropic.com/v1/messages
    body:
      encoding: UTF-8
      string: '{"model":"claude-opus-4-20250514","max_tokens":1024,"messages":[{"role":"assistant","content":"{\"command\":\"Foobara::Agent::DescribeCommand\",\"inputs\":{\"command_name\":\"Foobara::Agent::ListCommands\"}}"},{"role":"user","content":"{\"success\":true,\"result\":{\"full_command_name\":\"Foobara::Agent::ListCommands\",\"description\":null,\"inputs_type\":{\"type\":\"object\"},\"result_type\":{\"type\":\"object\",\"required\":[\"agent_specific_commands\",\"user_provided_commands\"],\"properties\":{\"user_provided_commands\":{\"type\":\"array\",\"items\":{\"type\":\"string\"},\"description\":\"List
        of commands the user would like you to choose from to accomplish the goal\"},\"agent_specific_commands\":{\"type\":\"array\",\"items\":{\"type\":\"string\"},\"description\":\"Commands
        available to all agents to introspect or end the session\"}}}}}"},{"role":"assistant","content":"{\"command\":\"Foobara::Agent::ListCommands\"}"},{"role":"user","content":"{\"success\":true,\"result\":{\"user_provided_commands\":[\"FoobaraDemo::LoanOrigination::StartUnderwriterReview\",\"FoobaraDemo::LoanOrigination::DenyLoanFile\",\"FoobaraDemo::LoanOrigination::ApproveLoanFile\"],\"agent_specific_commands\":[\"Foobara::Agent::DescribeCommand\",\"Foobara::Agent::DescribeType\",\"Foobara::Agent::GiveUp\",\"Foobara::Agent::ListCommands\",\"Foobara::Agent::ReviewLoanFile::NotifyUserThatCurrentGoalHasBeenAccomplished\"]}}"},{"role":"assistant","content":"{\"command\":\"Foobara::Agent::DetermineNextCommandNameAndInputs\",\"inputs\":{\"agent\":\"#<Foobara::Agent:0x00007fb77c022458>\",\"llm_model\":\"claude-opus-4-20250514\",\"pass_aggregates_to_llm\":true}}"},{"role":"user","content":"{\"success\":false,\"errors_hash\":{\"runtime.could_not_parse_result_json\":{\"key\":\"runtime.could_not_parse_result_json\",\"path\":[],\"runtime_path\":[],\"category\":\"runtime\",\"symbol\":\"could_not_parse_result_json\",\"message\":\"Could
        not parse result JSON: unexpected token ''I'' at line 1 column 1\",\"context\":{\"raw_answer\":\"I
        need to review the loan file against the credit policy requirements. Let me
        check what the requirements are:\\n\\n1. **Credit Score Requirement**: The
        credit policy requires a minimum credit score of 700, using the \\\"maximum\\\"
        score from the three bureaus\\n2. **Pay Stub Requirement**: The credit policy
        requires at least 2 pay stubs\\n\\nNow let me evaluate the loan file:\\n\\n**Credit
        Scores:**\\n- Experian: 600\\n- Equifax: 650  \\n- TransUnion: 750\\n\\nSince
        the policy uses \\\"maximum\\\", I''ll use the highest score of 750, which
        DOES meet the minimum requirement of 700.\\n\\n**Pay Stubs:**\\n- Only 1 pay
        stub provided (from \\\"Some Employer\\\" dated 2025-06-25)\\n- This does
        NOT meet the minimum requirement of 2 pay stubs\\n\\nSince the loan file fails
        to meet the pay stub requirement (only 1 provided when 2 are required), I
        must deny the loan file.\\n\\n{\\\"command\\\":\\\"FoobaraDemo::LoanOrigination::DenyLoanFile\\\",\\\"inputs\\\":{\\\"loan_file_id\\\":2,\\\"denied_reasons\\\":[\\\"insufficient_pay_stubs_provided\\\"]}}\",\"stripped_answer\":\"I
        need to review the loan file against the credit policy requirements. Let me
        check what the requirements are:\\n\\n1. **Credit Score Requirement**: The
        credit policy requires a minimum credit score of 700, using the \\\"maximum\\\"
        score from the three bureaus\\n2. **Pay Stub Requirement**: The credit policy
        requires at least 2 pay stubs\\n\\nNow let me evaluate the loan file:\\n\\n**Credit
        Scores:**\\n- Experian: 600\\n- Equifax: 650  \\n- TransUnion: 750\\n\\nSince
        the policy uses \\\"maximum\\\", I''ll use the highest score of 750, which
        DOES meet the minimum requirement of 700.\\n\\n**Pay Stubs:**\\n- Only 1 pay
        stub provided (from \\\"Some Employer\\\" dated 2025-06-25)\\n- This does
        NOT meet the minimum requirement of 2 pay stubs\\n\\nSince the loan file fails
        to meet the pay stub requirement (only 1 provided when 2 are required), I
        must deny the loan file.\\n\\n{\\\"command\\\":\\\"FoobaraDemo::LoanOrigination::DenyLoanFile\\\",\\\"inputs\\\":{\\\"loan_file_id\\\":2,\\\"denied_reasons\\\":[\\\"insufficient_pay_stubs_provided\\\"]}}\"},\"is_fatal\":false}}}"},{"role":"assistant","content":"{\"command\":\"Foobara::Agent::DescribeCommand\",\"inputs\":{\"command_name\":\"FoobaraDemo::LoanOrigination::DenyLoanFile\"}}"},{"role":"user","content":"{\"success\":true,\"result\":{\"full_command_name\":\"FoobaraDemo::LoanOrigination::DenyLoanFile\",\"description\":null,\"inputs_type\":{\"type\":\"object\",\"required\":[\"credit_score_used\",\"denied_reasons\",\"loan_file\"],\"properties\":{\"credit_score_used\":{\"type\":\"number\"},\"denied_reasons\":{\"type\":\"array\",\"items\":{\"type\":\"string\",\"enum\":[\"insufficient_pay_stubs_provided\",\"low_credit_score\"]}},\"loan_file\":{\"type\":\"number\",\"description\":\"LoanFile
        id\"}}}}}"}],"temperature":0.0,"system":"You are part of an agent implementation.
        Your task is to decide which command to run next.\n\nYou are working towards
        accomplishing the following goal: Review loan file\n\nYour behavior has been
        described to the person or agent that chose to run you as: Checks the LoanFile
        against all requirements in its CreditPolicy. Denies the LoanFile that has
        any unsatisfied requirements.\n\nYour inputs to this command have the following
        type:\n\n{\"type\":\"object\",\"required\":[\"loan_file\"],\"properties\":{\"loan_file\":{\"type\":\"object\",\"required\":[\"credit_scores\",\"loan_application\",\"pay_stubs\",\"state\"],\"properties\":{\"id\":{\"type\":\"number\"},\"loan_application\":{\"type\":\"object\",\"required\":[\"applicant\"],\"properties\":{\"applicant\":{\"type\":\"object\",\"required\":[\"name\"],\"properties\":{\"name\":{\"type\":\"string\"}}}}},\"state\":{\"type\":\"string\",\"enum\":[\"building_loan_file\",\"denied\",\"drafting_docs\",\"in_escrow\",\"in_review\",\"needs_review\",\"recorded\"]},\"pay_stubs\":{\"type\":\"array\",\"items\":{\"type\":\"object\",\"required\":[\"amount\",\"date\",\"employer\"],\"properties\":{\"amount\":{\"type\":\"number\",\"description\":\"Amount
        in dollars of the pay check\"},\"date\":{\"type\":\"string\",\"format\":\"date\",\"description\":\"Date
        the paycheck was issued\"},\"employer\":{\"type\":\"string\",\"description\":\"Name
        of the employer that issued this paycheck\"}}}},\"credit_scores\":{\"type\":\"array\",\"items\":{\"type\":\"object\",\"properties\":{\"score\":{\"type\":\"number\"},\"reporting_agency\":{\"type\":\"string\",\"enum\":[\"equifax\",\"experian\",\"transunion\"]}}}},\"underwriter_decision\":{\"type\":[\"object\",\"null\"],\"required\":[\"credit_score_used\",\"decision\"],\"properties\":{\"decision\":{\"type\":\"string\",\"enum\":[\"approved\",\"denied\"]},\"credit_score_used\":{\"type\":\"number\"},\"denied_reasons\":{\"type\":\"array\",\"items\":{\"type\":\"string\",\"enum\":[\"insufficient_pay_stubs_provided\",\"low_credit_score\"]}}}},\"credit_policy\":{\"type\":\"object\",\"required\":[\"credit_score_to_use\",\"institution\",\"minimum_credit_score\",\"minimum_pay_stub_count\"],\"properties\":{\"id\":{\"type\":\"number\"},\"institution\":{\"type\":\"string\"},\"minimum_pay_stub_count\":{\"type\":\"number\",\"description\":\"The
        loan file must have at least this many pay stubs.\"},\"minimum_credit_score\":{\"type\":\"number\"},\"credit_score_to_use\":{\"type\":\"string\",\"enum\":[\"median\",\"maximum\"],\"description\":\"If
        the scores are 500, 650, and 700, then maximum will compare the biggest (700)
        against minimum_credit_score and median will compare the median (650) against
        minimum_credit_score.\"}}}}}}}\n\nYou have been ran with the following inputs:\n\n{\"loan_file\":{\"id\":2,\"state\":\"needs_review\",\"pay_stubs\":[{\"amount\":3000,\"date\":\"2025-06-25\",\"employer\":\"Some
        Employer\"}],\"credit_scores\":[{\"reporting_agency\":\"experian\",\"score\":600},{\"reporting_agency\":\"equifax\",\"score\":650},{\"reporting_agency\":\"transunion\",\"score\":750}],\"loan_application\":{\"applicant\":{\"name\":\"Basil\"}},\"credit_policy\":{\"id\":2,\"institution\":\"Bank
        B\",\"minimum_credit_score\":700,\"credit_score_to_use\":\"maximum\",\"minimum_pay_stub_count\":2}}}\n\nYou
        will answer with the name of the next command to run and, if needed, its inputs.
        Choose whichever command is best to make progress towards accomplishing the
        current goal based on the progress made so far. If the goal has been accomplished
        then choose the NotifyUserThatCurrentGoalHasBeenAccomplished command. If you
        are stuck either due to errors or because you do not have the command you
        need to accomplish the goal, then choose GiveUp.\n\nYou can get more details
        about the inputs and result schemas for a specific command by choosing the
        DescribeCommand command.\n\nYour result type is described by the following
        JSON schema:\n\n{\"type\":\"object\",\"required\":[\"command\"],\"properties\":{\"command\":{\"type\":\"string\"},\"inputs\":{\"type\":[\"object\",\"null\"]}}}\n\nYou
        will reply with nothing more than the JSON that you''ve generated that adheres
        to this result type schema so that the calling code can successfully parse
        your answer."}'
    headers:
      Content-Type:
      - application/json
      X-Api-Key:
      - "<SCRUBBED_ANTHROPIC_API_KEY>"
      Anthropic-Version:
      - '2023-06-01'
      Accept-Encoding:
      - gzip;q=1.0,deflate;q=0.6,identity;q=0.3
      Accept:
      - "*/*"
      User-Agent:
      - Ruby
  response:
    status:
      code: 200
      message: OK
    headers:
      Date:
      - Wed, 23 Jul 2025 20:42:34 GMT
      Content-Type:
      - application/json
      Transfer-Encoding:
      - chunked
      Connection:
      - keep-alive
      Anthropic-Ratelimit-Input-Tokens-Limit:
      - '80000'
      Anthropic-Ratelimit-Input-Tokens-Remaining:
      - '80000'
      Anthropic-Ratelimit-Input-Tokens-Reset:
      - '2025-07-23T20:42:33Z'
      Anthropic-Ratelimit-Output-Tokens-Limit:
      - '16000'
      Anthropic-Ratelimit-Output-Tokens-Remaining:
      - '16000'
      Anthropic-Ratelimit-Output-Tokens-Reset:
      - '2025-07-23T20:42:34Z'
      Anthropic-Ratelimit-Requests-Limit:
      - '2000'
      Anthropic-Ratelimit-Requests-Remaining:
      - '1999'
      Anthropic-Ratelimit-Requests-Reset:
      - '2025-07-23T20:42:31Z'
      Anthropic-Ratelimit-Tokens-Limit:
      - '96000'
      Anthropic-Ratelimit-Tokens-Remaining:
      - '96000'
      Anthropic-Ratelimit-Tokens-Reset:
      - '2025-07-23T20:42:33Z'
      Request-Id:
      - req_011CRQbmK2XaeNVeQ6yJae4y
      Strict-Transport-Security:
      - max-age=31536000; includeSubDomains; preload
      Anthropic-Organization-Id:
      - 7a8e3751-3b70-4f90-a3ce-07f57c9d0bfc
      Via:
      - 1.1 google
      Cf-Cache-Status:
      - DYNAMIC
      X-Robots-Tag:
      - none
      Server:
      - cloudflare
      Cf-Ray:
      - 963e0139dccd15d4-SJC
    body:
      encoding: ASCII-8BIT
      string: '{"id":"msg_01KjzudRpGYgnqpsd4ZcmxnS","type":"message","role":"assistant","model":"claude-opus-4-20250514","content":[{"type":"text","text":"{\"command\":\"FoobaraDemo::LoanOrigination::DenyLoanFile\",\"inputs\":{\"loan_file\":2,\"credit_score_used\":750,\"denied_reasons\":[\"insufficient_pay_stubs_provided\"]}}"}],"stop_reason":"end_turn","stop_sequence":null,"usage":{"input_tokens":2347,"cache_creation_input_tokens":0,"cache_read_input_tokens":0,"output_tokens":55,"service_tier":"standard"}}'
  recorded_at: Wed, 23 Jul 2025 20:42:34 GMT
- request:
    method: post
    uri: https://api.anthropic.com/v1/messages
    body:
      encoding: UTF-8
      string: '{"model":"claude-opus-4-20250514","max_tokens":1024,"messages":[{"role":"assistant","content":"{\"command\":\"Foobara::Agent::DescribeCommand\",\"inputs\":{\"command_name\":\"Foobara::Agent::ListCommands\"}}"},{"role":"user","content":"{\"success\":true,\"result\":{\"full_command_name\":\"Foobara::Agent::ListCommands\",\"description\":null,\"inputs_type\":{\"type\":\"object\"},\"result_type\":{\"type\":\"object\",\"required\":[\"agent_specific_commands\",\"user_provided_commands\"],\"properties\":{\"user_provided_commands\":{\"type\":\"array\",\"items\":{\"type\":\"string\"},\"description\":\"List
        of commands the user would like you to choose from to accomplish the goal\"},\"agent_specific_commands\":{\"type\":\"array\",\"items\":{\"type\":\"string\"},\"description\":\"Commands
        available to all agents to introspect or end the session\"}}}}}"},{"role":"assistant","content":"{\"command\":\"Foobara::Agent::ListCommands\"}"},{"role":"user","content":"{\"success\":true,\"result\":{\"user_provided_commands\":[\"FoobaraDemo::LoanOrigination::StartUnderwriterReview\",\"FoobaraDemo::LoanOrigination::DenyLoanFile\",\"FoobaraDemo::LoanOrigination::ApproveLoanFile\"],\"agent_specific_commands\":[\"Foobara::Agent::DescribeCommand\",\"Foobara::Agent::DescribeType\",\"Foobara::Agent::GiveUp\",\"Foobara::Agent::ListCommands\",\"Foobara::Agent::ReviewLoanFile::NotifyUserThatCurrentGoalHasBeenAccomplished\"]}}"},{"role":"assistant","content":"{\"command\":\"Foobara::Agent::DetermineNextCommandNameAndInputs\",\"inputs\":{\"agent\":\"#<Foobara::Agent:0x00007fb77c022458>\",\"llm_model\":\"claude-opus-4-20250514\",\"pass_aggregates_to_llm\":true}}"},{"role":"user","content":"{\"success\":false,\"errors_hash\":{\"runtime.could_not_parse_result_json\":{\"key\":\"runtime.could_not_parse_result_json\",\"path\":[],\"runtime_path\":[],\"category\":\"runtime\",\"symbol\":\"could_not_parse_result_json\",\"message\":\"Could
        not parse result JSON: unexpected token ''I'' at line 1 column 1\",\"context\":{\"raw_answer\":\"I
        need to review the loan file against the credit policy requirements. Let me
        check what the requirements are:\\n\\n1. **Credit Score Requirement**: The
        credit policy requires a minimum credit score of 700, using the \\\"maximum\\\"
        score from the three bureaus\\n2. **Pay Stub Requirement**: The credit policy
        requires at least 2 pay stubs\\n\\nNow let me evaluate the loan file:\\n\\n**Credit
        Scores:**\\n- Experian: 600\\n- Equifax: 650  \\n- TransUnion: 750\\n\\nSince
        the policy uses \\\"maximum\\\", I''ll use the highest score of 750, which
        DOES meet the minimum requirement of 700.\\n\\n**Pay Stubs:**\\n- Only 1 pay
        stub provided (from \\\"Some Employer\\\" dated 2025-06-25)\\n- This does
        NOT meet the minimum requirement of 2 pay stubs\\n\\nSince the loan file fails
        to meet the pay stub requirement (only 1 provided when 2 are required), I
        must deny the loan file.\\n\\n{\\\"command\\\":\\\"FoobaraDemo::LoanOrigination::DenyLoanFile\\\",\\\"inputs\\\":{\\\"loan_file_id\\\":2,\\\"denied_reasons\\\":[\\\"insufficient_pay_stubs_provided\\\"]}}\",\"stripped_answer\":\"I
        need to review the loan file against the credit policy requirements. Let me
        check what the requirements are:\\n\\n1. **Credit Score Requirement**: The
        credit policy requires a minimum credit score of 700, using the \\\"maximum\\\"
        score from the three bureaus\\n2. **Pay Stub Requirement**: The credit policy
        requires at least 2 pay stubs\\n\\nNow let me evaluate the loan file:\\n\\n**Credit
        Scores:**\\n- Experian: 600\\n- Equifax: 650  \\n- TransUnion: 750\\n\\nSince
        the policy uses \\\"maximum\\\", I''ll use the highest score of 750, which
        DOES meet the minimum requirement of 700.\\n\\n**Pay Stubs:**\\n- Only 1 pay
        stub provided (from \\\"Some Employer\\\" dated 2025-06-25)\\n- This does
        NOT meet the minimum requirement of 2 pay stubs\\n\\nSince the loan file fails
        to meet the pay stub requirement (only 1 provided when 2 are required), I
        must deny the loan file.\\n\\n{\\\"command\\\":\\\"FoobaraDemo::LoanOrigination::DenyLoanFile\\\",\\\"inputs\\\":{\\\"loan_file_id\\\":2,\\\"denied_reasons\\\":[\\\"insufficient_pay_stubs_provided\\\"]}}\"},\"is_fatal\":false}}}"},{"role":"assistant","content":"{\"command\":\"Foobara::Agent::DescribeCommand\",\"inputs\":{\"command_name\":\"FoobaraDemo::LoanOrigination::DenyLoanFile\"}}"},{"role":"user","content":"{\"success\":true,\"result\":{\"full_command_name\":\"FoobaraDemo::LoanOrigination::DenyLoanFile\",\"description\":null,\"inputs_type\":{\"type\":\"object\",\"required\":[\"credit_score_used\",\"denied_reasons\",\"loan_file\"],\"properties\":{\"credit_score_used\":{\"type\":\"number\"},\"denied_reasons\":{\"type\":\"array\",\"items\":{\"type\":\"string\",\"enum\":[\"insufficient_pay_stubs_provided\",\"low_credit_score\"]}},\"loan_file\":{\"type\":\"number\",\"description\":\"LoanFile
        id\"}}}}}"},{"role":"assistant","content":"{\"command\":\"FoobaraDemo::LoanOrigination::DenyLoanFile\",\"inputs\":{\"loan_file\":2,\"credit_score_used\":750,\"denied_reasons\":[\"insufficient_pay_stubs_provided\"]}}"},{"role":"user","content":"{\"success\":false,\"errors_hash\":{\"data.loan_file.cannot_transition_state\":{\"key\":\"data.loan_file.cannot_transition_state\",\"path\":[\"loan_file\"],\"runtime_path\":[],\"category\":\"data\",\"symbol\":\"cannot_transition_state\",\"message\":\"Cannot
        perform deny transition for loan file 2 from needs_review. Expected state
        to be one of: [:in_review]. Did you forget to start the review?\",\"context\":{\"loan_file_id\":2,\"current_state\":\"needs_review\",\"required_states\":[\"in_review\"],\"attempted_transition\":\"deny\"},\"is_fatal\":false}}}"}],"temperature":0.0,"system":"You
        are part of an agent implementation. Your task is to decide which command
        to run next.\n\nYou are working towards accomplishing the following goal:
        Review loan file\n\nYour behavior has been described to the person or agent
        that chose to run you as: Checks the LoanFile against all requirements in
        its CreditPolicy. Denies the LoanFile that has any unsatisfied requirements.\n\nYour
        inputs to this command have the following type:\n\n{\"type\":\"object\",\"required\":[\"loan_file\"],\"properties\":{\"loan_file\":{\"type\":\"object\",\"required\":[\"credit_scores\",\"loan_application\",\"pay_stubs\",\"state\"],\"properties\":{\"id\":{\"type\":\"number\"},\"loan_application\":{\"type\":\"object\",\"required\":[\"applicant\"],\"properties\":{\"applicant\":{\"type\":\"object\",\"required\":[\"name\"],\"properties\":{\"name\":{\"type\":\"string\"}}}}},\"state\":{\"type\":\"string\",\"enum\":[\"building_loan_file\",\"denied\",\"drafting_docs\",\"in_escrow\",\"in_review\",\"needs_review\",\"recorded\"]},\"pay_stubs\":{\"type\":\"array\",\"items\":{\"type\":\"object\",\"required\":[\"amount\",\"date\",\"employer\"],\"properties\":{\"amount\":{\"type\":\"number\",\"description\":\"Amount
        in dollars of the pay check\"},\"date\":{\"type\":\"string\",\"format\":\"date\",\"description\":\"Date
        the paycheck was issued\"},\"employer\":{\"type\":\"string\",\"description\":\"Name
        of the employer that issued this paycheck\"}}}},\"credit_scores\":{\"type\":\"array\",\"items\":{\"type\":\"object\",\"properties\":{\"score\":{\"type\":\"number\"},\"reporting_agency\":{\"type\":\"string\",\"enum\":[\"equifax\",\"experian\",\"transunion\"]}}}},\"underwriter_decision\":{\"type\":[\"object\",\"null\"],\"required\":[\"credit_score_used\",\"decision\"],\"properties\":{\"decision\":{\"type\":\"string\",\"enum\":[\"approved\",\"denied\"]},\"credit_score_used\":{\"type\":\"number\"},\"denied_reasons\":{\"type\":\"array\",\"items\":{\"type\":\"string\",\"enum\":[\"insufficient_pay_stubs_provided\",\"low_credit_score\"]}}}},\"credit_policy\":{\"type\":\"object\",\"required\":[\"credit_score_to_use\",\"institution\",\"minimum_credit_score\",\"minimum_pay_stub_count\"],\"properties\":{\"id\":{\"type\":\"number\"},\"institution\":{\"type\":\"string\"},\"minimum_pay_stub_count\":{\"type\":\"number\",\"description\":\"The
        loan file must have at least this many pay stubs.\"},\"minimum_credit_score\":{\"type\":\"number\"},\"credit_score_to_use\":{\"type\":\"string\",\"enum\":[\"median\",\"maximum\"],\"description\":\"If
        the scores are 500, 650, and 700, then maximum will compare the biggest (700)
        against minimum_credit_score and median will compare the median (650) against
        minimum_credit_score.\"}}}}}}}\n\nYou have been ran with the following inputs:\n\n{\"loan_file\":{\"id\":2,\"state\":\"needs_review\",\"pay_stubs\":[{\"amount\":3000,\"date\":\"2025-06-25\",\"employer\":\"Some
        Employer\"}],\"credit_scores\":[{\"reporting_agency\":\"experian\",\"score\":600},{\"reporting_agency\":\"equifax\",\"score\":650},{\"reporting_agency\":\"transunion\",\"score\":750}],\"loan_application\":{\"applicant\":{\"name\":\"Basil\"}},\"credit_policy\":{\"id\":2,\"institution\":\"Bank
        B\",\"minimum_credit_score\":700,\"credit_score_to_use\":\"maximum\",\"minimum_pay_stub_count\":2}}}\n\nYou
        will answer with the name of the next command to run and, if needed, its inputs.
        Choose whichever command is best to make progress towards accomplishing the
        current goal based on the progress made so far. If the goal has been accomplished
        then choose the NotifyUserThatCurrentGoalHasBeenAccomplished command. If you
        are stuck either due to errors or because you do not have the command you
        need to accomplish the goal, then choose GiveUp.\n\nYou can get more details
        about the inputs and result schemas for a specific command by choosing the
        DescribeCommand command.\n\nYour result type is described by the following
        JSON schema:\n\n{\"type\":\"object\",\"required\":[\"command\"],\"properties\":{\"command\":{\"type\":\"string\"},\"inputs\":{\"type\":[\"object\",\"null\"]}}}\n\nYou
        will reply with nothing more than the JSON that you''ve generated that adheres
        to this result type schema so that the calling code can successfully parse
        your answer."}'
    headers:
      Content-Type:
      - application/json
      X-Api-Key:
      - "<SCRUBBED_ANTHROPIC_API_KEY>"
      Anthropic-Version:
      - '2023-06-01'
      Accept-Encoding:
      - gzip;q=1.0,deflate;q=0.6,identity;q=0.3
      Accept:
      - "*/*"
      User-Agent:
      - Ruby
  response:
    status:
      code: 200
      message: OK
    headers:
      Date:
      - Wed, 23 Jul 2025 20:42:38 GMT
      Content-Type:
      - application/json
      Transfer-Encoding:
      - chunked
      Connection:
      - keep-alive
      Anthropic-Ratelimit-Input-Tokens-Limit:
      - '80000'
      Anthropic-Ratelimit-Input-Tokens-Remaining:
      - '80000'
      Anthropic-Ratelimit-Input-Tokens-Reset:
      - '2025-07-23T20:42:38Z'
      Anthropic-Ratelimit-Output-Tokens-Limit:
      - '16000'
      Anthropic-Ratelimit-Output-Tokens-Remaining:
      - '16000'
      Anthropic-Ratelimit-Output-Tokens-Reset:
      - '2025-07-23T20:42:38Z'
      Anthropic-Ratelimit-Requests-Limit:
      - '2000'
      Anthropic-Ratelimit-Requests-Remaining:
      - '1999'
      Anthropic-Ratelimit-Requests-Reset:
      - '2025-07-23T20:42:34Z'
      Anthropic-Ratelimit-Tokens-Limit:
      - '96000'
      Anthropic-Ratelimit-Tokens-Remaining:
      - '96000'
      Anthropic-Ratelimit-Tokens-Reset:
      - '2025-07-23T20:42:38Z'
      Request-Id:
      - req_011CRQbmYritekc8kSQYVPE1
      Strict-Transport-Security:
      - max-age=31536000; includeSubDomains; preload
      Anthropic-Organization-Id:
      - 7a8e3751-3b70-4f90-a3ce-07f57c9d0bfc
      Via:
      - 1.1 google
      Cf-Cache-Status:
      - DYNAMIC
      X-Robots-Tag:
      - none
      Server:
      - cloudflare
      Cf-Ray:
      - 963e014e2f24dc0d-SJC
    body:
      encoding: ASCII-8BIT
      string: '{"id":"msg_012BphZGJjvxepy51k2HXfCY","type":"message","role":"assistant","model":"claude-opus-4-20250514","content":[{"type":"text","text":"{\"command\":\"FoobaraDemo::LoanOrigination::StartUnderwriterReview\",\"inputs\":{\"loan_file\":2}}"}],"stop_reason":"end_turn","stop_sequence":null,"usage":{"input_tokens":2549,"cache_creation_input_tokens":0,"cache_read_input_tokens":0,"output_tokens":34,"service_tier":"standard"}}'
  recorded_at: Wed, 23 Jul 2025 20:42:38 GMT
- request:
    method: post
    uri: https://api.anthropic.com/v1/messages
    body:
      encoding: UTF-8
      string: '{"model":"claude-opus-4-20250514","max_tokens":1024,"messages":[{"role":"assistant","content":"{\"command\":\"Foobara::Agent::DescribeCommand\",\"inputs\":{\"command_name\":\"Foobara::Agent::ListCommands\"}}"},{"role":"user","content":"{\"success\":true,\"result\":{\"full_command_name\":\"Foobara::Agent::ListCommands\",\"description\":null,\"inputs_type\":{\"type\":\"object\"},\"result_type\":{\"type\":\"object\",\"required\":[\"agent_specific_commands\",\"user_provided_commands\"],\"properties\":{\"user_provided_commands\":{\"type\":\"array\",\"items\":{\"type\":\"string\"},\"description\":\"List
        of commands the user would like you to choose from to accomplish the goal\"},\"agent_specific_commands\":{\"type\":\"array\",\"items\":{\"type\":\"string\"},\"description\":\"Commands
        available to all agents to introspect or end the session\"}}}}}"},{"role":"assistant","content":"{\"command\":\"Foobara::Agent::ListCommands\"}"},{"role":"user","content":"{\"success\":true,\"result\":{\"user_provided_commands\":[\"FoobaraDemo::LoanOrigination::StartUnderwriterReview\",\"FoobaraDemo::LoanOrigination::DenyLoanFile\",\"FoobaraDemo::LoanOrigination::ApproveLoanFile\"],\"agent_specific_commands\":[\"Foobara::Agent::DescribeCommand\",\"Foobara::Agent::DescribeType\",\"Foobara::Agent::GiveUp\",\"Foobara::Agent::ListCommands\",\"Foobara::Agent::ReviewLoanFile::NotifyUserThatCurrentGoalHasBeenAccomplished\"]}}"},{"role":"assistant","content":"{\"command\":\"Foobara::Agent::DetermineNextCommandNameAndInputs\",\"inputs\":{\"agent\":\"#<Foobara::Agent:0x00007fb77c022458>\",\"llm_model\":\"claude-opus-4-20250514\",\"pass_aggregates_to_llm\":true}}"},{"role":"user","content":"{\"success\":false,\"errors_hash\":{\"runtime.could_not_parse_result_json\":{\"key\":\"runtime.could_not_parse_result_json\",\"path\":[],\"runtime_path\":[],\"category\":\"runtime\",\"symbol\":\"could_not_parse_result_json\",\"message\":\"Could
        not parse result JSON: unexpected token ''I'' at line 1 column 1\",\"context\":{\"raw_answer\":\"I
        need to review the loan file against the credit policy requirements. Let me
        check what the requirements are:\\n\\n1. **Credit Score Requirement**: The
        credit policy requires a minimum credit score of 700, using the \\\"maximum\\\"
        score from the three bureaus\\n2. **Pay Stub Requirement**: The credit policy
        requires at least 2 pay stubs\\n\\nNow let me evaluate the loan file:\\n\\n**Credit
        Scores:**\\n- Experian: 600\\n- Equifax: 650  \\n- TransUnion: 750\\n\\nSince
        the policy uses \\\"maximum\\\", I''ll use the highest score of 750, which
        DOES meet the minimum requirement of 700.\\n\\n**Pay Stubs:**\\n- Only 1 pay
        stub provided (from \\\"Some Employer\\\" dated 2025-06-25)\\n- This does
        NOT meet the minimum requirement of 2 pay stubs\\n\\nSince the loan file fails
        to meet the pay stub requirement (only 1 provided when 2 are required), I
        must deny the loan file.\\n\\n{\\\"command\\\":\\\"FoobaraDemo::LoanOrigination::DenyLoanFile\\\",\\\"inputs\\\":{\\\"loan_file_id\\\":2,\\\"denied_reasons\\\":[\\\"insufficient_pay_stubs_provided\\\"]}}\",\"stripped_answer\":\"I
        need to review the loan file against the credit policy requirements. Let me
        check what the requirements are:\\n\\n1. **Credit Score Requirement**: The
        credit policy requires a minimum credit score of 700, using the \\\"maximum\\\"
        score from the three bureaus\\n2. **Pay Stub Requirement**: The credit policy
        requires at least 2 pay stubs\\n\\nNow let me evaluate the loan file:\\n\\n**Credit
        Scores:**\\n- Experian: 600\\n- Equifax: 650  \\n- TransUnion: 750\\n\\nSince
        the policy uses \\\"maximum\\\", I''ll use the highest score of 750, which
        DOES meet the minimum requirement of 700.\\n\\n**Pay Stubs:**\\n- Only 1 pay
        stub provided (from \\\"Some Employer\\\" dated 2025-06-25)\\n- This does
        NOT meet the minimum requirement of 2 pay stubs\\n\\nSince the loan file fails
        to meet the pay stub requirement (only 1 provided when 2 are required), I
        must deny the loan file.\\n\\n{\\\"command\\\":\\\"FoobaraDemo::LoanOrigination::DenyLoanFile\\\",\\\"inputs\\\":{\\\"loan_file_id\\\":2,\\\"denied_reasons\\\":[\\\"insufficient_pay_stubs_provided\\\"]}}\"},\"is_fatal\":false}}}"},{"role":"assistant","content":"{\"command\":\"Foobara::Agent::DescribeCommand\",\"inputs\":{\"command_name\":\"FoobaraDemo::LoanOrigination::DenyLoanFile\"}}"},{"role":"user","content":"{\"success\":true,\"result\":{\"full_command_name\":\"FoobaraDemo::LoanOrigination::DenyLoanFile\",\"description\":null,\"inputs_type\":{\"type\":\"object\",\"required\":[\"credit_score_used\",\"denied_reasons\",\"loan_file\"],\"properties\":{\"credit_score_used\":{\"type\":\"number\"},\"denied_reasons\":{\"type\":\"array\",\"items\":{\"type\":\"string\",\"enum\":[\"insufficient_pay_stubs_provided\",\"low_credit_score\"]}},\"loan_file\":{\"type\":\"number\",\"description\":\"LoanFile
        id\"}}}}}"},{"role":"assistant","content":"{\"command\":\"FoobaraDemo::LoanOrigination::DenyLoanFile\",\"inputs\":{\"loan_file\":2,\"credit_score_used\":750,\"denied_reasons\":[\"insufficient_pay_stubs_provided\"]}}"},{"role":"user","content":"{\"success\":false,\"errors_hash\":{\"data.loan_file.cannot_transition_state\":{\"key\":\"data.loan_file.cannot_transition_state\",\"path\":[\"loan_file\"],\"runtime_path\":[],\"category\":\"data\",\"symbol\":\"cannot_transition_state\",\"message\":\"Cannot
        perform deny transition for loan file 2 from needs_review. Expected state
        to be one of: [:in_review]. Did you forget to start the review?\",\"context\":{\"loan_file_id\":2,\"current_state\":\"needs_review\",\"required_states\":[\"in_review\"],\"attempted_transition\":\"deny\"},\"is_fatal\":false}}}"},{"role":"assistant","content":"{\"command\":\"Foobara::Agent::DescribeCommand\",\"inputs\":{\"command_name\":\"FoobaraDemo::LoanOrigination::StartUnderwriterReview\"}}"},{"role":"user","content":"{\"success\":true,\"result\":{\"full_command_name\":\"FoobaraDemo::LoanOrigination::StartUnderwriterReview\",\"description\":null,\"inputs_type\":{\"type\":\"object\",\"required\":[\"loan_file\"],\"properties\":{\"loan_file\":{\"type\":\"number\",\"description\":\"LoanFile
        id\"}}}}}"}],"temperature":0.0,"system":"You are part of an agent implementation.
        Your task is to decide which command to run next.\n\nYou are working towards
        accomplishing the following goal: Review loan file\n\nYour behavior has been
        described to the person or agent that chose to run you as: Checks the LoanFile
        against all requirements in its CreditPolicy. Denies the LoanFile that has
        any unsatisfied requirements.\n\nYour inputs to this command have the following
        type:\n\n{\"type\":\"object\",\"required\":[\"loan_file\"],\"properties\":{\"loan_file\":{\"type\":\"object\",\"required\":[\"credit_scores\",\"loan_application\",\"pay_stubs\",\"state\"],\"properties\":{\"id\":{\"type\":\"number\"},\"loan_application\":{\"type\":\"object\",\"required\":[\"applicant\"],\"properties\":{\"applicant\":{\"type\":\"object\",\"required\":[\"name\"],\"properties\":{\"name\":{\"type\":\"string\"}}}}},\"state\":{\"type\":\"string\",\"enum\":[\"building_loan_file\",\"denied\",\"drafting_docs\",\"in_escrow\",\"in_review\",\"needs_review\",\"recorded\"]},\"pay_stubs\":{\"type\":\"array\",\"items\":{\"type\":\"object\",\"required\":[\"amount\",\"date\",\"employer\"],\"properties\":{\"amount\":{\"type\":\"number\",\"description\":\"Amount
        in dollars of the pay check\"},\"date\":{\"type\":\"string\",\"format\":\"date\",\"description\":\"Date
        the paycheck was issued\"},\"employer\":{\"type\":\"string\",\"description\":\"Name
        of the employer that issued this paycheck\"}}}},\"credit_scores\":{\"type\":\"array\",\"items\":{\"type\":\"object\",\"properties\":{\"score\":{\"type\":\"number\"},\"reporting_agency\":{\"type\":\"string\",\"enum\":[\"equifax\",\"experian\",\"transunion\"]}}}},\"underwriter_decision\":{\"type\":[\"object\",\"null\"],\"required\":[\"credit_score_used\",\"decision\"],\"properties\":{\"decision\":{\"type\":\"string\",\"enum\":[\"approved\",\"denied\"]},\"credit_score_used\":{\"type\":\"number\"},\"denied_reasons\":{\"type\":\"array\",\"items\":{\"type\":\"string\",\"enum\":[\"insufficient_pay_stubs_provided\",\"low_credit_score\"]}}}},\"credit_policy\":{\"type\":\"object\",\"required\":[\"credit_score_to_use\",\"institution\",\"minimum_credit_score\",\"minimum_pay_stub_count\"],\"properties\":{\"id\":{\"type\":\"number\"},\"institution\":{\"type\":\"string\"},\"minimum_pay_stub_count\":{\"type\":\"number\",\"description\":\"The
        loan file must have at least this many pay stubs.\"},\"minimum_credit_score\":{\"type\":\"number\"},\"credit_score_to_use\":{\"type\":\"string\",\"enum\":[\"median\",\"maximum\"],\"description\":\"If
        the scores are 500, 650, and 700, then maximum will compare the biggest (700)
        against minimum_credit_score and median will compare the median (650) against
        minimum_credit_score.\"}}}}}}}\n\nYou have been ran with the following inputs:\n\n{\"loan_file\":{\"id\":2,\"state\":\"needs_review\",\"pay_stubs\":[{\"amount\":3000,\"date\":\"2025-06-25\",\"employer\":\"Some
        Employer\"}],\"credit_scores\":[{\"reporting_agency\":\"experian\",\"score\":600},{\"reporting_agency\":\"equifax\",\"score\":650},{\"reporting_agency\":\"transunion\",\"score\":750}],\"loan_application\":{\"applicant\":{\"name\":\"Basil\"}},\"credit_policy\":{\"id\":2,\"institution\":\"Bank
        B\",\"minimum_credit_score\":700,\"credit_score_to_use\":\"maximum\",\"minimum_pay_stub_count\":2}}}\n\nYou
        will answer with the name of the next command to run and, if needed, its inputs.
        Choose whichever command is best to make progress towards accomplishing the
        current goal based on the progress made so far. If the goal has been accomplished
        then choose the NotifyUserThatCurrentGoalHasBeenAccomplished command. If you
        are stuck either due to errors or because you do not have the command you
        need to accomplish the goal, then choose GiveUp.\n\nYou can get more details
        about the inputs and result schemas for a specific command by choosing the
        DescribeCommand command.\n\nYour result type is described by the following
        JSON schema:\n\n{\"type\":\"object\",\"required\":[\"command\"],\"properties\":{\"command\":{\"type\":\"string\"},\"inputs\":{\"type\":[\"object\",\"null\"]}}}\n\nYou
        will reply with nothing more than the JSON that you''ve generated that adheres
        to this result type schema so that the calling code can successfully parse
        your answer."}'
    headers:
      Content-Type:
      - application/json
      X-Api-Key:
      - "<SCRUBBED_ANTHROPIC_API_KEY>"
      Anthropic-Version:
      - '2023-06-01'
      Accept-Encoding:
      - gzip;q=1.0,deflate;q=0.6,identity;q=0.3
      Accept:
      - "*/*"
      User-Agent:
      - Ruby
  response:
    status:
      code: 200
      message: OK
    headers:
      Date:
      - Wed, 23 Jul 2025 20:42:49 GMT
      Content-Type:
      - application/json
      Transfer-Encoding:
      - chunked
      Connection:
      - keep-alive
      Anthropic-Ratelimit-Input-Tokens-Limit:
      - '80000'
      Anthropic-Ratelimit-Input-Tokens-Remaining:
      - '80000'
      Anthropic-Ratelimit-Input-Tokens-Reset:
      - '2025-07-23T20:42:48Z'
      Anthropic-Ratelimit-Output-Tokens-Limit:
      - '16000'
      Anthropic-Ratelimit-Output-Tokens-Remaining:
      - '16000'
      Anthropic-Ratelimit-Output-Tokens-Reset:
      - '2025-07-23T20:42:49Z'
      Anthropic-Ratelimit-Requests-Limit:
      - '2000'
      Anthropic-Ratelimit-Requests-Remaining:
      - '1999'
      Anthropic-Ratelimit-Requests-Reset:
      - '2025-07-23T20:42:39Z'
      Anthropic-Ratelimit-Tokens-Limit:
      - '96000'
      Anthropic-Ratelimit-Tokens-Remaining:
      - '96000'
      Anthropic-Ratelimit-Tokens-Reset:
      - '2025-07-23T20:42:48Z'
      Request-Id:
      - req_011CRQbmsUQYF6EM7H7rEEfM
      Strict-Transport-Security:
      - max-age=31536000; includeSubDomains; preload
      Anthropic-Organization-Id:
      - 7a8e3751-3b70-4f90-a3ce-07f57c9d0bfc
      Via:
      - 1.1 google
      Cf-Cache-Status:
      - DYNAMIC
      X-Robots-Tag:
      - none
      Server:
      - cloudflare
      Cf-Ray:
      - 963e0169598d67dc-SJC
    body:
      encoding: ASCII-8BIT
      string: '{"id":"msg_018QZeyihL4r5zbbjNr5JXiJ","type":"message","role":"assistant","model":"claude-opus-4-20250514","content":[{"type":"text","text":"{\"command\":\"FoobaraDemo::LoanOrigination::StartUnderwriterReview\",\"inputs\":{\"loan_file\":2}}"}],"stop_reason":"end_turn","stop_sequence":null,"usage":{"input_tokens":2672,"cache_creation_input_tokens":0,"cache_read_input_tokens":0,"output_tokens":34,"service_tier":"standard"}}'
  recorded_at: Wed, 23 Jul 2025 20:42:49 GMT
- request:
    method: post
    uri: https://api.anthropic.com/v1/messages
    body:
      encoding: UTF-8
      string: '{"model":"claude-opus-4-20250514","max_tokens":1024,"messages":[{"role":"assistant","content":"{\"command\":\"Foobara::Agent::DescribeCommand\",\"inputs\":{\"command_name\":\"Foobara::Agent::ListCommands\"}}"},{"role":"user","content":"{\"success\":true,\"result\":{\"full_command_name\":\"Foobara::Agent::ListCommands\",\"description\":null,\"inputs_type\":{\"type\":\"object\"},\"result_type\":{\"type\":\"object\",\"required\":[\"agent_specific_commands\",\"user_provided_commands\"],\"properties\":{\"user_provided_commands\":{\"type\":\"array\",\"items\":{\"type\":\"string\"},\"description\":\"List
        of commands the user would like you to choose from to accomplish the goal\"},\"agent_specific_commands\":{\"type\":\"array\",\"items\":{\"type\":\"string\"},\"description\":\"Commands
        available to all agents to introspect or end the session\"}}}}}"},{"role":"assistant","content":"{\"command\":\"Foobara::Agent::ListCommands\"}"},{"role":"user","content":"{\"success\":true,\"result\":{\"user_provided_commands\":[\"FoobaraDemo::LoanOrigination::StartUnderwriterReview\",\"FoobaraDemo::LoanOrigination::DenyLoanFile\",\"FoobaraDemo::LoanOrigination::ApproveLoanFile\"],\"agent_specific_commands\":[\"Foobara::Agent::DescribeCommand\",\"Foobara::Agent::DescribeType\",\"Foobara::Agent::GiveUp\",\"Foobara::Agent::ListCommands\",\"Foobara::Agent::ReviewLoanFile::NotifyUserThatCurrentGoalHasBeenAccomplished\"]}}"},{"role":"assistant","content":"{\"command\":\"Foobara::Agent::DetermineNextCommandNameAndInputs\",\"inputs\":{\"agent\":\"#<Foobara::Agent:0x00007fb77c022458>\",\"llm_model\":\"claude-opus-4-20250514\",\"pass_aggregates_to_llm\":true}}"},{"role":"user","content":"{\"success\":false,\"errors_hash\":{\"runtime.could_not_parse_result_json\":{\"key\":\"runtime.could_not_parse_result_json\",\"path\":[],\"runtime_path\":[],\"category\":\"runtime\",\"symbol\":\"could_not_parse_result_json\",\"message\":\"Could
        not parse result JSON: unexpected token ''I'' at line 1 column 1\",\"context\":{\"raw_answer\":\"I
        need to review the loan file against the credit policy requirements. Let me
        check what the requirements are:\\n\\n1. **Credit Score Requirement**: The
        credit policy requires a minimum credit score of 700, using the \\\"maximum\\\"
        score from the three bureaus\\n2. **Pay Stub Requirement**: The credit policy
        requires at least 2 pay stubs\\n\\nNow let me evaluate the loan file:\\n\\n**Credit
        Scores:**\\n- Experian: 600\\n- Equifax: 650  \\n- TransUnion: 750\\n\\nSince
        the policy uses \\\"maximum\\\", I''ll use the highest score of 750, which
        DOES meet the minimum requirement of 700.\\n\\n**Pay Stubs:**\\n- Only 1 pay
        stub provided (from \\\"Some Employer\\\" dated 2025-06-25)\\n- This does
        NOT meet the minimum requirement of 2 pay stubs\\n\\nSince the loan file fails
        to meet the pay stub requirement (only 1 provided when 2 are required), I
        must deny the loan file.\\n\\n{\\\"command\\\":\\\"FoobaraDemo::LoanOrigination::DenyLoanFile\\\",\\\"inputs\\\":{\\\"loan_file_id\\\":2,\\\"denied_reasons\\\":[\\\"insufficient_pay_stubs_provided\\\"]}}\",\"stripped_answer\":\"I
        need to review the loan file against the credit policy requirements. Let me
        check what the requirements are:\\n\\n1. **Credit Score Requirement**: The
        credit policy requires a minimum credit score of 700, using the \\\"maximum\\\"
        score from the three bureaus\\n2. **Pay Stub Requirement**: The credit policy
        requires at least 2 pay stubs\\n\\nNow let me evaluate the loan file:\\n\\n**Credit
        Scores:**\\n- Experian: 600\\n- Equifax: 650  \\n- TransUnion: 750\\n\\nSince
        the policy uses \\\"maximum\\\", I''ll use the highest score of 750, which
        DOES meet the minimum requirement of 700.\\n\\n**Pay Stubs:**\\n- Only 1 pay
        stub provided (from \\\"Some Employer\\\" dated 2025-06-25)\\n- This does
        NOT meet the minimum requirement of 2 pay stubs\\n\\nSince the loan file fails
        to meet the pay stub requirement (only 1 provided when 2 are required), I
        must deny the loan file.\\n\\n{\\\"command\\\":\\\"FoobaraDemo::LoanOrigination::DenyLoanFile\\\",\\\"inputs\\\":{\\\"loan_file_id\\\":2,\\\"denied_reasons\\\":[\\\"insufficient_pay_stubs_provided\\\"]}}\"},\"is_fatal\":false}}}"},{"role":"assistant","content":"{\"command\":\"Foobara::Agent::DescribeCommand\",\"inputs\":{\"command_name\":\"FoobaraDemo::LoanOrigination::DenyLoanFile\"}}"},{"role":"user","content":"{\"success\":true,\"result\":{\"full_command_name\":\"FoobaraDemo::LoanOrigination::DenyLoanFile\",\"description\":null,\"inputs_type\":{\"type\":\"object\",\"required\":[\"credit_score_used\",\"denied_reasons\",\"loan_file\"],\"properties\":{\"credit_score_used\":{\"type\":\"number\"},\"denied_reasons\":{\"type\":\"array\",\"items\":{\"type\":\"string\",\"enum\":[\"insufficient_pay_stubs_provided\",\"low_credit_score\"]}},\"loan_file\":{\"type\":\"number\",\"description\":\"LoanFile
        id\"}}}}}"},{"role":"assistant","content":"{\"command\":\"FoobaraDemo::LoanOrigination::DenyLoanFile\",\"inputs\":{\"loan_file\":2,\"credit_score_used\":750,\"denied_reasons\":[\"insufficient_pay_stubs_provided\"]}}"},{"role":"user","content":"{\"success\":false,\"errors_hash\":{\"data.loan_file.cannot_transition_state\":{\"key\":\"data.loan_file.cannot_transition_state\",\"path\":[\"loan_file\"],\"runtime_path\":[],\"category\":\"data\",\"symbol\":\"cannot_transition_state\",\"message\":\"Cannot
        perform deny transition for loan file 2 from needs_review. Expected state
        to be one of: [:in_review]. Did you forget to start the review?\",\"context\":{\"loan_file_id\":2,\"current_state\":\"needs_review\",\"required_states\":[\"in_review\"],\"attempted_transition\":\"deny\"},\"is_fatal\":false}}}"},{"role":"assistant","content":"{\"command\":\"Foobara::Agent::DescribeCommand\",\"inputs\":{\"command_name\":\"FoobaraDemo::LoanOrigination::StartUnderwriterReview\"}}"},{"role":"user","content":"{\"success\":true,\"result\":{\"full_command_name\":\"FoobaraDemo::LoanOrigination::StartUnderwriterReview\",\"description\":null,\"inputs_type\":{\"type\":\"object\",\"required\":[\"loan_file\"],\"properties\":{\"loan_file\":{\"type\":\"number\",\"description\":\"LoanFile
        id\"}}}}}"},{"role":"assistant","content":"{\"command\":\"FoobaraDemo::LoanOrigination::StartUnderwriterReview\",\"inputs\":{\"loan_file\":2}}"},{"role":"user","content":"{\"success\":true,\"result\":null}"}],"temperature":0.0,"system":"You
        are part of an agent implementation. Your task is to decide which command
        to run next.\n\nYou are working towards accomplishing the following goal:
        Review loan file\n\nYour behavior has been described to the person or agent
        that chose to run you as: Checks the LoanFile against all requirements in
        its CreditPolicy. Denies the LoanFile that has any unsatisfied requirements.\n\nYour
        inputs to this command have the following type:\n\n{\"type\":\"object\",\"required\":[\"loan_file\"],\"properties\":{\"loan_file\":{\"type\":\"object\",\"required\":[\"credit_scores\",\"loan_application\",\"pay_stubs\",\"state\"],\"properties\":{\"id\":{\"type\":\"number\"},\"loan_application\":{\"type\":\"object\",\"required\":[\"applicant\"],\"properties\":{\"applicant\":{\"type\":\"object\",\"required\":[\"name\"],\"properties\":{\"name\":{\"type\":\"string\"}}}}},\"state\":{\"type\":\"string\",\"enum\":[\"building_loan_file\",\"denied\",\"drafting_docs\",\"in_escrow\",\"in_review\",\"needs_review\",\"recorded\"]},\"pay_stubs\":{\"type\":\"array\",\"items\":{\"type\":\"object\",\"required\":[\"amount\",\"date\",\"employer\"],\"properties\":{\"amount\":{\"type\":\"number\",\"description\":\"Amount
        in dollars of the pay check\"},\"date\":{\"type\":\"string\",\"format\":\"date\",\"description\":\"Date
        the paycheck was issued\"},\"employer\":{\"type\":\"string\",\"description\":\"Name
        of the employer that issued this paycheck\"}}}},\"credit_scores\":{\"type\":\"array\",\"items\":{\"type\":\"object\",\"properties\":{\"score\":{\"type\":\"number\"},\"reporting_agency\":{\"type\":\"string\",\"enum\":[\"equifax\",\"experian\",\"transunion\"]}}}},\"underwriter_decision\":{\"type\":[\"object\",\"null\"],\"required\":[\"credit_score_used\",\"decision\"],\"properties\":{\"decision\":{\"type\":\"string\",\"enum\":[\"approved\",\"denied\"]},\"credit_score_used\":{\"type\":\"number\"},\"denied_reasons\":{\"type\":\"array\",\"items\":{\"type\":\"string\",\"enum\":[\"insufficient_pay_stubs_provided\",\"low_credit_score\"]}}}},\"credit_policy\":{\"type\":\"object\",\"required\":[\"credit_score_to_use\",\"institution\",\"minimum_credit_score\",\"minimum_pay_stub_count\"],\"properties\":{\"id\":{\"type\":\"number\"},\"institution\":{\"type\":\"string\"},\"minimum_pay_stub_count\":{\"type\":\"number\",\"description\":\"The
        loan file must have at least this many pay stubs.\"},\"minimum_credit_score\":{\"type\":\"number\"},\"credit_score_to_use\":{\"type\":\"string\",\"enum\":[\"median\",\"maximum\"],\"description\":\"If
        the scores are 500, 650, and 700, then maximum will compare the biggest (700)
        against minimum_credit_score and median will compare the median (650) against
        minimum_credit_score.\"}}}}}}}\n\nYou have been ran with the following inputs:\n\n{\"loan_file\":{\"id\":2,\"state\":\"needs_review\",\"pay_stubs\":[{\"amount\":3000,\"date\":\"2025-06-25\",\"employer\":\"Some
        Employer\"}],\"credit_scores\":[{\"reporting_agency\":\"experian\",\"score\":600},{\"reporting_agency\":\"equifax\",\"score\":650},{\"reporting_agency\":\"transunion\",\"score\":750}],\"loan_application\":{\"applicant\":{\"name\":\"Basil\"}},\"credit_policy\":{\"id\":2,\"institution\":\"Bank
        B\",\"minimum_credit_score\":700,\"credit_score_to_use\":\"maximum\",\"minimum_pay_stub_count\":2}}}\n\nYou
        will answer with the name of the next command to run and, if needed, its inputs.
        Choose whichever command is best to make progress towards accomplishing the
        current goal based on the progress made so far. If the goal has been accomplished
        then choose the NotifyUserThatCurrentGoalHasBeenAccomplished command. If you
        are stuck either due to errors or because you do not have the command you
        need to accomplish the goal, then choose GiveUp.\n\nYou can get more details
        about the inputs and result schemas for a specific command by choosing the
        DescribeCommand command.\n\nYour result type is described by the following
        JSON schema:\n\n{\"type\":\"object\",\"required\":[\"command\"],\"properties\":{\"command\":{\"type\":\"string\"},\"inputs\":{\"type\":[\"object\",\"null\"]}}}\n\nYou
        will reply with nothing more than the JSON that you''ve generated that adheres
        to this result type schema so that the calling code can successfully parse
        your answer."}'
    headers:
      Content-Type:
      - application/json
      X-Api-Key:
      - "<SCRUBBED_ANTHROPIC_API_KEY>"
      Anthropic-Version:
      - '2023-06-01'
      Accept-Encoding:
      - gzip;q=1.0,deflate;q=0.6,identity;q=0.3
      Accept:
      - "*/*"
      User-Agent:
      - Ruby
  response:
    status:
      code: 200
      message: OK
    headers:
      Date:
      - Wed, 23 Jul 2025 20:42:52 GMT
      Content-Type:
      - application/json
      Transfer-Encoding:
      - chunked
      Connection:
      - keep-alive
      Anthropic-Ratelimit-Input-Tokens-Limit:
      - '80000'
      Anthropic-Ratelimit-Input-Tokens-Remaining:
      - '79000'
      Anthropic-Ratelimit-Input-Tokens-Reset:
      - '2025-07-23T20:42:51Z'
      Anthropic-Ratelimit-Output-Tokens-Limit:
      - '16000'
      Anthropic-Ratelimit-Output-Tokens-Remaining:
      - '16000'
      Anthropic-Ratelimit-Output-Tokens-Reset:
      - '2025-07-23T20:42:52Z'
      Anthropic-Ratelimit-Requests-Limit:
      - '2000'
      Anthropic-Ratelimit-Requests-Remaining:
      - '1999'
      Anthropic-Ratelimit-Requests-Reset:
      - '2025-07-23T20:42:49Z'
      Anthropic-Ratelimit-Tokens-Limit:
      - '96000'
      Anthropic-Ratelimit-Tokens-Remaining:
      - '95000'
      Anthropic-Ratelimit-Tokens-Reset:
      - '2025-07-23T20:42:51Z'
      Request-Id:
      - req_011CRQbnducUxywu5WqVsbGs
      Strict-Transport-Security:
      - max-age=31536000; includeSubDomains; preload
      Anthropic-Organization-Id:
      - 7a8e3751-3b70-4f90-a3ce-07f57c9d0bfc
      Via:
      - 1.1 google
      Cf-Cache-Status:
      - DYNAMIC
      X-Robots-Tag:
      - none
      Server:
      - cloudflare
      Cf-Ray:
      - 963e01aa5d0bfa92-SJC
    body:
      encoding: ASCII-8BIT
      string: '{"id":"msg_01JjPRcUPJ5ToYaydzqc5111","type":"message","role":"assistant","model":"claude-opus-4-20250514","content":[{"type":"text","text":"{\"command\":\"FoobaraDemo::LoanOrigination::DenyLoanFile\",\"inputs\":{\"loan_file\":2,\"credit_score_used\":750,\"denied_reasons\":[\"insufficient_pay_stubs_provided\"]}}"}],"stop_reason":"end_turn","stop_sequence":null,"usage":{"input_tokens":2718,"cache_creation_input_tokens":0,"cache_read_input_tokens":0,"output_tokens":55,"service_tier":"standard"}}'
  recorded_at: Wed, 23 Jul 2025 20:42:52 GMT
- request:
    method: post
    uri: https://api.anthropic.com/v1/messages
    body:
      encoding: UTF-8
      string: '{"model":"claude-opus-4-20250514","max_tokens":1024,"messages":[{"role":"assistant","content":"{\"command\":\"Foobara::Agent::DescribeCommand\",\"inputs\":{\"command_name\":\"Foobara::Agent::ListCommands\"}}"},{"role":"user","content":"{\"success\":true,\"result\":{\"full_command_name\":\"Foobara::Agent::ListCommands\",\"description\":null,\"inputs_type\":{\"type\":\"object\"},\"result_type\":{\"type\":\"object\",\"required\":[\"agent_specific_commands\",\"user_provided_commands\"],\"properties\":{\"user_provided_commands\":{\"type\":\"array\",\"items\":{\"type\":\"string\"},\"description\":\"List
        of commands the user would like you to choose from to accomplish the goal\"},\"agent_specific_commands\":{\"type\":\"array\",\"items\":{\"type\":\"string\"},\"description\":\"Commands
        available to all agents to introspect or end the session\"}}}}}"},{"role":"assistant","content":"{\"command\":\"Foobara::Agent::ListCommands\"}"},{"role":"user","content":"{\"success\":true,\"result\":{\"user_provided_commands\":[\"FoobaraDemo::LoanOrigination::StartUnderwriterReview\",\"FoobaraDemo::LoanOrigination::DenyLoanFile\",\"FoobaraDemo::LoanOrigination::ApproveLoanFile\"],\"agent_specific_commands\":[\"Foobara::Agent::DescribeCommand\",\"Foobara::Agent::DescribeType\",\"Foobara::Agent::GiveUp\",\"Foobara::Agent::ListCommands\",\"Foobara::Agent::ReviewLoanFile::NotifyUserThatCurrentGoalHasBeenAccomplished\"]}}"},{"role":"assistant","content":"{\"command\":\"Foobara::Agent::DetermineNextCommandNameAndInputs\",\"inputs\":{\"agent\":\"#<Foobara::Agent:0x00007fb77c022458>\",\"llm_model\":\"claude-opus-4-20250514\",\"pass_aggregates_to_llm\":true}}"},{"role":"user","content":"{\"success\":false,\"errors_hash\":{\"runtime.could_not_parse_result_json\":{\"key\":\"runtime.could_not_parse_result_json\",\"path\":[],\"runtime_path\":[],\"category\":\"runtime\",\"symbol\":\"could_not_parse_result_json\",\"message\":\"Could
        not parse result JSON: unexpected token ''I'' at line 1 column 1\",\"context\":{\"raw_answer\":\"I
        need to review the loan file against the credit policy requirements. Let me
        check what the requirements are:\\n\\n1. **Credit Score Requirement**: The
        credit policy requires a minimum credit score of 700, using the \\\"maximum\\\"
        score from the three bureaus\\n2. **Pay Stub Requirement**: The credit policy
        requires at least 2 pay stubs\\n\\nNow let me evaluate the loan file:\\n\\n**Credit
        Scores:**\\n- Experian: 600\\n- Equifax: 650  \\n- TransUnion: 750\\n\\nSince
        the policy uses \\\"maximum\\\", I''ll use the highest score of 750, which
        DOES meet the minimum requirement of 700.\\n\\n**Pay Stubs:**\\n- Only 1 pay
        stub provided (from \\\"Some Employer\\\" dated 2025-06-25)\\n- This does
        NOT meet the minimum requirement of 2 pay stubs\\n\\nSince the loan file fails
        to meet the pay stub requirement (only 1 provided when 2 are required), I
        must deny the loan file.\\n\\n{\\\"command\\\":\\\"FoobaraDemo::LoanOrigination::DenyLoanFile\\\",\\\"inputs\\\":{\\\"loan_file_id\\\":2,\\\"denied_reasons\\\":[\\\"insufficient_pay_stubs_provided\\\"]}}\",\"stripped_answer\":\"I
        need to review the loan file against the credit policy requirements. Let me
        check what the requirements are:\\n\\n1. **Credit Score Requirement**: The
        credit policy requires a minimum credit score of 700, using the \\\"maximum\\\"
        score from the three bureaus\\n2. **Pay Stub Requirement**: The credit policy
        requires at least 2 pay stubs\\n\\nNow let me evaluate the loan file:\\n\\n**Credit
        Scores:**\\n- Experian: 600\\n- Equifax: 650  \\n- TransUnion: 750\\n\\nSince
        the policy uses \\\"maximum\\\", I''ll use the highest score of 750, which
        DOES meet the minimum requirement of 700.\\n\\n**Pay Stubs:**\\n- Only 1 pay
        stub provided (from \\\"Some Employer\\\" dated 2025-06-25)\\n- This does
        NOT meet the minimum requirement of 2 pay stubs\\n\\nSince the loan file fails
        to meet the pay stub requirement (only 1 provided when 2 are required), I
        must deny the loan file.\\n\\n{\\\"command\\\":\\\"FoobaraDemo::LoanOrigination::DenyLoanFile\\\",\\\"inputs\\\":{\\\"loan_file_id\\\":2,\\\"denied_reasons\\\":[\\\"insufficient_pay_stubs_provided\\\"]}}\"},\"is_fatal\":false}}}"},{"role":"assistant","content":"{\"command\":\"Foobara::Agent::DescribeCommand\",\"inputs\":{\"command_name\":\"FoobaraDemo::LoanOrigination::DenyLoanFile\"}}"},{"role":"user","content":"{\"success\":true,\"result\":{\"full_command_name\":\"FoobaraDemo::LoanOrigination::DenyLoanFile\",\"description\":null,\"inputs_type\":{\"type\":\"object\",\"required\":[\"credit_score_used\",\"denied_reasons\",\"loan_file\"],\"properties\":{\"credit_score_used\":{\"type\":\"number\"},\"denied_reasons\":{\"type\":\"array\",\"items\":{\"type\":\"string\",\"enum\":[\"insufficient_pay_stubs_provided\",\"low_credit_score\"]}},\"loan_file\":{\"type\":\"number\",\"description\":\"LoanFile
        id\"}}}}}"},{"role":"assistant","content":"{\"command\":\"Foobara::Agent::DescribeCommand\",\"inputs\":{\"command_name\":\"FoobaraDemo::LoanOrigination::StartUnderwriterReview\"}}"},{"role":"user","content":"{\"success\":true,\"result\":{\"full_command_name\":\"FoobaraDemo::LoanOrigination::StartUnderwriterReview\",\"description\":null,\"inputs_type\":{\"type\":\"object\",\"required\":[\"loan_file\"],\"properties\":{\"loan_file\":{\"type\":\"number\",\"description\":\"LoanFile
        id\"}}}}}"},{"role":"assistant","content":"{\"command\":\"FoobaraDemo::LoanOrigination::StartUnderwriterReview\",\"inputs\":{\"loan_file\":2}}"},{"role":"user","content":"{\"success\":true,\"result\":null}"},{"role":"assistant","content":"{\"command\":\"FoobaraDemo::LoanOrigination::DenyLoanFile\",\"inputs\":{\"loan_file\":2,\"credit_score_used\":750,\"denied_reasons\":[\"insufficient_pay_stubs_provided\"]}}"},{"role":"user","content":"{\"success\":true,\"result\":null}"}],"temperature":0.0,"system":"You
        are part of an agent implementation. Your task is to decide which command
        to run next.\n\nYou are working towards accomplishing the following goal:
        Review loan file\n\nYour behavior has been described to the person or agent
        that chose to run you as: Checks the LoanFile against all requirements in
        its CreditPolicy. Denies the LoanFile that has any unsatisfied requirements.\n\nYour
        inputs to this command have the following type:\n\n{\"type\":\"object\",\"required\":[\"loan_file\"],\"properties\":{\"loan_file\":{\"type\":\"object\",\"required\":[\"credit_scores\",\"loan_application\",\"pay_stubs\",\"state\"],\"properties\":{\"id\":{\"type\":\"number\"},\"loan_application\":{\"type\":\"object\",\"required\":[\"applicant\"],\"properties\":{\"applicant\":{\"type\":\"object\",\"required\":[\"name\"],\"properties\":{\"name\":{\"type\":\"string\"}}}}},\"state\":{\"type\":\"string\",\"enum\":[\"building_loan_file\",\"denied\",\"drafting_docs\",\"in_escrow\",\"in_review\",\"needs_review\",\"recorded\"]},\"pay_stubs\":{\"type\":\"array\",\"items\":{\"type\":\"object\",\"required\":[\"amount\",\"date\",\"employer\"],\"properties\":{\"amount\":{\"type\":\"number\",\"description\":\"Amount
        in dollars of the pay check\"},\"date\":{\"type\":\"string\",\"format\":\"date\",\"description\":\"Date
        the paycheck was issued\"},\"employer\":{\"type\":\"string\",\"description\":\"Name
        of the employer that issued this paycheck\"}}}},\"credit_scores\":{\"type\":\"array\",\"items\":{\"type\":\"object\",\"properties\":{\"score\":{\"type\":\"number\"},\"reporting_agency\":{\"type\":\"string\",\"enum\":[\"equifax\",\"experian\",\"transunion\"]}}}},\"underwriter_decision\":{\"type\":[\"object\",\"null\"],\"required\":[\"credit_score_used\",\"decision\"],\"properties\":{\"decision\":{\"type\":\"string\",\"enum\":[\"approved\",\"denied\"]},\"credit_score_used\":{\"type\":\"number\"},\"denied_reasons\":{\"type\":\"array\",\"items\":{\"type\":\"string\",\"enum\":[\"insufficient_pay_stubs_provided\",\"low_credit_score\"]}}}},\"credit_policy\":{\"type\":\"object\",\"required\":[\"credit_score_to_use\",\"institution\",\"minimum_credit_score\",\"minimum_pay_stub_count\"],\"properties\":{\"id\":{\"type\":\"number\"},\"institution\":{\"type\":\"string\"},\"minimum_pay_stub_count\":{\"type\":\"number\",\"description\":\"The
        loan file must have at least this many pay stubs.\"},\"minimum_credit_score\":{\"type\":\"number\"},\"credit_score_to_use\":{\"type\":\"string\",\"enum\":[\"median\",\"maximum\"],\"description\":\"If
        the scores are 500, 650, and 700, then maximum will compare the biggest (700)
        against minimum_credit_score and median will compare the median (650) against
        minimum_credit_score.\"}}}}}}}\n\nYou have been ran with the following inputs:\n\n{\"loan_file\":{\"id\":2,\"state\":\"needs_review\",\"pay_stubs\":[{\"amount\":3000,\"date\":\"2025-06-25\",\"employer\":\"Some
        Employer\"}],\"credit_scores\":[{\"reporting_agency\":\"experian\",\"score\":600},{\"reporting_agency\":\"equifax\",\"score\":650},{\"reporting_agency\":\"transunion\",\"score\":750}],\"loan_application\":{\"applicant\":{\"name\":\"Basil\"}},\"credit_policy\":{\"id\":2,\"institution\":\"Bank
        B\",\"minimum_credit_score\":700,\"credit_score_to_use\":\"maximum\",\"minimum_pay_stub_count\":2}}}\n\nYou
        will answer with the name of the next command to run and, if needed, its inputs.
        Choose whichever command is best to make progress towards accomplishing the
        current goal based on the progress made so far. If the goal has been accomplished
        then choose the NotifyUserThatCurrentGoalHasBeenAccomplished command. If you
        are stuck either due to errors or because you do not have the command you
        need to accomplish the goal, then choose GiveUp.\n\nYou can get more details
        about the inputs and result schemas for a specific command by choosing the
        DescribeCommand command.\n\nYour result type is described by the following
        JSON schema:\n\n{\"type\":\"object\",\"required\":[\"command\"],\"properties\":{\"command\":{\"type\":\"string\"},\"inputs\":{\"type\":[\"object\",\"null\"]}}}\n\nYou
        will reply with nothing more than the JSON that you''ve generated that adheres
        to this result type schema so that the calling code can successfully parse
        your answer."}'
    headers:
      Content-Type:
      - application/json
      X-Api-Key:
      - "<SCRUBBED_ANTHROPIC_API_KEY>"
      Anthropic-Version:
      - '2023-06-01'
      Accept-Encoding:
      - gzip;q=1.0,deflate;q=0.6,identity;q=0.3
      Accept:
      - "*/*"
      User-Agent:
      - Ruby
  response:
    status:
      code: 200
      message: OK
    headers:
      Date:
      - Wed, 23 Jul 2025 20:42:55 GMT
      Content-Type:
      - application/json
      Transfer-Encoding:
      - chunked
      Connection:
      - keep-alive
      Anthropic-Ratelimit-Input-Tokens-Limit:
      - '80000'
      Anthropic-Ratelimit-Input-Tokens-Remaining:
      - '79000'
      Anthropic-Ratelimit-Input-Tokens-Reset:
      - '2025-07-23T20:42:54Z'
      Anthropic-Ratelimit-Output-Tokens-Limit:
      - '16000'
      Anthropic-Ratelimit-Output-Tokens-Remaining:
      - '16000'
      Anthropic-Ratelimit-Output-Tokens-Reset:
      - '2025-07-23T20:42:55Z'
      Anthropic-Ratelimit-Requests-Limit:
      - '2000'
      Anthropic-Ratelimit-Requests-Remaining:
      - '1999'
      Anthropic-Ratelimit-Requests-Reset:
      - '2025-07-23T20:42:52Z'
      Anthropic-Ratelimit-Tokens-Limit:
      - '96000'
      Anthropic-Ratelimit-Tokens-Remaining:
      - '95000'
      Anthropic-Ratelimit-Tokens-Reset:
      - '2025-07-23T20:42:54Z'
      Request-Id:
      - req_011CRQbnrsU89mfanoXRUQHp
      Strict-Transport-Security:
      - max-age=31536000; includeSubDomains; preload
      Anthropic-Organization-Id:
      - 7a8e3751-3b70-4f90-a3ce-07f57c9d0bfc
      Via:
      - 1.1 google
      Cf-Cache-Status:
      - DYNAMIC
      X-Robots-Tag:
      - none
      Server:
      - cloudflare
      Cf-Ray:
      - 963e01bd4ea5ed3d-SJC
    body:
      encoding: ASCII-8BIT
      string: '{"id":"msg_017krCcDGiCj1vP9oMkGCVUx","type":"message","role":"assistant","model":"claude-opus-4-20250514","content":[{"type":"text","text":"{\"command\":\"Foobara::Agent::ReviewLoanFile::NotifyUserThatCurrentGoalHasBeenAccomplished\"}"}],"stop_reason":"end_turn","stop_sequence":null,"usage":{"input_tokens":2583,"cache_creation_input_tokens":0,"cache_read_input_tokens":0,"output_tokens":34,"service_tier":"standard"}}'
  recorded_at: Wed, 23 Jul 2025 20:42:55 GMT
- request:
    method: post
    uri: https://api.anthropic.com/v1/messages
    body:
      encoding: UTF-8
      string: '{"model":"claude-opus-4-20250514","max_tokens":1024,"messages":[{"role":"assistant","content":"{\"command\":\"Foobara::Agent::DescribeCommand\",\"inputs\":{\"command_name\":\"Foobara::Agent::ListCommands\"}}"},{"role":"user","content":"{\"success\":true,\"result\":{\"full_command_name\":\"Foobara::Agent::ListCommands\",\"description\":null,\"inputs_type\":{\"type\":\"object\"},\"result_type\":{\"type\":\"object\",\"required\":[\"agent_specific_commands\",\"user_provided_commands\"],\"properties\":{\"user_provided_commands\":{\"type\":\"array\",\"items\":{\"type\":\"string\"},\"description\":\"List
        of commands the user would like you to choose from to accomplish the goal\"},\"agent_specific_commands\":{\"type\":\"array\",\"items\":{\"type\":\"string\"},\"description\":\"Commands
        available to all agents to introspect or end the session\"}}}}}"},{"role":"assistant","content":"{\"command\":\"Foobara::Agent::ListCommands\"}"},{"role":"user","content":"{\"success\":true,\"result\":{\"user_provided_commands\":[\"FoobaraDemo::LoanOrigination::StartUnderwriterReview\",\"FoobaraDemo::LoanOrigination::DenyLoanFile\",\"FoobaraDemo::LoanOrigination::ApproveLoanFile\"],\"agent_specific_commands\":[\"Foobara::Agent::DescribeCommand\",\"Foobara::Agent::DescribeType\",\"Foobara::Agent::GiveUp\",\"Foobara::Agent::ListCommands\",\"Foobara::Agent::ReviewLoanFile::NotifyUserThatCurrentGoalHasBeenAccomplished\"]}}"},{"role":"assistant","content":"{\"command\":\"Foobara::Agent::DetermineNextCommandNameAndInputs\",\"inputs\":{\"agent\":\"#<Foobara::Agent:0x00007fb77c022458>\",\"llm_model\":\"claude-opus-4-20250514\",\"pass_aggregates_to_llm\":true}}"},{"role":"user","content":"{\"success\":false,\"errors_hash\":{\"runtime.could_not_parse_result_json\":{\"key\":\"runtime.could_not_parse_result_json\",\"path\":[],\"runtime_path\":[],\"category\":\"runtime\",\"symbol\":\"could_not_parse_result_json\",\"message\":\"Could
        not parse result JSON: unexpected token ''I'' at line 1 column 1\",\"context\":{\"raw_answer\":\"I
        need to review the loan file against the credit policy requirements. Let me
        check what the requirements are:\\n\\n1. **Credit Score Requirement**: The
        credit policy requires a minimum credit score of 700, using the \\\"maximum\\\"
        score from the three bureaus\\n2. **Pay Stub Requirement**: The credit policy
        requires at least 2 pay stubs\\n\\nNow let me evaluate the loan file:\\n\\n**Credit
        Scores:**\\n- Experian: 600\\n- Equifax: 650  \\n- TransUnion: 750\\n\\nSince
        the policy uses \\\"maximum\\\", I''ll use the highest score of 750, which
        DOES meet the minimum requirement of 700.\\n\\n**Pay Stubs:**\\n- Only 1 pay
        stub provided (from \\\"Some Employer\\\" dated 2025-06-25)\\n- This does
        NOT meet the minimum requirement of 2 pay stubs\\n\\nSince the loan file fails
        to meet the pay stub requirement (only 1 provided when 2 are required), I
        must deny the loan file.\\n\\n{\\\"command\\\":\\\"FoobaraDemo::LoanOrigination::DenyLoanFile\\\",\\\"inputs\\\":{\\\"loan_file_id\\\":2,\\\"denied_reasons\\\":[\\\"insufficient_pay_stubs_provided\\\"]}}\",\"stripped_answer\":\"I
        need to review the loan file against the credit policy requirements. Let me
        check what the requirements are:\\n\\n1. **Credit Score Requirement**: The
        credit policy requires a minimum credit score of 700, using the \\\"maximum\\\"
        score from the three bureaus\\n2. **Pay Stub Requirement**: The credit policy
        requires at least 2 pay stubs\\n\\nNow let me evaluate the loan file:\\n\\n**Credit
        Scores:**\\n- Experian: 600\\n- Equifax: 650  \\n- TransUnion: 750\\n\\nSince
        the policy uses \\\"maximum\\\", I''ll use the highest score of 750, which
        DOES meet the minimum requirement of 700.\\n\\n**Pay Stubs:**\\n- Only 1 pay
        stub provided (from \\\"Some Employer\\\" dated 2025-06-25)\\n- This does
        NOT meet the minimum requirement of 2 pay stubs\\n\\nSince the loan file fails
        to meet the pay stub requirement (only 1 provided when 2 are required), I
        must deny the loan file.\\n\\n{\\\"command\\\":\\\"FoobaraDemo::LoanOrigination::DenyLoanFile\\\",\\\"inputs\\\":{\\\"loan_file_id\\\":2,\\\"denied_reasons\\\":[\\\"insufficient_pay_stubs_provided\\\"]}}\"},\"is_fatal\":false}}}"},{"role":"assistant","content":"{\"command\":\"Foobara::Agent::DescribeCommand\",\"inputs\":{\"command_name\":\"FoobaraDemo::LoanOrigination::DenyLoanFile\"}}"},{"role":"user","content":"{\"success\":true,\"result\":{\"full_command_name\":\"FoobaraDemo::LoanOrigination::DenyLoanFile\",\"description\":null,\"inputs_type\":{\"type\":\"object\",\"required\":[\"credit_score_used\",\"denied_reasons\",\"loan_file\"],\"properties\":{\"credit_score_used\":{\"type\":\"number\"},\"denied_reasons\":{\"type\":\"array\",\"items\":{\"type\":\"string\",\"enum\":[\"insufficient_pay_stubs_provided\",\"low_credit_score\"]}},\"loan_file\":{\"type\":\"number\",\"description\":\"LoanFile
        id\"}}}}}"},{"role":"assistant","content":"{\"command\":\"Foobara::Agent::DescribeCommand\",\"inputs\":{\"command_name\":\"FoobaraDemo::LoanOrigination::StartUnderwriterReview\"}}"},{"role":"user","content":"{\"success\":true,\"result\":{\"full_command_name\":\"FoobaraDemo::LoanOrigination::StartUnderwriterReview\",\"description\":null,\"inputs_type\":{\"type\":\"object\",\"required\":[\"loan_file\"],\"properties\":{\"loan_file\":{\"type\":\"number\",\"description\":\"LoanFile
        id\"}}}}}"},{"role":"assistant","content":"{\"command\":\"FoobaraDemo::LoanOrigination::StartUnderwriterReview\",\"inputs\":{\"loan_file\":2}}"},{"role":"user","content":"{\"success\":true,\"result\":null}"},{"role":"assistant","content":"{\"command\":\"FoobaraDemo::LoanOrigination::DenyLoanFile\",\"inputs\":{\"loan_file\":2,\"credit_score_used\":750,\"denied_reasons\":[\"insufficient_pay_stubs_provided\"]}}"},{"role":"user","content":"{\"success\":true,\"result\":null}"},{"role":"assistant","content":"{\"command\":\"Foobara::Agent::DescribeCommand\",\"inputs\":{\"command_name\":\"Foobara::Agent::ReviewLoanFile::NotifyUserThatCurrentGoalHasBeenAccomplished\"}}"},{"role":"user","content":"{\"success\":true,\"result\":{\"full_command_name\":\"Foobara::Agent::ReviewLoanFile::NotifyUserThatCurrentGoalHasBeenAccomplished\",\"description\":\"Notifies
        the user that the current goal has been accomplished and accepts a final result
        value as inputs. The user might issue a new goal.\",\"inputs_type\":{\"type\":\"object\",\"required\":[\"credit_score_used\",\"decision\"],\"properties\":{\"decision\":{\"type\":\"string\",\"enum\":[\"approved\",\"denied\"]},\"credit_score_used\":{\"type\":\"number\"},\"denied_reasons\":{\"type\":\"array\",\"items\":{\"type\":\"string\",\"enum\":[\"insufficient_pay_stubs_provided\",\"low_credit_score\"]}}}}}}"}],"temperature":0.0,"system":"You
        are part of an agent implementation. Your task is to decide which command
        to run next.\n\nYou are working towards accomplishing the following goal:
        Review loan file\n\nYour behavior has been described to the person or agent
        that chose to run you as: Checks the LoanFile against all requirements in
        its CreditPolicy. Denies the LoanFile that has any unsatisfied requirements.\n\nYour
        inputs to this command have the following type:\n\n{\"type\":\"object\",\"required\":[\"loan_file\"],\"properties\":{\"loan_file\":{\"type\":\"object\",\"required\":[\"credit_scores\",\"loan_application\",\"pay_stubs\",\"state\"],\"properties\":{\"id\":{\"type\":\"number\"},\"loan_application\":{\"type\":\"object\",\"required\":[\"applicant\"],\"properties\":{\"applicant\":{\"type\":\"object\",\"required\":[\"name\"],\"properties\":{\"name\":{\"type\":\"string\"}}}}},\"state\":{\"type\":\"string\",\"enum\":[\"building_loan_file\",\"denied\",\"drafting_docs\",\"in_escrow\",\"in_review\",\"needs_review\",\"recorded\"]},\"pay_stubs\":{\"type\":\"array\",\"items\":{\"type\":\"object\",\"required\":[\"amount\",\"date\",\"employer\"],\"properties\":{\"amount\":{\"type\":\"number\",\"description\":\"Amount
        in dollars of the pay check\"},\"date\":{\"type\":\"string\",\"format\":\"date\",\"description\":\"Date
        the paycheck was issued\"},\"employer\":{\"type\":\"string\",\"description\":\"Name
        of the employer that issued this paycheck\"}}}},\"credit_scores\":{\"type\":\"array\",\"items\":{\"type\":\"object\",\"properties\":{\"score\":{\"type\":\"number\"},\"reporting_agency\":{\"type\":\"string\",\"enum\":[\"equifax\",\"experian\",\"transunion\"]}}}},\"underwriter_decision\":{\"type\":[\"object\",\"null\"],\"required\":[\"credit_score_used\",\"decision\"],\"properties\":{\"decision\":{\"type\":\"string\",\"enum\":[\"approved\",\"denied\"]},\"credit_score_used\":{\"type\":\"number\"},\"denied_reasons\":{\"type\":\"array\",\"items\":{\"type\":\"string\",\"enum\":[\"insufficient_pay_stubs_provided\",\"low_credit_score\"]}}}},\"credit_policy\":{\"type\":\"object\",\"required\":[\"credit_score_to_use\",\"institution\",\"minimum_credit_score\",\"minimum_pay_stub_count\"],\"properties\":{\"id\":{\"type\":\"number\"},\"institution\":{\"type\":\"string\"},\"minimum_pay_stub_count\":{\"type\":\"number\",\"description\":\"The
        loan file must have at least this many pay stubs.\"},\"minimum_credit_score\":{\"type\":\"number\"},\"credit_score_to_use\":{\"type\":\"string\",\"enum\":[\"median\",\"maximum\"],\"description\":\"If
        the scores are 500, 650, and 700, then maximum will compare the biggest (700)
        against minimum_credit_score and median will compare the median (650) against
        minimum_credit_score.\"}}}}}}}\n\nYou have been ran with the following inputs:\n\n{\"loan_file\":{\"id\":2,\"state\":\"needs_review\",\"pay_stubs\":[{\"amount\":3000,\"date\":\"2025-06-25\",\"employer\":\"Some
        Employer\"}],\"credit_scores\":[{\"reporting_agency\":\"experian\",\"score\":600},{\"reporting_agency\":\"equifax\",\"score\":650},{\"reporting_agency\":\"transunion\",\"score\":750}],\"loan_application\":{\"applicant\":{\"name\":\"Basil\"}},\"credit_policy\":{\"id\":2,\"institution\":\"Bank
        B\",\"minimum_credit_score\":700,\"credit_score_to_use\":\"maximum\",\"minimum_pay_stub_count\":2}}}\n\nYou
        will answer with the name of the next command to run and, if needed, its inputs.
        Choose whichever command is best to make progress towards accomplishing the
        current goal based on the progress made so far. If the goal has been accomplished
        then choose the NotifyUserThatCurrentGoalHasBeenAccomplished command. If you
        are stuck either due to errors or because you do not have the command you
        need to accomplish the goal, then choose GiveUp.\n\nYou can get more details
        about the inputs and result schemas for a specific command by choosing the
        DescribeCommand command.\n\nYour result type is described by the following
        JSON schema:\n\n{\"type\":\"object\",\"required\":[\"command\"],\"properties\":{\"command\":{\"type\":\"string\"},\"inputs\":{\"type\":[\"object\",\"null\"]}}}\n\nYou
        will reply with nothing more than the JSON that you''ve generated that adheres
        to this result type schema so that the calling code can successfully parse
        your answer."}'
    headers:
      Content-Type:
      - application/json
      X-Api-Key:
      - "<SCRUBBED_ANTHROPIC_API_KEY>"
      Anthropic-Version:
      - '2023-06-01'
      Accept-Encoding:
      - gzip;q=1.0,deflate;q=0.6,identity;q=0.3
      Accept:
      - "*/*"
      User-Agent:
      - Ruby
  response:
    status:
      code: 200
      message: OK
    headers:
      Date:
      - Wed, 23 Jul 2025 20:42:58 GMT
      Content-Type:
      - application/json
      Transfer-Encoding:
      - chunked
      Connection:
      - keep-alive
      Anthropic-Ratelimit-Input-Tokens-Limit:
      - '80000'
      Anthropic-Ratelimit-Input-Tokens-Remaining:
      - '80000'
      Anthropic-Ratelimit-Input-Tokens-Reset:
      - '2025-07-23T20:42:57Z'
      Anthropic-Ratelimit-Output-Tokens-Limit:
      - '16000'
      Anthropic-Ratelimit-Output-Tokens-Remaining:
      - '16000'
      Anthropic-Ratelimit-Output-Tokens-Reset:
      - '2025-07-23T20:42:58Z'
      Anthropic-Ratelimit-Requests-Limit:
      - '2000'
      Anthropic-Ratelimit-Requests-Remaining:
      - '1999'
      Anthropic-Ratelimit-Requests-Reset:
      - '2025-07-23T20:42:55Z'
      Anthropic-Ratelimit-Tokens-Limit:
      - '96000'
      Anthropic-Ratelimit-Tokens-Remaining:
      - '96000'
      Anthropic-Ratelimit-Tokens-Reset:
      - '2025-07-23T20:42:57Z'
      Request-Id:
      - req_011CRQbo5RmtNbmoZug6RHne
      Strict-Transport-Security:
      - max-age=31536000; includeSubDomains; preload
      Anthropic-Organization-Id:
      - 7a8e3751-3b70-4f90-a3ce-07f57c9d0bfc
      Via:
      - 1.1 google
      Cf-Cache-Status:
      - DYNAMIC
      X-Robots-Tag:
      - none
      Server:
      - cloudflare
      Cf-Ray:
      - 963e01cf9c36cf2b-SJC
    body:
      encoding: ASCII-8BIT
      string: '{"id":"msg_019K6QmixP1xrZCtrLD4TW6x","type":"message","role":"assistant","model":"claude-opus-4-20250514","content":[{"type":"text","text":"{\"command\":\"Foobara::Agent::ReviewLoanFile::NotifyUserThatCurrentGoalHasBeenAccomplished\",\"inputs\":{\"decision\":\"denied\",\"credit_score_used\":750,\"denied_reasons\":[\"insufficient_pay_stubs_provided\"]}}"}],"stop_reason":"end_turn","stop_sequence":null,"usage":{"input_tokens":2803,"cache_creation_input_tokens":0,"cache_read_input_tokens":0,"output_tokens":64,"service_tier":"standard"}}'
  recorded_at: Wed, 23 Jul 2025 20:42:58 GMT
- request:
    method: post
    uri: https://api.anthropic.com/v1/messages
    body:
      encoding: UTF-8
      string: '{"model":"claude-opus-4-20250514","max_tokens":1024,"messages":[{"role":"assistant","content":"{\"command\":\"Foobara::Agent::DescribeCommand\",\"inputs\":{\"command_name\":\"Foobara::Agent::ListCommands\"}}"},{"role":"user","content":"{\"success\":true,\"result\":{\"full_command_name\":\"Foobara::Agent::ListCommands\",\"description\":null,\"inputs_type\":{\"type\":\"object\"},\"result_type\":{\"type\":\"object\",\"required\":[\"agent_specific_commands\",\"user_provided_commands\"],\"properties\":{\"user_provided_commands\":{\"type\":\"array\",\"items\":{\"type\":\"string\"},\"description\":\"List
        of commands the user would like you to choose from to accomplish the goal\"},\"agent_specific_commands\":{\"type\":\"array\",\"items\":{\"type\":\"string\"},\"description\":\"Commands
        available to all agents to introspect or end the session\"}}}}}"},{"role":"assistant","content":"{\"command\":\"Foobara::Agent::ListCommands\"}"},{"role":"user","content":"{\"success\":true,\"result\":{\"user_provided_commands\":[\"FoobaraDemo::LoanOrigination::StartUnderwriterReview\",\"FoobaraDemo::LoanOrigination::DenyLoanFile\",\"FoobaraDemo::LoanOrigination::ApproveLoanFile\"],\"agent_specific_commands\":[\"Foobara::Agent::DescribeCommand\",\"Foobara::Agent::DescribeType\",\"Foobara::Agent::GiveUp\",\"Foobara::Agent::ListCommands\",\"Foobara::Agent::ReviewLoanFile::NotifyUserThatCurrentGoalHasBeenAccomplished\"]}}"}],"temperature":0.0,"system":"You
        are part of an agent implementation. Your task is to decide which command
        to run next.\n\nYou are working towards accomplishing the following goal:
        Review loan file\n\nYour behavior has been described to the person or agent
        that chose to run you as: Checks the LoanFile against all requirements in
        its CreditPolicy. Denies the LoanFile that has any unsatisfied requirements.\n\nYour
        inputs to this command have the following type:\n\n{\"type\":\"object\",\"required\":[\"loan_file\"],\"properties\":{\"loan_file\":{\"type\":\"object\",\"required\":[\"credit_scores\",\"loan_application\",\"pay_stubs\",\"state\"],\"properties\":{\"id\":{\"type\":\"number\"},\"loan_application\":{\"type\":\"object\",\"required\":[\"applicant\"],\"properties\":{\"applicant\":{\"type\":\"object\",\"required\":[\"name\"],\"properties\":{\"name\":{\"type\":\"string\"}}}}},\"state\":{\"type\":\"string\",\"enum\":[\"building_loan_file\",\"denied\",\"drafting_docs\",\"in_escrow\",\"in_review\",\"needs_review\",\"recorded\"]},\"pay_stubs\":{\"type\":\"array\",\"items\":{\"type\":\"object\",\"required\":[\"amount\",\"date\",\"employer\"],\"properties\":{\"amount\":{\"type\":\"number\",\"description\":\"Amount
        in dollars of the pay check\"},\"date\":{\"type\":\"string\",\"format\":\"date\",\"description\":\"Date
        the paycheck was issued\"},\"employer\":{\"type\":\"string\",\"description\":\"Name
        of the employer that issued this paycheck\"}}}},\"credit_scores\":{\"type\":\"array\",\"items\":{\"type\":\"object\",\"properties\":{\"score\":{\"type\":\"number\"},\"reporting_agency\":{\"type\":\"string\",\"enum\":[\"equifax\",\"experian\",\"transunion\"]}}}},\"underwriter_decision\":{\"type\":[\"object\",\"null\"],\"required\":[\"credit_score_used\",\"decision\"],\"properties\":{\"decision\":{\"type\":\"string\",\"enum\":[\"approved\",\"denied\"]},\"credit_score_used\":{\"type\":\"number\"},\"denied_reasons\":{\"type\":\"array\",\"items\":{\"type\":\"string\",\"enum\":[\"insufficient_pay_stubs_provided\",\"low_credit_score\"]}}}},\"credit_policy\":{\"type\":\"object\",\"required\":[\"credit_score_to_use\",\"institution\",\"minimum_credit_score\",\"minimum_pay_stub_count\"],\"properties\":{\"id\":{\"type\":\"number\"},\"institution\":{\"type\":\"string\"},\"minimum_pay_stub_count\":{\"type\":\"number\",\"description\":\"The
        loan file must have at least this many pay stubs.\"},\"minimum_credit_score\":{\"type\":\"number\"},\"credit_score_to_use\":{\"type\":\"string\",\"enum\":[\"median\",\"maximum\"],\"description\":\"If
        the scores are 500, 650, and 700, then maximum will compare the biggest (700)
        against minimum_credit_score and median will compare the median (650) against
        minimum_credit_score.\"}}}}}}}\n\nYou have been ran with the following inputs:\n\n{\"loan_file\":{\"id\":3,\"state\":\"needs_review\",\"pay_stubs\":[{\"amount\":3000,\"date\":\"2025-06-25\",\"employer\":\"Some
        Employer\"}],\"credit_scores\":[{\"reporting_agency\":\"experian\",\"score\":600},{\"reporting_agency\":\"equifax\",\"score\":650},{\"reporting_agency\":\"transunion\",\"score\":750}],\"loan_application\":{\"applicant\":{\"name\":\"Fumiko\"}},\"credit_policy\":{\"id\":3,\"institution\":\"Bank
        C\",\"minimum_credit_score\":700,\"credit_score_to_use\":\"maximum\",\"minimum_pay_stub_count\":1}}}\n\nYou
        will answer with the name of the next command to run and, if needed, its inputs.
        Choose whichever command is best to make progress towards accomplishing the
        current goal based on the progress made so far. If the goal has been accomplished
        then choose the NotifyUserThatCurrentGoalHasBeenAccomplished command. If you
        are stuck either due to errors or because you do not have the command you
        need to accomplish the goal, then choose GiveUp.\n\nYou can get more details
        about the inputs and result schemas for a specific command by choosing the
        DescribeCommand command.\n\nYour result type is described by the following
        JSON schema:\n\n{\"type\":\"object\",\"required\":[\"command\"],\"properties\":{\"command\":{\"type\":\"string\"},\"inputs\":{\"type\":[\"object\",\"null\"]}}}\n\nYou
        will reply with nothing more than the JSON that you''ve generated that adheres
        to this result type schema so that the calling code can successfully parse
        your answer."}'
    headers:
      Content-Type:
      - application/json
      X-Api-Key:
      - "<SCRUBBED_ANTHROPIC_API_KEY>"
      Anthropic-Version:
      - '2023-06-01'
      Accept-Encoding:
      - gzip;q=1.0,deflate;q=0.6,identity;q=0.3
      Accept:
      - "*/*"
      User-Agent:
      - Ruby
  response:
    status:
      code: 200
      message: OK
    headers:
      Date:
      - Wed, 23 Jul 2025 20:43:04 GMT
      Content-Type:
      - application/json
      Transfer-Encoding:
      - chunked
      Connection:
      - keep-alive
      Anthropic-Ratelimit-Input-Tokens-Limit:
      - '80000'
      Anthropic-Ratelimit-Input-Tokens-Remaining:
      - '80000'
      Anthropic-Ratelimit-Input-Tokens-Reset:
      - '2025-07-23T20:43:00Z'
      Anthropic-Ratelimit-Output-Tokens-Limit:
      - '16000'
      Anthropic-Ratelimit-Output-Tokens-Remaining:
      - '16000'
      Anthropic-Ratelimit-Output-Tokens-Reset:
      - '2025-07-23T20:43:04Z'
      Anthropic-Ratelimit-Requests-Limit:
      - '2000'
      Anthropic-Ratelimit-Requests-Remaining:
      - '1999'
      Anthropic-Ratelimit-Requests-Reset:
      - '2025-07-23T20:42:58Z'
      Anthropic-Ratelimit-Tokens-Limit:
      - '96000'
      Anthropic-Ratelimit-Tokens-Remaining:
      - '96000'
      Anthropic-Ratelimit-Tokens-Reset:
      - '2025-07-23T20:43:00Z'
      Request-Id:
      - req_011CRQboKkVFx9VpSFDGG4cp
      Strict-Transport-Security:
      - max-age=31536000; includeSubDomains; preload
      Anthropic-Organization-Id:
      - 7a8e3751-3b70-4f90-a3ce-07f57c9d0bfc
      Via:
      - 1.1 google
      Cf-Cache-Status:
      - DYNAMIC
      X-Robots-Tag:
      - none
      Server:
      - cloudflare
      Cf-Ray:
      - 963e01e45e21fa1a-SJC
    body:
      encoding: ASCII-8BIT
      string: '{"id":"msg_01Bk98nQeXaMhH8bQ4iSp5AL","type":"message","role":"assistant","model":"claude-opus-4-20250514","content":[{"type":"text","text":"I
        need to review the loan file against the credit policy requirements. Let me
        check the details:\n\n**Loan File #3:**\n- Credit scores: Experian 600, Equifax
        650, TransUnion 750\n- Credit policy uses \"maximum\" score, which would be
        750\n- Minimum required credit score: 700\n- Pay stubs provided: 1 (meets
        minimum requirement of 1)\n\nSince the maximum credit score (750) exceeds
        the minimum requirement (700) and the pay stub count meets the requirement,
        this loan file satisfies all requirements and should be approved.\n\n{\"command\":\"FoobaraDemo::LoanOrigination::ApproveLoanFile\",\"inputs\":{\"loan_file_id\":3}}"}],"stop_reason":"end_turn","stop_sequence":null,"usage":{"input_tokens":1375,"cache_creation_input_tokens":0,"cache_read_input_tokens":0,"output_tokens":165,"service_tier":"standard"}}'
  recorded_at: Wed, 23 Jul 2025 20:43:04 GMT
- request:
    method: post
    uri: https://api.anthropic.com/v1/messages
    body:
      encoding: UTF-8
      string: '{"model":"claude-opus-4-20250514","max_tokens":1024,"messages":[{"role":"assistant","content":"{\"command\":\"Foobara::Agent::DescribeCommand\",\"inputs\":{\"command_name\":\"Foobara::Agent::ListCommands\"}}"},{"role":"user","content":"{\"success\":true,\"result\":{\"full_command_name\":\"Foobara::Agent::ListCommands\",\"description\":null,\"inputs_type\":{\"type\":\"object\"},\"result_type\":{\"type\":\"object\",\"required\":[\"agent_specific_commands\",\"user_provided_commands\"],\"properties\":{\"user_provided_commands\":{\"type\":\"array\",\"items\":{\"type\":\"string\"},\"description\":\"List
        of commands the user would like you to choose from to accomplish the goal\"},\"agent_specific_commands\":{\"type\":\"array\",\"items\":{\"type\":\"string\"},\"description\":\"Commands
        available to all agents to introspect or end the session\"}}}}}"},{"role":"assistant","content":"{\"command\":\"Foobara::Agent::ListCommands\"}"},{"role":"user","content":"{\"success\":true,\"result\":{\"user_provided_commands\":[\"FoobaraDemo::LoanOrigination::StartUnderwriterReview\",\"FoobaraDemo::LoanOrigination::DenyLoanFile\",\"FoobaraDemo::LoanOrigination::ApproveLoanFile\"],\"agent_specific_commands\":[\"Foobara::Agent::DescribeCommand\",\"Foobara::Agent::DescribeType\",\"Foobara::Agent::GiveUp\",\"Foobara::Agent::ListCommands\",\"Foobara::Agent::ReviewLoanFile::NotifyUserThatCurrentGoalHasBeenAccomplished\"]}}"},{"role":"assistant","content":"{\"command\":\"Foobara::Agent::DetermineNextCommandNameAndInputs\",\"inputs\":{\"agent\":\"#<Foobara::Agent:0x00007fb77c2dec50>\",\"llm_model\":\"claude-opus-4-20250514\",\"pass_aggregates_to_llm\":true}}"},{"role":"user","content":"{\"success\":false,\"errors_hash\":{\"runtime.could_not_parse_result_json\":{\"key\":\"runtime.could_not_parse_result_json\",\"path\":[],\"runtime_path\":[],\"category\":\"runtime\",\"symbol\":\"could_not_parse_result_json\",\"message\":\"Could
        not parse result JSON: unexpected token ''I'' at line 1 column 1\",\"context\":{\"raw_answer\":\"I
        need to review the loan file against the credit policy requirements. Let me
        check the details:\\n\\n**Loan File #3:**\\n- Credit scores: Experian 600,
        Equifax 650, TransUnion 750\\n- Credit policy uses \\\"maximum\\\" score,
        which would be 750\\n- Minimum required credit score: 700\\n- Pay stubs provided:
        1 (meets minimum requirement of 1)\\n\\nSince the maximum credit score (750)
        exceeds the minimum requirement (700) and the pay stub count meets the requirement,
        this loan file satisfies all requirements and should be approved.\\n\\n{\\\"command\\\":\\\"FoobaraDemo::LoanOrigination::ApproveLoanFile\\\",\\\"inputs\\\":{\\\"loan_file_id\\\":3}}\",\"stripped_answer\":\"I
        need to review the loan file against the credit policy requirements. Let me
        check the details:\\n\\n**Loan File #3:**\\n- Credit scores: Experian 600,
        Equifax 650, TransUnion 750\\n- Credit policy uses \\\"maximum\\\" score,
        which would be 750\\n- Minimum required credit score: 700\\n- Pay stubs provided:
        1 (meets minimum requirement of 1)\\n\\nSince the maximum credit score (750)
        exceeds the minimum requirement (700) and the pay stub count meets the requirement,
        this loan file satisfies all requirements and should be approved.\\n\\n{\\\"command\\\":\\\"FoobaraDemo::LoanOrigination::ApproveLoanFile\\\",\\\"inputs\\\":{\\\"loan_file_id\\\":3}}\"},\"is_fatal\":false}}}"}],"temperature":0.0,"system":"You
        are part of an agent implementation. Your task is to decide which command
        to run next.\n\nYou are working towards accomplishing the following goal:
        Review loan file\n\nYour behavior has been described to the person or agent
        that chose to run you as: Checks the LoanFile against all requirements in
        its CreditPolicy. Denies the LoanFile that has any unsatisfied requirements.\n\nYour
        inputs to this command have the following type:\n\n{\"type\":\"object\",\"required\":[\"loan_file\"],\"properties\":{\"loan_file\":{\"type\":\"object\",\"required\":[\"credit_scores\",\"loan_application\",\"pay_stubs\",\"state\"],\"properties\":{\"id\":{\"type\":\"number\"},\"loan_application\":{\"type\":\"object\",\"required\":[\"applicant\"],\"properties\":{\"applicant\":{\"type\":\"object\",\"required\":[\"name\"],\"properties\":{\"name\":{\"type\":\"string\"}}}}},\"state\":{\"type\":\"string\",\"enum\":[\"building_loan_file\",\"denied\",\"drafting_docs\",\"in_escrow\",\"in_review\",\"needs_review\",\"recorded\"]},\"pay_stubs\":{\"type\":\"array\",\"items\":{\"type\":\"object\",\"required\":[\"amount\",\"date\",\"employer\"],\"properties\":{\"amount\":{\"type\":\"number\",\"description\":\"Amount
        in dollars of the pay check\"},\"date\":{\"type\":\"string\",\"format\":\"date\",\"description\":\"Date
        the paycheck was issued\"},\"employer\":{\"type\":\"string\",\"description\":\"Name
        of the employer that issued this paycheck\"}}}},\"credit_scores\":{\"type\":\"array\",\"items\":{\"type\":\"object\",\"properties\":{\"score\":{\"type\":\"number\"},\"reporting_agency\":{\"type\":\"string\",\"enum\":[\"equifax\",\"experian\",\"transunion\"]}}}},\"underwriter_decision\":{\"type\":[\"object\",\"null\"],\"required\":[\"credit_score_used\",\"decision\"],\"properties\":{\"decision\":{\"type\":\"string\",\"enum\":[\"approved\",\"denied\"]},\"credit_score_used\":{\"type\":\"number\"},\"denied_reasons\":{\"type\":\"array\",\"items\":{\"type\":\"string\",\"enum\":[\"insufficient_pay_stubs_provided\",\"low_credit_score\"]}}}},\"credit_policy\":{\"type\":\"object\",\"required\":[\"credit_score_to_use\",\"institution\",\"minimum_credit_score\",\"minimum_pay_stub_count\"],\"properties\":{\"id\":{\"type\":\"number\"},\"institution\":{\"type\":\"string\"},\"minimum_pay_stub_count\":{\"type\":\"number\",\"description\":\"The
        loan file must have at least this many pay stubs.\"},\"minimum_credit_score\":{\"type\":\"number\"},\"credit_score_to_use\":{\"type\":\"string\",\"enum\":[\"median\",\"maximum\"],\"description\":\"If
        the scores are 500, 650, and 700, then maximum will compare the biggest (700)
        against minimum_credit_score and median will compare the median (650) against
        minimum_credit_score.\"}}}}}}}\n\nYou have been ran with the following inputs:\n\n{\"loan_file\":{\"id\":3,\"state\":\"needs_review\",\"pay_stubs\":[{\"amount\":3000,\"date\":\"2025-06-25\",\"employer\":\"Some
        Employer\"}],\"credit_scores\":[{\"reporting_agency\":\"experian\",\"score\":600},{\"reporting_agency\":\"equifax\",\"score\":650},{\"reporting_agency\":\"transunion\",\"score\":750}],\"loan_application\":{\"applicant\":{\"name\":\"Fumiko\"}},\"credit_policy\":{\"id\":3,\"institution\":\"Bank
        C\",\"minimum_credit_score\":700,\"credit_score_to_use\":\"maximum\",\"minimum_pay_stub_count\":1}}}\n\nYou
        will answer with the name of the next command to run and, if needed, its inputs.
        Choose whichever command is best to make progress towards accomplishing the
        current goal based on the progress made so far. If the goal has been accomplished
        then choose the NotifyUserThatCurrentGoalHasBeenAccomplished command. If you
        are stuck either due to errors or because you do not have the command you
        need to accomplish the goal, then choose GiveUp.\n\nYou can get more details
        about the inputs and result schemas for a specific command by choosing the
        DescribeCommand command.\n\nYour result type is described by the following
        JSON schema:\n\n{\"type\":\"object\",\"required\":[\"command\"],\"properties\":{\"command\":{\"type\":\"string\"},\"inputs\":{\"type\":[\"object\",\"null\"]}}}\n\nYou
        will reply with nothing more than the JSON that you''ve generated that adheres
        to this result type schema so that the calling code can successfully parse
        your answer."}'
    headers:
      Content-Type:
      - application/json
      X-Api-Key:
      - "<SCRUBBED_ANTHROPIC_API_KEY>"
      Anthropic-Version:
      - '2023-06-01'
      Accept-Encoding:
      - gzip;q=1.0,deflate;q=0.6,identity;q=0.3
      Accept:
      - "*/*"
      User-Agent:
      - Ruby
  response:
    status:
      code: 200
      message: OK
    headers:
      Date:
      - Wed, 23 Jul 2025 20:43:14 GMT
      Content-Type:
      - application/json
      Transfer-Encoding:
      - chunked
      Connection:
      - keep-alive
      Anthropic-Ratelimit-Input-Tokens-Limit:
      - '80000'
      Anthropic-Ratelimit-Input-Tokens-Remaining:
      - '80000'
      Anthropic-Ratelimit-Input-Tokens-Reset:
      - '2025-07-23T20:43:13Z'
      Anthropic-Ratelimit-Output-Tokens-Limit:
      - '16000'
      Anthropic-Ratelimit-Output-Tokens-Remaining:
      - '16000'
      Anthropic-Ratelimit-Output-Tokens-Reset:
      - '2025-07-23T20:43:14Z'
      Anthropic-Ratelimit-Requests-Limit:
      - '2000'
      Anthropic-Ratelimit-Requests-Remaining:
      - '1999'
      Anthropic-Ratelimit-Requests-Reset:
      - '2025-07-23T20:43:04Z'
      Anthropic-Ratelimit-Tokens-Limit:
      - '96000'
      Anthropic-Ratelimit-Tokens-Remaining:
      - '96000'
      Anthropic-Ratelimit-Tokens-Reset:
      - '2025-07-23T20:43:13Z'
      Request-Id:
      - req_011CRQbojuYR7n1NZjECxeqy
      Strict-Transport-Security:
      - max-age=31536000; includeSubDomains; preload
      Anthropic-Organization-Id:
      - 7a8e3751-3b70-4f90-a3ce-07f57c9d0bfc
      Via:
      - 1.1 google
      Cf-Cache-Status:
      - DYNAMIC
      X-Robots-Tag:
      - none
      Server:
      - cloudflare
      Cf-Ray:
      - 963e0207bb56945e-SJC
    body:
      encoding: ASCII-8BIT
      string: '{"id":"msg_01JmApDNeefKbdqQeP1Aw7ps","type":"message","role":"assistant","model":"claude-opus-4-20250514","content":[{"type":"text","text":"{\"command\":\"FoobaraDemo::LoanOrigination::ApproveLoanFile\",\"inputs\":{\"loan_file_id\":3}}"}],"stop_reason":"end_turn","stop_sequence":null,"usage":{"input_tokens":1917,"cache_creation_input_tokens":0,"cache_read_input_tokens":0,"output_tokens":34,"service_tier":"standard"}}'
  recorded_at: Wed, 23 Jul 2025 20:43:14 GMT
- request:
    method: post
    uri: https://api.anthropic.com/v1/messages
    body:
      encoding: UTF-8
      string: '{"model":"claude-opus-4-20250514","max_tokens":1024,"messages":[{"role":"assistant","content":"{\"command\":\"Foobara::Agent::DescribeCommand\",\"inputs\":{\"command_name\":\"Foobara::Agent::ListCommands\"}}"},{"role":"user","content":"{\"success\":true,\"result\":{\"full_command_name\":\"Foobara::Agent::ListCommands\",\"description\":null,\"inputs_type\":{\"type\":\"object\"},\"result_type\":{\"type\":\"object\",\"required\":[\"agent_specific_commands\",\"user_provided_commands\"],\"properties\":{\"user_provided_commands\":{\"type\":\"array\",\"items\":{\"type\":\"string\"},\"description\":\"List
        of commands the user would like you to choose from to accomplish the goal\"},\"agent_specific_commands\":{\"type\":\"array\",\"items\":{\"type\":\"string\"},\"description\":\"Commands
        available to all agents to introspect or end the session\"}}}}}"},{"role":"assistant","content":"{\"command\":\"Foobara::Agent::ListCommands\"}"},{"role":"user","content":"{\"success\":true,\"result\":{\"user_provided_commands\":[\"FoobaraDemo::LoanOrigination::StartUnderwriterReview\",\"FoobaraDemo::LoanOrigination::DenyLoanFile\",\"FoobaraDemo::LoanOrigination::ApproveLoanFile\"],\"agent_specific_commands\":[\"Foobara::Agent::DescribeCommand\",\"Foobara::Agent::DescribeType\",\"Foobara::Agent::GiveUp\",\"Foobara::Agent::ListCommands\",\"Foobara::Agent::ReviewLoanFile::NotifyUserThatCurrentGoalHasBeenAccomplished\"]}}"},{"role":"assistant","content":"{\"command\":\"Foobara::Agent::DetermineNextCommandNameAndInputs\",\"inputs\":{\"agent\":\"#<Foobara::Agent:0x00007fb77c2dec50>\",\"llm_model\":\"claude-opus-4-20250514\",\"pass_aggregates_to_llm\":true}}"},{"role":"user","content":"{\"success\":false,\"errors_hash\":{\"runtime.could_not_parse_result_json\":{\"key\":\"runtime.could_not_parse_result_json\",\"path\":[],\"runtime_path\":[],\"category\":\"runtime\",\"symbol\":\"could_not_parse_result_json\",\"message\":\"Could
        not parse result JSON: unexpected token ''I'' at line 1 column 1\",\"context\":{\"raw_answer\":\"I
        need to review the loan file against the credit policy requirements. Let me
        check the details:\\n\\n**Loan File #3:**\\n- Credit scores: Experian 600,
        Equifax 650, TransUnion 750\\n- Credit policy uses \\\"maximum\\\" score,
        which would be 750\\n- Minimum required credit score: 700\\n- Pay stubs provided:
        1 (meets minimum requirement of 1)\\n\\nSince the maximum credit score (750)
        exceeds the minimum requirement (700) and the pay stub count meets the requirement,
        this loan file satisfies all requirements and should be approved.\\n\\n{\\\"command\\\":\\\"FoobaraDemo::LoanOrigination::ApproveLoanFile\\\",\\\"inputs\\\":{\\\"loan_file_id\\\":3}}\",\"stripped_answer\":\"I
        need to review the loan file against the credit policy requirements. Let me
        check the details:\\n\\n**Loan File #3:**\\n- Credit scores: Experian 600,
        Equifax 650, TransUnion 750\\n- Credit policy uses \\\"maximum\\\" score,
        which would be 750\\n- Minimum required credit score: 700\\n- Pay stubs provided:
        1 (meets minimum requirement of 1)\\n\\nSince the maximum credit score (750)
        exceeds the minimum requirement (700) and the pay stub count meets the requirement,
        this loan file satisfies all requirements and should be approved.\\n\\n{\\\"command\\\":\\\"FoobaraDemo::LoanOrigination::ApproveLoanFile\\\",\\\"inputs\\\":{\\\"loan_file_id\\\":3}}\"},\"is_fatal\":false}}}"},{"role":"assistant","content":"{\"command\":\"Foobara::Agent::DescribeCommand\",\"inputs\":{\"command_name\":\"FoobaraDemo::LoanOrigination::ApproveLoanFile\"}}"},{"role":"user","content":"{\"success\":true,\"result\":{\"full_command_name\":\"FoobaraDemo::LoanOrigination::ApproveLoanFile\",\"description\":null,\"inputs_type\":{\"type\":\"object\",\"required\":[\"credit_score_used\",\"loan_file\"],\"properties\":{\"credit_score_used\":{\"type\":\"number\"},\"loan_file\":{\"type\":\"number\",\"description\":\"LoanFile
        id\"}}}}}"}],"temperature":0.0,"system":"You are part of an agent implementation.
        Your task is to decide which command to run next.\n\nYou are working towards
        accomplishing the following goal: Review loan file\n\nYour behavior has been
        described to the person or agent that chose to run you as: Checks the LoanFile
        against all requirements in its CreditPolicy. Denies the LoanFile that has
        any unsatisfied requirements.\n\nYour inputs to this command have the following
        type:\n\n{\"type\":\"object\",\"required\":[\"loan_file\"],\"properties\":{\"loan_file\":{\"type\":\"object\",\"required\":[\"credit_scores\",\"loan_application\",\"pay_stubs\",\"state\"],\"properties\":{\"id\":{\"type\":\"number\"},\"loan_application\":{\"type\":\"object\",\"required\":[\"applicant\"],\"properties\":{\"applicant\":{\"type\":\"object\",\"required\":[\"name\"],\"properties\":{\"name\":{\"type\":\"string\"}}}}},\"state\":{\"type\":\"string\",\"enum\":[\"building_loan_file\",\"denied\",\"drafting_docs\",\"in_escrow\",\"in_review\",\"needs_review\",\"recorded\"]},\"pay_stubs\":{\"type\":\"array\",\"items\":{\"type\":\"object\",\"required\":[\"amount\",\"date\",\"employer\"],\"properties\":{\"amount\":{\"type\":\"number\",\"description\":\"Amount
        in dollars of the pay check\"},\"date\":{\"type\":\"string\",\"format\":\"date\",\"description\":\"Date
        the paycheck was issued\"},\"employer\":{\"type\":\"string\",\"description\":\"Name
        of the employer that issued this paycheck\"}}}},\"credit_scores\":{\"type\":\"array\",\"items\":{\"type\":\"object\",\"properties\":{\"score\":{\"type\":\"number\"},\"reporting_agency\":{\"type\":\"string\",\"enum\":[\"equifax\",\"experian\",\"transunion\"]}}}},\"underwriter_decision\":{\"type\":[\"object\",\"null\"],\"required\":[\"credit_score_used\",\"decision\"],\"properties\":{\"decision\":{\"type\":\"string\",\"enum\":[\"approved\",\"denied\"]},\"credit_score_used\":{\"type\":\"number\"},\"denied_reasons\":{\"type\":\"array\",\"items\":{\"type\":\"string\",\"enum\":[\"insufficient_pay_stubs_provided\",\"low_credit_score\"]}}}},\"credit_policy\":{\"type\":\"object\",\"required\":[\"credit_score_to_use\",\"institution\",\"minimum_credit_score\",\"minimum_pay_stub_count\"],\"properties\":{\"id\":{\"type\":\"number\"},\"institution\":{\"type\":\"string\"},\"minimum_pay_stub_count\":{\"type\":\"number\",\"description\":\"The
        loan file must have at least this many pay stubs.\"},\"minimum_credit_score\":{\"type\":\"number\"},\"credit_score_to_use\":{\"type\":\"string\",\"enum\":[\"median\",\"maximum\"],\"description\":\"If
        the scores are 500, 650, and 700, then maximum will compare the biggest (700)
        against minimum_credit_score and median will compare the median (650) against
        minimum_credit_score.\"}}}}}}}\n\nYou have been ran with the following inputs:\n\n{\"loan_file\":{\"id\":3,\"state\":\"needs_review\",\"pay_stubs\":[{\"amount\":3000,\"date\":\"2025-06-25\",\"employer\":\"Some
        Employer\"}],\"credit_scores\":[{\"reporting_agency\":\"experian\",\"score\":600},{\"reporting_agency\":\"equifax\",\"score\":650},{\"reporting_agency\":\"transunion\",\"score\":750}],\"loan_application\":{\"applicant\":{\"name\":\"Fumiko\"}},\"credit_policy\":{\"id\":3,\"institution\":\"Bank
        C\",\"minimum_credit_score\":700,\"credit_score_to_use\":\"maximum\",\"minimum_pay_stub_count\":1}}}\n\nYou
        will answer with the name of the next command to run and, if needed, its inputs.
        Choose whichever command is best to make progress towards accomplishing the
        current goal based on the progress made so far. If the goal has been accomplished
        then choose the NotifyUserThatCurrentGoalHasBeenAccomplished command. If you
        are stuck either due to errors or because you do not have the command you
        need to accomplish the goal, then choose GiveUp.\n\nYou can get more details
        about the inputs and result schemas for a specific command by choosing the
        DescribeCommand command.\n\nYour result type is described by the following
        JSON schema:\n\n{\"type\":\"object\",\"required\":[\"command\"],\"properties\":{\"command\":{\"type\":\"string\"},\"inputs\":{\"type\":[\"object\",\"null\"]}}}\n\nYou
        will reply with nothing more than the JSON that you''ve generated that adheres
        to this result type schema so that the calling code can successfully parse
        your answer."}'
    headers:
      Content-Type:
      - application/json
      X-Api-Key:
      - "<SCRUBBED_ANTHROPIC_API_KEY>"
      Anthropic-Version:
      - '2023-06-01'
      Accept-Encoding:
      - gzip;q=1.0,deflate;q=0.6,identity;q=0.3
      Accept:
      - "*/*"
      User-Agent:
      - Ruby
  response:
    status:
      code: 200
      message: OK
    headers:
      Date:
      - Wed, 23 Jul 2025 20:43:17 GMT
      Content-Type:
      - application/json
      Transfer-Encoding:
      - chunked
      Connection:
      - keep-alive
      Anthropic-Ratelimit-Input-Tokens-Limit:
      - '80000'
      Anthropic-Ratelimit-Input-Tokens-Remaining:
      - '80000'
      Anthropic-Ratelimit-Input-Tokens-Reset:
      - '2025-07-23T20:43:16Z'
      Anthropic-Ratelimit-Output-Tokens-Limit:
      - '16000'
      Anthropic-Ratelimit-Output-Tokens-Remaining:
      - '16000'
      Anthropic-Ratelimit-Output-Tokens-Reset:
      - '2025-07-23T20:43:17Z'
      Anthropic-Ratelimit-Requests-Limit:
      - '2000'
      Anthropic-Ratelimit-Requests-Remaining:
      - '1999'
      Anthropic-Ratelimit-Requests-Reset:
      - '2025-07-23T20:43:14Z'
      Anthropic-Ratelimit-Tokens-Limit:
      - '96000'
      Anthropic-Ratelimit-Tokens-Remaining:
      - '96000'
      Anthropic-Ratelimit-Tokens-Reset:
      - '2025-07-23T20:43:16Z'
      Request-Id:
      - req_011CRQbpVrymddHRWXeXWJWK
      Strict-Transport-Security:
      - max-age=31536000; includeSubDomains; preload
      Anthropic-Organization-Id:
      - 7a8e3751-3b70-4f90-a3ce-07f57c9d0bfc
      Via:
      - 1.1 google
      Cf-Cache-Status:
      - DYNAMIC
      X-Robots-Tag:
      - none
      Server:
      - cloudflare
      Cf-Ray:
      - 963e02481b7315be-SJC
    body:
      encoding: ASCII-8BIT
      string: '{"id":"msg_015jb8xmU1upLXf5FyokPYqy","type":"message","role":"assistant","model":"claude-opus-4-20250514","content":[{"type":"text","text":"{\"command\":\"FoobaraDemo::LoanOrigination::ApproveLoanFile\",\"inputs\":{\"loan_file\":3,\"credit_score_used\":750}}"}],"stop_reason":"end_turn","stop_sequence":null,"usage":{"input_tokens":2054,"cache_creation_input_tokens":0,"cache_read_input_tokens":0,"output_tokens":40,"service_tier":"standard"}}'
  recorded_at: Wed, 23 Jul 2025 20:43:17 GMT
- request:
    method: post
    uri: https://api.anthropic.com/v1/messages
    body:
      encoding: UTF-8
      string: '{"model":"claude-opus-4-20250514","max_tokens":1024,"messages":[{"role":"assistant","content":"{\"command\":\"Foobara::Agent::DescribeCommand\",\"inputs\":{\"command_name\":\"Foobara::Agent::ListCommands\"}}"},{"role":"user","content":"{\"success\":true,\"result\":{\"full_command_name\":\"Foobara::Agent::ListCommands\",\"description\":null,\"inputs_type\":{\"type\":\"object\"},\"result_type\":{\"type\":\"object\",\"required\":[\"agent_specific_commands\",\"user_provided_commands\"],\"properties\":{\"user_provided_commands\":{\"type\":\"array\",\"items\":{\"type\":\"string\"},\"description\":\"List
        of commands the user would like you to choose from to accomplish the goal\"},\"agent_specific_commands\":{\"type\":\"array\",\"items\":{\"type\":\"string\"},\"description\":\"Commands
        available to all agents to introspect or end the session\"}}}}}"},{"role":"assistant","content":"{\"command\":\"Foobara::Agent::ListCommands\"}"},{"role":"user","content":"{\"success\":true,\"result\":{\"user_provided_commands\":[\"FoobaraDemo::LoanOrigination::StartUnderwriterReview\",\"FoobaraDemo::LoanOrigination::DenyLoanFile\",\"FoobaraDemo::LoanOrigination::ApproveLoanFile\"],\"agent_specific_commands\":[\"Foobara::Agent::DescribeCommand\",\"Foobara::Agent::DescribeType\",\"Foobara::Agent::GiveUp\",\"Foobara::Agent::ListCommands\",\"Foobara::Agent::ReviewLoanFile::NotifyUserThatCurrentGoalHasBeenAccomplished\"]}}"},{"role":"assistant","content":"{\"command\":\"Foobara::Agent::DetermineNextCommandNameAndInputs\",\"inputs\":{\"agent\":\"#<Foobara::Agent:0x00007fb77c2dec50>\",\"llm_model\":\"claude-opus-4-20250514\",\"pass_aggregates_to_llm\":true}}"},{"role":"user","content":"{\"success\":false,\"errors_hash\":{\"runtime.could_not_parse_result_json\":{\"key\":\"runtime.could_not_parse_result_json\",\"path\":[],\"runtime_path\":[],\"category\":\"runtime\",\"symbol\":\"could_not_parse_result_json\",\"message\":\"Could
        not parse result JSON: unexpected token ''I'' at line 1 column 1\",\"context\":{\"raw_answer\":\"I
        need to review the loan file against the credit policy requirements. Let me
        check the details:\\n\\n**Loan File #3:**\\n- Credit scores: Experian 600,
        Equifax 650, TransUnion 750\\n- Credit policy uses \\\"maximum\\\" score,
        which would be 750\\n- Minimum required credit score: 700\\n- Pay stubs provided:
        1 (meets minimum requirement of 1)\\n\\nSince the maximum credit score (750)
        exceeds the minimum requirement (700) and the pay stub count meets the requirement,
        this loan file satisfies all requirements and should be approved.\\n\\n{\\\"command\\\":\\\"FoobaraDemo::LoanOrigination::ApproveLoanFile\\\",\\\"inputs\\\":{\\\"loan_file_id\\\":3}}\",\"stripped_answer\":\"I
        need to review the loan file against the credit policy requirements. Let me
        check the details:\\n\\n**Loan File #3:**\\n- Credit scores: Experian 600,
        Equifax 650, TransUnion 750\\n- Credit policy uses \\\"maximum\\\" score,
        which would be 750\\n- Minimum required credit score: 700\\n- Pay stubs provided:
        1 (meets minimum requirement of 1)\\n\\nSince the maximum credit score (750)
        exceeds the minimum requirement (700) and the pay stub count meets the requirement,
        this loan file satisfies all requirements and should be approved.\\n\\n{\\\"command\\\":\\\"FoobaraDemo::LoanOrigination::ApproveLoanFile\\\",\\\"inputs\\\":{\\\"loan_file_id\\\":3}}\"},\"is_fatal\":false}}}"},{"role":"assistant","content":"{\"command\":\"Foobara::Agent::DescribeCommand\",\"inputs\":{\"command_name\":\"FoobaraDemo::LoanOrigination::ApproveLoanFile\"}}"},{"role":"user","content":"{\"success\":true,\"result\":{\"full_command_name\":\"FoobaraDemo::LoanOrigination::ApproveLoanFile\",\"description\":null,\"inputs_type\":{\"type\":\"object\",\"required\":[\"credit_score_used\",\"loan_file\"],\"properties\":{\"credit_score_used\":{\"type\":\"number\"},\"loan_file\":{\"type\":\"number\",\"description\":\"LoanFile
        id\"}}}}}"},{"role":"assistant","content":"{\"command\":\"FoobaraDemo::LoanOrigination::ApproveLoanFile\",\"inputs\":{\"loan_file\":3,\"credit_score_used\":750}}"},{"role":"user","content":"{\"success\":false,\"errors_hash\":{\"data.loan_file.cannot_transition_state\":{\"key\":\"data.loan_file.cannot_transition_state\",\"path\":[\"loan_file\"],\"runtime_path\":[],\"category\":\"data\",\"symbol\":\"cannot_transition_state\",\"message\":\"Cannot
        perform approve transition for loan file 3 from needs_review. Expected state
        to be one of: [:in_review]. Did you forget to start the review?\",\"context\":{\"loan_file_id\":3,\"current_state\":\"needs_review\",\"required_states\":[\"in_review\"],\"attempted_transition\":\"approve\"},\"is_fatal\":false}}}"}],"temperature":0.0,"system":"You
        are part of an agent implementation. Your task is to decide which command
        to run next.\n\nYou are working towards accomplishing the following goal:
        Review loan file\n\nYour behavior has been described to the person or agent
        that chose to run you as: Checks the LoanFile against all requirements in
        its CreditPolicy. Denies the LoanFile that has any unsatisfied requirements.\n\nYour
        inputs to this command have the following type:\n\n{\"type\":\"object\",\"required\":[\"loan_file\"],\"properties\":{\"loan_file\":{\"type\":\"object\",\"required\":[\"credit_scores\",\"loan_application\",\"pay_stubs\",\"state\"],\"properties\":{\"id\":{\"type\":\"number\"},\"loan_application\":{\"type\":\"object\",\"required\":[\"applicant\"],\"properties\":{\"applicant\":{\"type\":\"object\",\"required\":[\"name\"],\"properties\":{\"name\":{\"type\":\"string\"}}}}},\"state\":{\"type\":\"string\",\"enum\":[\"building_loan_file\",\"denied\",\"drafting_docs\",\"in_escrow\",\"in_review\",\"needs_review\",\"recorded\"]},\"pay_stubs\":{\"type\":\"array\",\"items\":{\"type\":\"object\",\"required\":[\"amount\",\"date\",\"employer\"],\"properties\":{\"amount\":{\"type\":\"number\",\"description\":\"Amount
        in dollars of the pay check\"},\"date\":{\"type\":\"string\",\"format\":\"date\",\"description\":\"Date
        the paycheck was issued\"},\"employer\":{\"type\":\"string\",\"description\":\"Name
        of the employer that issued this paycheck\"}}}},\"credit_scores\":{\"type\":\"array\",\"items\":{\"type\":\"object\",\"properties\":{\"score\":{\"type\":\"number\"},\"reporting_agency\":{\"type\":\"string\",\"enum\":[\"equifax\",\"experian\",\"transunion\"]}}}},\"underwriter_decision\":{\"type\":[\"object\",\"null\"],\"required\":[\"credit_score_used\",\"decision\"],\"properties\":{\"decision\":{\"type\":\"string\",\"enum\":[\"approved\",\"denied\"]},\"credit_score_used\":{\"type\":\"number\"},\"denied_reasons\":{\"type\":\"array\",\"items\":{\"type\":\"string\",\"enum\":[\"insufficient_pay_stubs_provided\",\"low_credit_score\"]}}}},\"credit_policy\":{\"type\":\"object\",\"required\":[\"credit_score_to_use\",\"institution\",\"minimum_credit_score\",\"minimum_pay_stub_count\"],\"properties\":{\"id\":{\"type\":\"number\"},\"institution\":{\"type\":\"string\"},\"minimum_pay_stub_count\":{\"type\":\"number\",\"description\":\"The
        loan file must have at least this many pay stubs.\"},\"minimum_credit_score\":{\"type\":\"number\"},\"credit_score_to_use\":{\"type\":\"string\",\"enum\":[\"median\",\"maximum\"],\"description\":\"If
        the scores are 500, 650, and 700, then maximum will compare the biggest (700)
        against minimum_credit_score and median will compare the median (650) against
        minimum_credit_score.\"}}}}}}}\n\nYou have been ran with the following inputs:\n\n{\"loan_file\":{\"id\":3,\"state\":\"needs_review\",\"pay_stubs\":[{\"amount\":3000,\"date\":\"2025-06-25\",\"employer\":\"Some
        Employer\"}],\"credit_scores\":[{\"reporting_agency\":\"experian\",\"score\":600},{\"reporting_agency\":\"equifax\",\"score\":650},{\"reporting_agency\":\"transunion\",\"score\":750}],\"loan_application\":{\"applicant\":{\"name\":\"Fumiko\"}},\"credit_policy\":{\"id\":3,\"institution\":\"Bank
        C\",\"minimum_credit_score\":700,\"credit_score_to_use\":\"maximum\",\"minimum_pay_stub_count\":1}}}\n\nYou
        will answer with the name of the next command to run and, if needed, its inputs.
        Choose whichever command is best to make progress towards accomplishing the
        current goal based on the progress made so far. If the goal has been accomplished
        then choose the NotifyUserThatCurrentGoalHasBeenAccomplished command. If you
        are stuck either due to errors or because you do not have the command you
        need to accomplish the goal, then choose GiveUp.\n\nYou can get more details
        about the inputs and result schemas for a specific command by choosing the
        DescribeCommand command.\n\nYour result type is described by the following
        JSON schema:\n\n{\"type\":\"object\",\"required\":[\"command\"],\"properties\":{\"command\":{\"type\":\"string\"},\"inputs\":{\"type\":[\"object\",\"null\"]}}}\n\nYou
        will reply with nothing more than the JSON that you''ve generated that adheres
        to this result type schema so that the calling code can successfully parse
        your answer."}'
    headers:
      Content-Type:
      - application/json
      X-Api-Key:
      - "<SCRUBBED_ANTHROPIC_API_KEY>"
      Anthropic-Version:
      - '2023-06-01'
      Accept-Encoding:
      - gzip;q=1.0,deflate;q=0.6,identity;q=0.3
      Accept:
      - "*/*"
      User-Agent:
      - Ruby
  response:
    status:
      code: 200
      message: OK
    headers:
      Date:
      - Wed, 23 Jul 2025 20:43:20 GMT
      Content-Type:
      - application/json
      Transfer-Encoding:
      - chunked
      Connection:
      - keep-alive
      Anthropic-Ratelimit-Input-Tokens-Limit:
      - '80000'
      Anthropic-Ratelimit-Input-Tokens-Remaining:
      - '80000'
      Anthropic-Ratelimit-Input-Tokens-Reset:
      - '2025-07-23T20:43:19Z'
      Anthropic-Ratelimit-Output-Tokens-Limit:
      - '16000'
      Anthropic-Ratelimit-Output-Tokens-Remaining:
      - '16000'
      Anthropic-Ratelimit-Output-Tokens-Reset:
      - '2025-07-23T20:43:20Z'
      Anthropic-Ratelimit-Requests-Limit:
      - '2000'
      Anthropic-Ratelimit-Requests-Remaining:
      - '1999'
      Anthropic-Ratelimit-Requests-Reset:
      - '2025-07-23T20:43:17Z'
      Anthropic-Ratelimit-Tokens-Limit:
      - '96000'
      Anthropic-Ratelimit-Tokens-Remaining:
      - '96000'
      Anthropic-Ratelimit-Tokens-Reset:
      - '2025-07-23T20:43:19Z'
      Request-Id:
      - req_011CRQbphF66DFvMPWrVWsDy
      Strict-Transport-Security:
      - max-age=31536000; includeSubDomains; preload
      Anthropic-Organization-Id:
      - 7a8e3751-3b70-4f90-a3ce-07f57c9d0bfc
      Via:
      - 1.1 google
      Cf-Cache-Status:
      - DYNAMIC
      X-Robots-Tag:
      - none
      Server:
      - cloudflare
      Cf-Ray:
      - 963e0258c9ccebe5-SJC
    body:
      encoding: ASCII-8BIT
      string: '{"id":"msg_01RGCMk3eQ9Dz5EayKH1rBBt","type":"message","role":"assistant","model":"claude-opus-4-20250514","content":[{"type":"text","text":"{\"command\":\"FoobaraDemo::LoanOrigination::StartUnderwriterReview\",\"inputs\":{\"loan_file\":3}}"}],"stop_reason":"end_turn","stop_sequence":null,"usage":{"input_tokens":2241,"cache_creation_input_tokens":0,"cache_read_input_tokens":0,"output_tokens":34,"service_tier":"standard"}}'
  recorded_at: Wed, 23 Jul 2025 20:43:20 GMT
- request:
    method: post
    uri: https://api.anthropic.com/v1/messages
    body:
      encoding: UTF-8
      string: '{"model":"claude-opus-4-20250514","max_tokens":1024,"messages":[{"role":"assistant","content":"{\"command\":\"Foobara::Agent::DescribeCommand\",\"inputs\":{\"command_name\":\"Foobara::Agent::ListCommands\"}}"},{"role":"user","content":"{\"success\":true,\"result\":{\"full_command_name\":\"Foobara::Agent::ListCommands\",\"description\":null,\"inputs_type\":{\"type\":\"object\"},\"result_type\":{\"type\":\"object\",\"required\":[\"agent_specific_commands\",\"user_provided_commands\"],\"properties\":{\"user_provided_commands\":{\"type\":\"array\",\"items\":{\"type\":\"string\"},\"description\":\"List
        of commands the user would like you to choose from to accomplish the goal\"},\"agent_specific_commands\":{\"type\":\"array\",\"items\":{\"type\":\"string\"},\"description\":\"Commands
        available to all agents to introspect or end the session\"}}}}}"},{"role":"assistant","content":"{\"command\":\"Foobara::Agent::ListCommands\"}"},{"role":"user","content":"{\"success\":true,\"result\":{\"user_provided_commands\":[\"FoobaraDemo::LoanOrigination::StartUnderwriterReview\",\"FoobaraDemo::LoanOrigination::DenyLoanFile\",\"FoobaraDemo::LoanOrigination::ApproveLoanFile\"],\"agent_specific_commands\":[\"Foobara::Agent::DescribeCommand\",\"Foobara::Agent::DescribeType\",\"Foobara::Agent::GiveUp\",\"Foobara::Agent::ListCommands\",\"Foobara::Agent::ReviewLoanFile::NotifyUserThatCurrentGoalHasBeenAccomplished\"]}}"},{"role":"assistant","content":"{\"command\":\"Foobara::Agent::DetermineNextCommandNameAndInputs\",\"inputs\":{\"agent\":\"#<Foobara::Agent:0x00007fb77c2dec50>\",\"llm_model\":\"claude-opus-4-20250514\",\"pass_aggregates_to_llm\":true}}"},{"role":"user","content":"{\"success\":false,\"errors_hash\":{\"runtime.could_not_parse_result_json\":{\"key\":\"runtime.could_not_parse_result_json\",\"path\":[],\"runtime_path\":[],\"category\":\"runtime\",\"symbol\":\"could_not_parse_result_json\",\"message\":\"Could
        not parse result JSON: unexpected token ''I'' at line 1 column 1\",\"context\":{\"raw_answer\":\"I
        need to review the loan file against the credit policy requirements. Let me
        check the details:\\n\\n**Loan File #3:**\\n- Credit scores: Experian 600,
        Equifax 650, TransUnion 750\\n- Credit policy uses \\\"maximum\\\" score,
        which would be 750\\n- Minimum required credit score: 700\\n- Pay stubs provided:
        1 (meets minimum requirement of 1)\\n\\nSince the maximum credit score (750)
        exceeds the minimum requirement (700) and the pay stub count meets the requirement,
        this loan file satisfies all requirements and should be approved.\\n\\n{\\\"command\\\":\\\"FoobaraDemo::LoanOrigination::ApproveLoanFile\\\",\\\"inputs\\\":{\\\"loan_file_id\\\":3}}\",\"stripped_answer\":\"I
        need to review the loan file against the credit policy requirements. Let me
        check the details:\\n\\n**Loan File #3:**\\n- Credit scores: Experian 600,
        Equifax 650, TransUnion 750\\n- Credit policy uses \\\"maximum\\\" score,
        which would be 750\\n- Minimum required credit score: 700\\n- Pay stubs provided:
        1 (meets minimum requirement of 1)\\n\\nSince the maximum credit score (750)
        exceeds the minimum requirement (700) and the pay stub count meets the requirement,
        this loan file satisfies all requirements and should be approved.\\n\\n{\\\"command\\\":\\\"FoobaraDemo::LoanOrigination::ApproveLoanFile\\\",\\\"inputs\\\":{\\\"loan_file_id\\\":3}}\"},\"is_fatal\":false}}}"},{"role":"assistant","content":"{\"command\":\"Foobara::Agent::DescribeCommand\",\"inputs\":{\"command_name\":\"FoobaraDemo::LoanOrigination::ApproveLoanFile\"}}"},{"role":"user","content":"{\"success\":true,\"result\":{\"full_command_name\":\"FoobaraDemo::LoanOrigination::ApproveLoanFile\",\"description\":null,\"inputs_type\":{\"type\":\"object\",\"required\":[\"credit_score_used\",\"loan_file\"],\"properties\":{\"credit_score_used\":{\"type\":\"number\"},\"loan_file\":{\"type\":\"number\",\"description\":\"LoanFile
        id\"}}}}}"},{"role":"assistant","content":"{\"command\":\"FoobaraDemo::LoanOrigination::ApproveLoanFile\",\"inputs\":{\"loan_file\":3,\"credit_score_used\":750}}"},{"role":"user","content":"{\"success\":false,\"errors_hash\":{\"data.loan_file.cannot_transition_state\":{\"key\":\"data.loan_file.cannot_transition_state\",\"path\":[\"loan_file\"],\"runtime_path\":[],\"category\":\"data\",\"symbol\":\"cannot_transition_state\",\"message\":\"Cannot
        perform approve transition for loan file 3 from needs_review. Expected state
        to be one of: [:in_review]. Did you forget to start the review?\",\"context\":{\"loan_file_id\":3,\"current_state\":\"needs_review\",\"required_states\":[\"in_review\"],\"attempted_transition\":\"approve\"},\"is_fatal\":false}}}"},{"role":"assistant","content":"{\"command\":\"Foobara::Agent::DescribeCommand\",\"inputs\":{\"command_name\":\"FoobaraDemo::LoanOrigination::StartUnderwriterReview\"}}"},{"role":"user","content":"{\"success\":true,\"result\":{\"full_command_name\":\"FoobaraDemo::LoanOrigination::StartUnderwriterReview\",\"description\":null,\"inputs_type\":{\"type\":\"object\",\"required\":[\"loan_file\"],\"properties\":{\"loan_file\":{\"type\":\"number\",\"description\":\"LoanFile
        id\"}}}}}"}],"temperature":0.0,"system":"You are part of an agent implementation.
        Your task is to decide which command to run next.\n\nYou are working towards
        accomplishing the following goal: Review loan file\n\nYour behavior has been
        described to the person or agent that chose to run you as: Checks the LoanFile
        against all requirements in its CreditPolicy. Denies the LoanFile that has
        any unsatisfied requirements.\n\nYour inputs to this command have the following
        type:\n\n{\"type\":\"object\",\"required\":[\"loan_file\"],\"properties\":{\"loan_file\":{\"type\":\"object\",\"required\":[\"credit_scores\",\"loan_application\",\"pay_stubs\",\"state\"],\"properties\":{\"id\":{\"type\":\"number\"},\"loan_application\":{\"type\":\"object\",\"required\":[\"applicant\"],\"properties\":{\"applicant\":{\"type\":\"object\",\"required\":[\"name\"],\"properties\":{\"name\":{\"type\":\"string\"}}}}},\"state\":{\"type\":\"string\",\"enum\":[\"building_loan_file\",\"denied\",\"drafting_docs\",\"in_escrow\",\"in_review\",\"needs_review\",\"recorded\"]},\"pay_stubs\":{\"type\":\"array\",\"items\":{\"type\":\"object\",\"required\":[\"amount\",\"date\",\"employer\"],\"properties\":{\"amount\":{\"type\":\"number\",\"description\":\"Amount
        in dollars of the pay check\"},\"date\":{\"type\":\"string\",\"format\":\"date\",\"description\":\"Date
        the paycheck was issued\"},\"employer\":{\"type\":\"string\",\"description\":\"Name
        of the employer that issued this paycheck\"}}}},\"credit_scores\":{\"type\":\"array\",\"items\":{\"type\":\"object\",\"properties\":{\"score\":{\"type\":\"number\"},\"reporting_agency\":{\"type\":\"string\",\"enum\":[\"equifax\",\"experian\",\"transunion\"]}}}},\"underwriter_decision\":{\"type\":[\"object\",\"null\"],\"required\":[\"credit_score_used\",\"decision\"],\"properties\":{\"decision\":{\"type\":\"string\",\"enum\":[\"approved\",\"denied\"]},\"credit_score_used\":{\"type\":\"number\"},\"denied_reasons\":{\"type\":\"array\",\"items\":{\"type\":\"string\",\"enum\":[\"insufficient_pay_stubs_provided\",\"low_credit_score\"]}}}},\"credit_policy\":{\"type\":\"object\",\"required\":[\"credit_score_to_use\",\"institution\",\"minimum_credit_score\",\"minimum_pay_stub_count\"],\"properties\":{\"id\":{\"type\":\"number\"},\"institution\":{\"type\":\"string\"},\"minimum_pay_stub_count\":{\"type\":\"number\",\"description\":\"The
        loan file must have at least this many pay stubs.\"},\"minimum_credit_score\":{\"type\":\"number\"},\"credit_score_to_use\":{\"type\":\"string\",\"enum\":[\"median\",\"maximum\"],\"description\":\"If
        the scores are 500, 650, and 700, then maximum will compare the biggest (700)
        against minimum_credit_score and median will compare the median (650) against
        minimum_credit_score.\"}}}}}}}\n\nYou have been ran with the following inputs:\n\n{\"loan_file\":{\"id\":3,\"state\":\"needs_review\",\"pay_stubs\":[{\"amount\":3000,\"date\":\"2025-06-25\",\"employer\":\"Some
        Employer\"}],\"credit_scores\":[{\"reporting_agency\":\"experian\",\"score\":600},{\"reporting_agency\":\"equifax\",\"score\":650},{\"reporting_agency\":\"transunion\",\"score\":750}],\"loan_application\":{\"applicant\":{\"name\":\"Fumiko\"}},\"credit_policy\":{\"id\":3,\"institution\":\"Bank
        C\",\"minimum_credit_score\":700,\"credit_score_to_use\":\"maximum\",\"minimum_pay_stub_count\":1}}}\n\nYou
        will answer with the name of the next command to run and, if needed, its inputs.
        Choose whichever command is best to make progress towards accomplishing the
        current goal based on the progress made so far. If the goal has been accomplished
        then choose the NotifyUserThatCurrentGoalHasBeenAccomplished command. If you
        are stuck either due to errors or because you do not have the command you
        need to accomplish the goal, then choose GiveUp.\n\nYou can get more details
        about the inputs and result schemas for a specific command by choosing the
        DescribeCommand command.\n\nYour result type is described by the following
        JSON schema:\n\n{\"type\":\"object\",\"required\":[\"command\"],\"properties\":{\"command\":{\"type\":\"string\"},\"inputs\":{\"type\":[\"object\",\"null\"]}}}\n\nYou
        will reply with nothing more than the JSON that you''ve generated that adheres
        to this result type schema so that the calling code can successfully parse
        your answer."}'
    headers:
      Content-Type:
      - application/json
      X-Api-Key:
      - "<SCRUBBED_ANTHROPIC_API_KEY>"
      Anthropic-Version:
      - '2023-06-01'
      Accept-Encoding:
      - gzip;q=1.0,deflate;q=0.6,identity;q=0.3
      Accept:
      - "*/*"
      User-Agent:
      - Ruby
  response:
    status:
      code: 200
      message: OK
    headers:
      Date:
      - Wed, 23 Jul 2025 20:43:25 GMT
      Content-Type:
      - application/json
      Transfer-Encoding:
      - chunked
      Connection:
      - keep-alive
      Anthropic-Ratelimit-Input-Tokens-Limit:
      - '80000'
      Anthropic-Ratelimit-Input-Tokens-Remaining:
      - '80000'
      Anthropic-Ratelimit-Input-Tokens-Reset:
      - '2025-07-23T20:43:25Z'
      Anthropic-Ratelimit-Output-Tokens-Limit:
      - '16000'
      Anthropic-Ratelimit-Output-Tokens-Remaining:
      - '16000'
      Anthropic-Ratelimit-Output-Tokens-Reset:
      - '2025-07-23T20:43:25Z'
      Anthropic-Ratelimit-Requests-Limit:
      - '2000'
      Anthropic-Ratelimit-Requests-Remaining:
      - '1999'
      Anthropic-Ratelimit-Requests-Reset:
      - '2025-07-23T20:43:20Z'
      Anthropic-Ratelimit-Tokens-Limit:
      - '96000'
      Anthropic-Ratelimit-Tokens-Remaining:
      - '96000'
      Anthropic-Ratelimit-Tokens-Reset:
      - '2025-07-23T20:43:25Z'
      Request-Id:
      - req_011CRQbpumQWyNSVk68MvQfc
      Strict-Transport-Security:
      - max-age=31536000; includeSubDomains; preload
      Anthropic-Organization-Id:
      - 7a8e3751-3b70-4f90-a3ce-07f57c9d0bfc
      Via:
      - 1.1 google
      Cf-Cache-Status:
      - DYNAMIC
      X-Robots-Tag:
      - none
      Server:
      - cloudflare
      Cf-Ray:
      - 963e026afd1315e9-SJC
    body:
      encoding: ASCII-8BIT
      string: '{"id":"msg_01U67zvGpCYbhNRmomRrsVCC","type":"message","role":"assistant","model":"claude-opus-4-20250514","content":[{"type":"text","text":"{\"command\":\"FoobaraDemo::LoanOrigination::StartUnderwriterReview\",\"inputs\":{\"loan_file\":3}}"}],"stop_reason":"end_turn","stop_sequence":null,"usage":{"input_tokens":2364,"cache_creation_input_tokens":0,"cache_read_input_tokens":0,"output_tokens":34,"service_tier":"standard"}}'
  recorded_at: Wed, 23 Jul 2025 20:43:25 GMT
- request:
    method: post
    uri: https://api.anthropic.com/v1/messages
    body:
      encoding: UTF-8
      string: '{"model":"claude-opus-4-20250514","max_tokens":1024,"messages":[{"role":"assistant","content":"{\"command\":\"Foobara::Agent::DescribeCommand\",\"inputs\":{\"command_name\":\"Foobara::Agent::ListCommands\"}}"},{"role":"user","content":"{\"success\":true,\"result\":{\"full_command_name\":\"Foobara::Agent::ListCommands\",\"description\":null,\"inputs_type\":{\"type\":\"object\"},\"result_type\":{\"type\":\"object\",\"required\":[\"agent_specific_commands\",\"user_provided_commands\"],\"properties\":{\"user_provided_commands\":{\"type\":\"array\",\"items\":{\"type\":\"string\"},\"description\":\"List
        of commands the user would like you to choose from to accomplish the goal\"},\"agent_specific_commands\":{\"type\":\"array\",\"items\":{\"type\":\"string\"},\"description\":\"Commands
        available to all agents to introspect or end the session\"}}}}}"},{"role":"assistant","content":"{\"command\":\"Foobara::Agent::ListCommands\"}"},{"role":"user","content":"{\"success\":true,\"result\":{\"user_provided_commands\":[\"FoobaraDemo::LoanOrigination::StartUnderwriterReview\",\"FoobaraDemo::LoanOrigination::DenyLoanFile\",\"FoobaraDemo::LoanOrigination::ApproveLoanFile\"],\"agent_specific_commands\":[\"Foobara::Agent::DescribeCommand\",\"Foobara::Agent::DescribeType\",\"Foobara::Agent::GiveUp\",\"Foobara::Agent::ListCommands\",\"Foobara::Agent::ReviewLoanFile::NotifyUserThatCurrentGoalHasBeenAccomplished\"]}}"},{"role":"assistant","content":"{\"command\":\"Foobara::Agent::DetermineNextCommandNameAndInputs\",\"inputs\":{\"agent\":\"#<Foobara::Agent:0x00007fb77c2dec50>\",\"llm_model\":\"claude-opus-4-20250514\",\"pass_aggregates_to_llm\":true}}"},{"role":"user","content":"{\"success\":false,\"errors_hash\":{\"runtime.could_not_parse_result_json\":{\"key\":\"runtime.could_not_parse_result_json\",\"path\":[],\"runtime_path\":[],\"category\":\"runtime\",\"symbol\":\"could_not_parse_result_json\",\"message\":\"Could
        not parse result JSON: unexpected token ''I'' at line 1 column 1\",\"context\":{\"raw_answer\":\"I
        need to review the loan file against the credit policy requirements. Let me
        check the details:\\n\\n**Loan File #3:**\\n- Credit scores: Experian 600,
        Equifax 650, TransUnion 750\\n- Credit policy uses \\\"maximum\\\" score,
        which would be 750\\n- Minimum required credit score: 700\\n- Pay stubs provided:
        1 (meets minimum requirement of 1)\\n\\nSince the maximum credit score (750)
        exceeds the minimum requirement (700) and the pay stub count meets the requirement,
        this loan file satisfies all requirements and should be approved.\\n\\n{\\\"command\\\":\\\"FoobaraDemo::LoanOrigination::ApproveLoanFile\\\",\\\"inputs\\\":{\\\"loan_file_id\\\":3}}\",\"stripped_answer\":\"I
        need to review the loan file against the credit policy requirements. Let me
        check the details:\\n\\n**Loan File #3:**\\n- Credit scores: Experian 600,
        Equifax 650, TransUnion 750\\n- Credit policy uses \\\"maximum\\\" score,
        which would be 750\\n- Minimum required credit score: 700\\n- Pay stubs provided:
        1 (meets minimum requirement of 1)\\n\\nSince the maximum credit score (750)
        exceeds the minimum requirement (700) and the pay stub count meets the requirement,
        this loan file satisfies all requirements and should be approved.\\n\\n{\\\"command\\\":\\\"FoobaraDemo::LoanOrigination::ApproveLoanFile\\\",\\\"inputs\\\":{\\\"loan_file_id\\\":3}}\"},\"is_fatal\":false}}}"},{"role":"assistant","content":"{\"command\":\"Foobara::Agent::DescribeCommand\",\"inputs\":{\"command_name\":\"FoobaraDemo::LoanOrigination::ApproveLoanFile\"}}"},{"role":"user","content":"{\"success\":true,\"result\":{\"full_command_name\":\"FoobaraDemo::LoanOrigination::ApproveLoanFile\",\"description\":null,\"inputs_type\":{\"type\":\"object\",\"required\":[\"credit_score_used\",\"loan_file\"],\"properties\":{\"credit_score_used\":{\"type\":\"number\"},\"loan_file\":{\"type\":\"number\",\"description\":\"LoanFile
        id\"}}}}}"},{"role":"assistant","content":"{\"command\":\"FoobaraDemo::LoanOrigination::ApproveLoanFile\",\"inputs\":{\"loan_file\":3,\"credit_score_used\":750}}"},{"role":"user","content":"{\"success\":false,\"errors_hash\":{\"data.loan_file.cannot_transition_state\":{\"key\":\"data.loan_file.cannot_transition_state\",\"path\":[\"loan_file\"],\"runtime_path\":[],\"category\":\"data\",\"symbol\":\"cannot_transition_state\",\"message\":\"Cannot
        perform approve transition for loan file 3 from needs_review. Expected state
        to be one of: [:in_review]. Did you forget to start the review?\",\"context\":{\"loan_file_id\":3,\"current_state\":\"needs_review\",\"required_states\":[\"in_review\"],\"attempted_transition\":\"approve\"},\"is_fatal\":false}}}"},{"role":"assistant","content":"{\"command\":\"Foobara::Agent::DescribeCommand\",\"inputs\":{\"command_name\":\"FoobaraDemo::LoanOrigination::StartUnderwriterReview\"}}"},{"role":"user","content":"{\"success\":true,\"result\":{\"full_command_name\":\"FoobaraDemo::LoanOrigination::StartUnderwriterReview\",\"description\":null,\"inputs_type\":{\"type\":\"object\",\"required\":[\"loan_file\"],\"properties\":{\"loan_file\":{\"type\":\"number\",\"description\":\"LoanFile
        id\"}}}}}"},{"role":"assistant","content":"{\"command\":\"FoobaraDemo::LoanOrigination::StartUnderwriterReview\",\"inputs\":{\"loan_file\":3}}"},{"role":"user","content":"{\"success\":true,\"result\":null}"}],"temperature":0.0,"system":"You
        are part of an agent implementation. Your task is to decide which command
        to run next.\n\nYou are working towards accomplishing the following goal:
        Review loan file\n\nYour behavior has been described to the person or agent
        that chose to run you as: Checks the LoanFile against all requirements in
        its CreditPolicy. Denies the LoanFile that has any unsatisfied requirements.\n\nYour
        inputs to this command have the following type:\n\n{\"type\":\"object\",\"required\":[\"loan_file\"],\"properties\":{\"loan_file\":{\"type\":\"object\",\"required\":[\"credit_scores\",\"loan_application\",\"pay_stubs\",\"state\"],\"properties\":{\"id\":{\"type\":\"number\"},\"loan_application\":{\"type\":\"object\",\"required\":[\"applicant\"],\"properties\":{\"applicant\":{\"type\":\"object\",\"required\":[\"name\"],\"properties\":{\"name\":{\"type\":\"string\"}}}}},\"state\":{\"type\":\"string\",\"enum\":[\"building_loan_file\",\"denied\",\"drafting_docs\",\"in_escrow\",\"in_review\",\"needs_review\",\"recorded\"]},\"pay_stubs\":{\"type\":\"array\",\"items\":{\"type\":\"object\",\"required\":[\"amount\",\"date\",\"employer\"],\"properties\":{\"amount\":{\"type\":\"number\",\"description\":\"Amount
        in dollars of the pay check\"},\"date\":{\"type\":\"string\",\"format\":\"date\",\"description\":\"Date
        the paycheck was issued\"},\"employer\":{\"type\":\"string\",\"description\":\"Name
        of the employer that issued this paycheck\"}}}},\"credit_scores\":{\"type\":\"array\",\"items\":{\"type\":\"object\",\"properties\":{\"score\":{\"type\":\"number\"},\"reporting_agency\":{\"type\":\"string\",\"enum\":[\"equifax\",\"experian\",\"transunion\"]}}}},\"underwriter_decision\":{\"type\":[\"object\",\"null\"],\"required\":[\"credit_score_used\",\"decision\"],\"properties\":{\"decision\":{\"type\":\"string\",\"enum\":[\"approved\",\"denied\"]},\"credit_score_used\":{\"type\":\"number\"},\"denied_reasons\":{\"type\":\"array\",\"items\":{\"type\":\"string\",\"enum\":[\"insufficient_pay_stubs_provided\",\"low_credit_score\"]}}}},\"credit_policy\":{\"type\":\"object\",\"required\":[\"credit_score_to_use\",\"institution\",\"minimum_credit_score\",\"minimum_pay_stub_count\"],\"properties\":{\"id\":{\"type\":\"number\"},\"institution\":{\"type\":\"string\"},\"minimum_pay_stub_count\":{\"type\":\"number\",\"description\":\"The
        loan file must have at least this many pay stubs.\"},\"minimum_credit_score\":{\"type\":\"number\"},\"credit_score_to_use\":{\"type\":\"string\",\"enum\":[\"median\",\"maximum\"],\"description\":\"If
        the scores are 500, 650, and 700, then maximum will compare the biggest (700)
        against minimum_credit_score and median will compare the median (650) against
        minimum_credit_score.\"}}}}}}}\n\nYou have been ran with the following inputs:\n\n{\"loan_file\":{\"id\":3,\"state\":\"needs_review\",\"pay_stubs\":[{\"amount\":3000,\"date\":\"2025-06-25\",\"employer\":\"Some
        Employer\"}],\"credit_scores\":[{\"reporting_agency\":\"experian\",\"score\":600},{\"reporting_agency\":\"equifax\",\"score\":650},{\"reporting_agency\":\"transunion\",\"score\":750}],\"loan_application\":{\"applicant\":{\"name\":\"Fumiko\"}},\"credit_policy\":{\"id\":3,\"institution\":\"Bank
        C\",\"minimum_credit_score\":700,\"credit_score_to_use\":\"maximum\",\"minimum_pay_stub_count\":1}}}\n\nYou
        will answer with the name of the next command to run and, if needed, its inputs.
        Choose whichever command is best to make progress towards accomplishing the
        current goal based on the progress made so far. If the goal has been accomplished
        then choose the NotifyUserThatCurrentGoalHasBeenAccomplished command. If you
        are stuck either due to errors or because you do not have the command you
        need to accomplish the goal, then choose GiveUp.\n\nYou can get more details
        about the inputs and result schemas for a specific command by choosing the
        DescribeCommand command.\n\nYour result type is described by the following
        JSON schema:\n\n{\"type\":\"object\",\"required\":[\"command\"],\"properties\":{\"command\":{\"type\":\"string\"},\"inputs\":{\"type\":[\"object\",\"null\"]}}}\n\nYou
        will reply with nothing more than the JSON that you''ve generated that adheres
        to this result type schema so that the calling code can successfully parse
        your answer."}'
    headers:
      Content-Type:
      - application/json
      X-Api-Key:
      - "<SCRUBBED_ANTHROPIC_API_KEY>"
      Anthropic-Version:
      - '2023-06-01'
      Accept-Encoding:
      - gzip;q=1.0,deflate;q=0.6,identity;q=0.3
      Accept:
      - "*/*"
      User-Agent:
      - Ruby
  response:
    status:
      code: 200
      message: OK
    headers:
      Date:
      - Wed, 23 Jul 2025 20:43:28 GMT
      Content-Type:
      - application/json
      Transfer-Encoding:
      - chunked
      Connection:
      - keep-alive
      Anthropic-Ratelimit-Input-Tokens-Limit:
      - '80000'
      Anthropic-Ratelimit-Input-Tokens-Remaining:
      - '80000'
      Anthropic-Ratelimit-Input-Tokens-Reset:
      - '2025-07-23T20:43:28Z'
      Anthropic-Ratelimit-Output-Tokens-Limit:
      - '16000'
      Anthropic-Ratelimit-Output-Tokens-Remaining:
      - '16000'
      Anthropic-Ratelimit-Output-Tokens-Reset:
      - '2025-07-23T20:43:28Z'
      Anthropic-Ratelimit-Requests-Limit:
      - '2000'
      Anthropic-Ratelimit-Requests-Remaining:
      - '1999'
      Anthropic-Ratelimit-Requests-Reset:
      - '2025-07-23T20:43:26Z'
      Anthropic-Ratelimit-Tokens-Limit:
      - '96000'
      Anthropic-Ratelimit-Tokens-Remaining:
      - '96000'
      Anthropic-Ratelimit-Tokens-Reset:
      - '2025-07-23T20:43:28Z'
      Request-Id:
      - req_011CRQbqLTxAFMqQocjuqX4A
      Strict-Transport-Security:
      - max-age=31536000; includeSubDomains; preload
      Anthropic-Organization-Id:
      - 7a8e3751-3b70-4f90-a3ce-07f57c9d0bfc
      Via:
      - 1.1 google
      Cf-Cache-Status:
      - DYNAMIC
      X-Robots-Tag:
      - none
      Server:
      - cloudflare
      Cf-Ray:
      - 963e028f0bee2320-SJC
    body:
      encoding: ASCII-8BIT
      string: '{"id":"msg_01FhohG2DN6JpVQDduax9aJe","type":"message","role":"assistant","model":"claude-opus-4-20250514","content":[{"type":"text","text":"{\"command\":\"FoobaraDemo::LoanOrigination::ApproveLoanFile\",\"inputs\":{\"loan_file\":3,\"credit_score_used\":750}}"}],"stop_reason":"end_turn","stop_sequence":null,"usage":{"input_tokens":2410,"cache_creation_input_tokens":0,"cache_read_input_tokens":0,"output_tokens":40,"service_tier":"standard"}}'
  recorded_at: Wed, 23 Jul 2025 20:43:28 GMT
- request:
    method: post
    uri: https://api.anthropic.com/v1/messages
    body:
      encoding: UTF-8
      string: '{"model":"claude-opus-4-20250514","max_tokens":1024,"messages":[{"role":"assistant","content":"{\"command\":\"Foobara::Agent::DescribeCommand\",\"inputs\":{\"command_name\":\"Foobara::Agent::ListCommands\"}}"},{"role":"user","content":"{\"success\":true,\"result\":{\"full_command_name\":\"Foobara::Agent::ListCommands\",\"description\":null,\"inputs_type\":{\"type\":\"object\"},\"result_type\":{\"type\":\"object\",\"required\":[\"agent_specific_commands\",\"user_provided_commands\"],\"properties\":{\"user_provided_commands\":{\"type\":\"array\",\"items\":{\"type\":\"string\"},\"description\":\"List
        of commands the user would like you to choose from to accomplish the goal\"},\"agent_specific_commands\":{\"type\":\"array\",\"items\":{\"type\":\"string\"},\"description\":\"Commands
        available to all agents to introspect or end the session\"}}}}}"},{"role":"assistant","content":"{\"command\":\"Foobara::Agent::ListCommands\"}"},{"role":"user","content":"{\"success\":true,\"result\":{\"user_provided_commands\":[\"FoobaraDemo::LoanOrigination::StartUnderwriterReview\",\"FoobaraDemo::LoanOrigination::DenyLoanFile\",\"FoobaraDemo::LoanOrigination::ApproveLoanFile\"],\"agent_specific_commands\":[\"Foobara::Agent::DescribeCommand\",\"Foobara::Agent::DescribeType\",\"Foobara::Agent::GiveUp\",\"Foobara::Agent::ListCommands\",\"Foobara::Agent::ReviewLoanFile::NotifyUserThatCurrentGoalHasBeenAccomplished\"]}}"},{"role":"assistant","content":"{\"command\":\"Foobara::Agent::DetermineNextCommandNameAndInputs\",\"inputs\":{\"agent\":\"#<Foobara::Agent:0x00007fb77c2dec50>\",\"llm_model\":\"claude-opus-4-20250514\",\"pass_aggregates_to_llm\":true}}"},{"role":"user","content":"{\"success\":false,\"errors_hash\":{\"runtime.could_not_parse_result_json\":{\"key\":\"runtime.could_not_parse_result_json\",\"path\":[],\"runtime_path\":[],\"category\":\"runtime\",\"symbol\":\"could_not_parse_result_json\",\"message\":\"Could
        not parse result JSON: unexpected token ''I'' at line 1 column 1\",\"context\":{\"raw_answer\":\"I
        need to review the loan file against the credit policy requirements. Let me
        check the details:\\n\\n**Loan File #3:**\\n- Credit scores: Experian 600,
        Equifax 650, TransUnion 750\\n- Credit policy uses \\\"maximum\\\" score,
        which would be 750\\n- Minimum required credit score: 700\\n- Pay stubs provided:
        1 (meets minimum requirement of 1)\\n\\nSince the maximum credit score (750)
        exceeds the minimum requirement (700) and the pay stub count meets the requirement,
        this loan file satisfies all requirements and should be approved.\\n\\n{\\\"command\\\":\\\"FoobaraDemo::LoanOrigination::ApproveLoanFile\\\",\\\"inputs\\\":{\\\"loan_file_id\\\":3}}\",\"stripped_answer\":\"I
        need to review the loan file against the credit policy requirements. Let me
        check the details:\\n\\n**Loan File #3:**\\n- Credit scores: Experian 600,
        Equifax 650, TransUnion 750\\n- Credit policy uses \\\"maximum\\\" score,
        which would be 750\\n- Minimum required credit score: 700\\n- Pay stubs provided:
        1 (meets minimum requirement of 1)\\n\\nSince the maximum credit score (750)
        exceeds the minimum requirement (700) and the pay stub count meets the requirement,
        this loan file satisfies all requirements and should be approved.\\n\\n{\\\"command\\\":\\\"FoobaraDemo::LoanOrigination::ApproveLoanFile\\\",\\\"inputs\\\":{\\\"loan_file_id\\\":3}}\"},\"is_fatal\":false}}}"},{"role":"assistant","content":"{\"command\":\"Foobara::Agent::DescribeCommand\",\"inputs\":{\"command_name\":\"FoobaraDemo::LoanOrigination::ApproveLoanFile\"}}"},{"role":"user","content":"{\"success\":true,\"result\":{\"full_command_name\":\"FoobaraDemo::LoanOrigination::ApproveLoanFile\",\"description\":null,\"inputs_type\":{\"type\":\"object\",\"required\":[\"credit_score_used\",\"loan_file\"],\"properties\":{\"credit_score_used\":{\"type\":\"number\"},\"loan_file\":{\"type\":\"number\",\"description\":\"LoanFile
        id\"}}}}}"},{"role":"assistant","content":"{\"command\":\"Foobara::Agent::DescribeCommand\",\"inputs\":{\"command_name\":\"FoobaraDemo::LoanOrigination::StartUnderwriterReview\"}}"},{"role":"user","content":"{\"success\":true,\"result\":{\"full_command_name\":\"FoobaraDemo::LoanOrigination::StartUnderwriterReview\",\"description\":null,\"inputs_type\":{\"type\":\"object\",\"required\":[\"loan_file\"],\"properties\":{\"loan_file\":{\"type\":\"number\",\"description\":\"LoanFile
        id\"}}}}}"},{"role":"assistant","content":"{\"command\":\"FoobaraDemo::LoanOrigination::StartUnderwriterReview\",\"inputs\":{\"loan_file\":3}}"},{"role":"user","content":"{\"success\":true,\"result\":null}"},{"role":"assistant","content":"{\"command\":\"FoobaraDemo::LoanOrigination::ApproveLoanFile\",\"inputs\":{\"loan_file\":3,\"credit_score_used\":750}}"},{"role":"user","content":"{\"success\":true,\"result\":null}"}],"temperature":0.0,"system":"You
        are part of an agent implementation. Your task is to decide which command
        to run next.\n\nYou are working towards accomplishing the following goal:
        Review loan file\n\nYour behavior has been described to the person or agent
        that chose to run you as: Checks the LoanFile against all requirements in
        its CreditPolicy. Denies the LoanFile that has any unsatisfied requirements.\n\nYour
        inputs to this command have the following type:\n\n{\"type\":\"object\",\"required\":[\"loan_file\"],\"properties\":{\"loan_file\":{\"type\":\"object\",\"required\":[\"credit_scores\",\"loan_application\",\"pay_stubs\",\"state\"],\"properties\":{\"id\":{\"type\":\"number\"},\"loan_application\":{\"type\":\"object\",\"required\":[\"applicant\"],\"properties\":{\"applicant\":{\"type\":\"object\",\"required\":[\"name\"],\"properties\":{\"name\":{\"type\":\"string\"}}}}},\"state\":{\"type\":\"string\",\"enum\":[\"building_loan_file\",\"denied\",\"drafting_docs\",\"in_escrow\",\"in_review\",\"needs_review\",\"recorded\"]},\"pay_stubs\":{\"type\":\"array\",\"items\":{\"type\":\"object\",\"required\":[\"amount\",\"date\",\"employer\"],\"properties\":{\"amount\":{\"type\":\"number\",\"description\":\"Amount
        in dollars of the pay check\"},\"date\":{\"type\":\"string\",\"format\":\"date\",\"description\":\"Date
        the paycheck was issued\"},\"employer\":{\"type\":\"string\",\"description\":\"Name
        of the employer that issued this paycheck\"}}}},\"credit_scores\":{\"type\":\"array\",\"items\":{\"type\":\"object\",\"properties\":{\"score\":{\"type\":\"number\"},\"reporting_agency\":{\"type\":\"string\",\"enum\":[\"equifax\",\"experian\",\"transunion\"]}}}},\"underwriter_decision\":{\"type\":[\"object\",\"null\"],\"required\":[\"credit_score_used\",\"decision\"],\"properties\":{\"decision\":{\"type\":\"string\",\"enum\":[\"approved\",\"denied\"]},\"credit_score_used\":{\"type\":\"number\"},\"denied_reasons\":{\"type\":\"array\",\"items\":{\"type\":\"string\",\"enum\":[\"insufficient_pay_stubs_provided\",\"low_credit_score\"]}}}},\"credit_policy\":{\"type\":\"object\",\"required\":[\"credit_score_to_use\",\"institution\",\"minimum_credit_score\",\"minimum_pay_stub_count\"],\"properties\":{\"id\":{\"type\":\"number\"},\"institution\":{\"type\":\"string\"},\"minimum_pay_stub_count\":{\"type\":\"number\",\"description\":\"The
        loan file must have at least this many pay stubs.\"},\"minimum_credit_score\":{\"type\":\"number\"},\"credit_score_to_use\":{\"type\":\"string\",\"enum\":[\"median\",\"maximum\"],\"description\":\"If
        the scores are 500, 650, and 700, then maximum will compare the biggest (700)
        against minimum_credit_score and median will compare the median (650) against
        minimum_credit_score.\"}}}}}}}\n\nYou have been ran with the following inputs:\n\n{\"loan_file\":{\"id\":3,\"state\":\"needs_review\",\"pay_stubs\":[{\"amount\":3000,\"date\":\"2025-06-25\",\"employer\":\"Some
        Employer\"}],\"credit_scores\":[{\"reporting_agency\":\"experian\",\"score\":600},{\"reporting_agency\":\"equifax\",\"score\":650},{\"reporting_agency\":\"transunion\",\"score\":750}],\"loan_application\":{\"applicant\":{\"name\":\"Fumiko\"}},\"credit_policy\":{\"id\":3,\"institution\":\"Bank
        C\",\"minimum_credit_score\":700,\"credit_score_to_use\":\"maximum\",\"minimum_pay_stub_count\":1}}}\n\nYou
        will answer with the name of the next command to run and, if needed, its inputs.
        Choose whichever command is best to make progress towards accomplishing the
        current goal based on the progress made so far. If the goal has been accomplished
        then choose the NotifyUserThatCurrentGoalHasBeenAccomplished command. If you
        are stuck either due to errors or because you do not have the command you
        need to accomplish the goal, then choose GiveUp.\n\nYou can get more details
        about the inputs and result schemas for a specific command by choosing the
        DescribeCommand command.\n\nYour result type is described by the following
        JSON schema:\n\n{\"type\":\"object\",\"required\":[\"command\"],\"properties\":{\"command\":{\"type\":\"string\"},\"inputs\":{\"type\":[\"object\",\"null\"]}}}\n\nYou
        will reply with nothing more than the JSON that you''ve generated that adheres
        to this result type schema so that the calling code can successfully parse
        your answer."}'
    headers:
      Content-Type:
      - application/json
      X-Api-Key:
      - "<SCRUBBED_ANTHROPIC_API_KEY>"
      Anthropic-Version:
      - '2023-06-01'
      Accept-Encoding:
      - gzip;q=1.0,deflate;q=0.6,identity;q=0.3
      Accept:
      - "*/*"
      User-Agent:
      - Ruby
  response:
    status:
      code: 200
      message: OK
    headers:
      Date:
      - Wed, 23 Jul 2025 20:43:40 GMT
      Content-Type:
      - application/json
      Transfer-Encoding:
      - chunked
      Connection:
      - keep-alive
      Anthropic-Ratelimit-Input-Tokens-Limit:
      - '80000'
      Anthropic-Ratelimit-Input-Tokens-Remaining:
      - '80000'
      Anthropic-Ratelimit-Input-Tokens-Reset:
      - '2025-07-23T20:43:40Z'
      Anthropic-Ratelimit-Output-Tokens-Limit:
      - '16000'
      Anthropic-Ratelimit-Output-Tokens-Remaining:
      - '16000'
      Anthropic-Ratelimit-Output-Tokens-Reset:
      - '2025-07-23T20:43:40Z'
      Anthropic-Ratelimit-Requests-Limit:
      - '2000'
      Anthropic-Ratelimit-Requests-Remaining:
      - '1999'
      Anthropic-Ratelimit-Requests-Reset:
      - '2025-07-23T20:43:29Z'
      Anthropic-Ratelimit-Tokens-Limit:
      - '96000'
      Anthropic-Ratelimit-Tokens-Remaining:
      - '96000'
      Anthropic-Ratelimit-Tokens-Reset:
      - '2025-07-23T20:43:40Z'
      Request-Id:
      - req_011CRQbqZhBpWBfFbfZ1oY7y
      Strict-Transport-Security:
      - max-age=31536000; includeSubDomains; preload
      Anthropic-Organization-Id:
      - 7a8e3751-3b70-4f90-a3ce-07f57c9d0bfc
      Via:
      - 1.1 google
      Cf-Cache-Status:
      - DYNAMIC
      X-Robots-Tag:
      - none
      Server:
      - cloudflare
      Cf-Ray:
      - 963e02a27beb67d7-SJC
    body:
      encoding: ASCII-8BIT
      string: '{"id":"msg_01MWF5kapPzvB8RTBdJrzhKa","type":"message","role":"assistant","model":"claude-opus-4-20250514","content":[{"type":"text","text":"{\"command\":\"Foobara::Agent::ReviewLoanFile::NotifyUserThatCurrentGoalHasBeenAccomplished\"}"}],"stop_reason":"end_turn","stop_sequence":null,"usage":{"input_tokens":2275,"cache_creation_input_tokens":0,"cache_read_input_tokens":0,"output_tokens":34,"service_tier":"standard"}}'
  recorded_at: Wed, 23 Jul 2025 20:43:40 GMT
- request:
    method: post
    uri: https://api.anthropic.com/v1/messages
    body:
      encoding: UTF-8
      string: '{"model":"claude-opus-4-20250514","max_tokens":1024,"messages":[{"role":"assistant","content":"{\"command\":\"Foobara::Agent::DescribeCommand\",\"inputs\":{\"command_name\":\"Foobara::Agent::ListCommands\"}}"},{"role":"user","content":"{\"success\":true,\"result\":{\"full_command_name\":\"Foobara::Agent::ListCommands\",\"description\":null,\"inputs_type\":{\"type\":\"object\"},\"result_type\":{\"type\":\"object\",\"required\":[\"agent_specific_commands\",\"user_provided_commands\"],\"properties\":{\"user_provided_commands\":{\"type\":\"array\",\"items\":{\"type\":\"string\"},\"description\":\"List
        of commands the user would like you to choose from to accomplish the goal\"},\"agent_specific_commands\":{\"type\":\"array\",\"items\":{\"type\":\"string\"},\"description\":\"Commands
        available to all agents to introspect or end the session\"}}}}}"},{"role":"assistant","content":"{\"command\":\"Foobara::Agent::ListCommands\"}"},{"role":"user","content":"{\"success\":true,\"result\":{\"user_provided_commands\":[\"FoobaraDemo::LoanOrigination::StartUnderwriterReview\",\"FoobaraDemo::LoanOrigination::DenyLoanFile\",\"FoobaraDemo::LoanOrigination::ApproveLoanFile\"],\"agent_specific_commands\":[\"Foobara::Agent::DescribeCommand\",\"Foobara::Agent::DescribeType\",\"Foobara::Agent::GiveUp\",\"Foobara::Agent::ListCommands\",\"Foobara::Agent::ReviewLoanFile::NotifyUserThatCurrentGoalHasBeenAccomplished\"]}}"},{"role":"assistant","content":"{\"command\":\"Foobara::Agent::DetermineNextCommandNameAndInputs\",\"inputs\":{\"agent\":\"#<Foobara::Agent:0x00007fb77c2dec50>\",\"llm_model\":\"claude-opus-4-20250514\",\"pass_aggregates_to_llm\":true}}"},{"role":"user","content":"{\"success\":false,\"errors_hash\":{\"runtime.could_not_parse_result_json\":{\"key\":\"runtime.could_not_parse_result_json\",\"path\":[],\"runtime_path\":[],\"category\":\"runtime\",\"symbol\":\"could_not_parse_result_json\",\"message\":\"Could
        not parse result JSON: unexpected token ''I'' at line 1 column 1\",\"context\":{\"raw_answer\":\"I
        need to review the loan file against the credit policy requirements. Let me
        check the details:\\n\\n**Loan File #3:**\\n- Credit scores: Experian 600,
        Equifax 650, TransUnion 750\\n- Credit policy uses \\\"maximum\\\" score,
        which would be 750\\n- Minimum required credit score: 700\\n- Pay stubs provided:
        1 (meets minimum requirement of 1)\\n\\nSince the maximum credit score (750)
        exceeds the minimum requirement (700) and the pay stub count meets the requirement,
        this loan file satisfies all requirements and should be approved.\\n\\n{\\\"command\\\":\\\"FoobaraDemo::LoanOrigination::ApproveLoanFile\\\",\\\"inputs\\\":{\\\"loan_file_id\\\":3}}\",\"stripped_answer\":\"I
        need to review the loan file against the credit policy requirements. Let me
        check the details:\\n\\n**Loan File #3:**\\n- Credit scores: Experian 600,
        Equifax 650, TransUnion 750\\n- Credit policy uses \\\"maximum\\\" score,
        which would be 750\\n- Minimum required credit score: 700\\n- Pay stubs provided:
        1 (meets minimum requirement of 1)\\n\\nSince the maximum credit score (750)
        exceeds the minimum requirement (700) and the pay stub count meets the requirement,
        this loan file satisfies all requirements and should be approved.\\n\\n{\\\"command\\\":\\\"FoobaraDemo::LoanOrigination::ApproveLoanFile\\\",\\\"inputs\\\":{\\\"loan_file_id\\\":3}}\"},\"is_fatal\":false}}}"},{"role":"assistant","content":"{\"command\":\"Foobara::Agent::DescribeCommand\",\"inputs\":{\"command_name\":\"FoobaraDemo::LoanOrigination::ApproveLoanFile\"}}"},{"role":"user","content":"{\"success\":true,\"result\":{\"full_command_name\":\"FoobaraDemo::LoanOrigination::ApproveLoanFile\",\"description\":null,\"inputs_type\":{\"type\":\"object\",\"required\":[\"credit_score_used\",\"loan_file\"],\"properties\":{\"credit_score_used\":{\"type\":\"number\"},\"loan_file\":{\"type\":\"number\",\"description\":\"LoanFile
        id\"}}}}}"},{"role":"assistant","content":"{\"command\":\"Foobara::Agent::DescribeCommand\",\"inputs\":{\"command_name\":\"FoobaraDemo::LoanOrigination::StartUnderwriterReview\"}}"},{"role":"user","content":"{\"success\":true,\"result\":{\"full_command_name\":\"FoobaraDemo::LoanOrigination::StartUnderwriterReview\",\"description\":null,\"inputs_type\":{\"type\":\"object\",\"required\":[\"loan_file\"],\"properties\":{\"loan_file\":{\"type\":\"number\",\"description\":\"LoanFile
        id\"}}}}}"},{"role":"assistant","content":"{\"command\":\"FoobaraDemo::LoanOrigination::StartUnderwriterReview\",\"inputs\":{\"loan_file\":3}}"},{"role":"user","content":"{\"success\":true,\"result\":null}"},{"role":"assistant","content":"{\"command\":\"FoobaraDemo::LoanOrigination::ApproveLoanFile\",\"inputs\":{\"loan_file\":3,\"credit_score_used\":750}}"},{"role":"user","content":"{\"success\":true,\"result\":null}"},{"role":"assistant","content":"{\"command\":\"Foobara::Agent::DescribeCommand\",\"inputs\":{\"command_name\":\"Foobara::Agent::ReviewLoanFile::NotifyUserThatCurrentGoalHasBeenAccomplished\"}}"},{"role":"user","content":"{\"success\":true,\"result\":{\"full_command_name\":\"Foobara::Agent::ReviewLoanFile::NotifyUserThatCurrentGoalHasBeenAccomplished\",\"description\":\"Notifies
        the user that the current goal has been accomplished and accepts a final result
        value as inputs. The user might issue a new goal.\",\"inputs_type\":{\"type\":\"object\",\"required\":[\"credit_score_used\",\"decision\"],\"properties\":{\"decision\":{\"type\":\"string\",\"enum\":[\"approved\",\"denied\"]},\"credit_score_used\":{\"type\":\"number\"},\"denied_reasons\":{\"type\":\"array\",\"items\":{\"type\":\"string\",\"enum\":[\"insufficient_pay_stubs_provided\",\"low_credit_score\"]}}}}}}"}],"temperature":0.0,"system":"You
        are part of an agent implementation. Your task is to decide which command
        to run next.\n\nYou are working towards accomplishing the following goal:
        Review loan file\n\nYour behavior has been described to the person or agent
        that chose to run you as: Checks the LoanFile against all requirements in
        its CreditPolicy. Denies the LoanFile that has any unsatisfied requirements.\n\nYour
        inputs to this command have the following type:\n\n{\"type\":\"object\",\"required\":[\"loan_file\"],\"properties\":{\"loan_file\":{\"type\":\"object\",\"required\":[\"credit_scores\",\"loan_application\",\"pay_stubs\",\"state\"],\"properties\":{\"id\":{\"type\":\"number\"},\"loan_application\":{\"type\":\"object\",\"required\":[\"applicant\"],\"properties\":{\"applicant\":{\"type\":\"object\",\"required\":[\"name\"],\"properties\":{\"name\":{\"type\":\"string\"}}}}},\"state\":{\"type\":\"string\",\"enum\":[\"building_loan_file\",\"denied\",\"drafting_docs\",\"in_escrow\",\"in_review\",\"needs_review\",\"recorded\"]},\"pay_stubs\":{\"type\":\"array\",\"items\":{\"type\":\"object\",\"required\":[\"amount\",\"date\",\"employer\"],\"properties\":{\"amount\":{\"type\":\"number\",\"description\":\"Amount
        in dollars of the pay check\"},\"date\":{\"type\":\"string\",\"format\":\"date\",\"description\":\"Date
        the paycheck was issued\"},\"employer\":{\"type\":\"string\",\"description\":\"Name
        of the employer that issued this paycheck\"}}}},\"credit_scores\":{\"type\":\"array\",\"items\":{\"type\":\"object\",\"properties\":{\"score\":{\"type\":\"number\"},\"reporting_agency\":{\"type\":\"string\",\"enum\":[\"equifax\",\"experian\",\"transunion\"]}}}},\"underwriter_decision\":{\"type\":[\"object\",\"null\"],\"required\":[\"credit_score_used\",\"decision\"],\"properties\":{\"decision\":{\"type\":\"string\",\"enum\":[\"approved\",\"denied\"]},\"credit_score_used\":{\"type\":\"number\"},\"denied_reasons\":{\"type\":\"array\",\"items\":{\"type\":\"string\",\"enum\":[\"insufficient_pay_stubs_provided\",\"low_credit_score\"]}}}},\"credit_policy\":{\"type\":\"object\",\"required\":[\"credit_score_to_use\",\"institution\",\"minimum_credit_score\",\"minimum_pay_stub_count\"],\"properties\":{\"id\":{\"type\":\"number\"},\"institution\":{\"type\":\"string\"},\"minimum_pay_stub_count\":{\"type\":\"number\",\"description\":\"The
        loan file must have at least this many pay stubs.\"},\"minimum_credit_score\":{\"type\":\"number\"},\"credit_score_to_use\":{\"type\":\"string\",\"enum\":[\"median\",\"maximum\"],\"description\":\"If
        the scores are 500, 650, and 700, then maximum will compare the biggest (700)
        against minimum_credit_score and median will compare the median (650) against
        minimum_credit_score.\"}}}}}}}\n\nYou have been ran with the following inputs:\n\n{\"loan_file\":{\"id\":3,\"state\":\"needs_review\",\"pay_stubs\":[{\"amount\":3000,\"date\":\"2025-06-25\",\"employer\":\"Some
        Employer\"}],\"credit_scores\":[{\"reporting_agency\":\"experian\",\"score\":600},{\"reporting_agency\":\"equifax\",\"score\":650},{\"reporting_agency\":\"transunion\",\"score\":750}],\"loan_application\":{\"applicant\":{\"name\":\"Fumiko\"}},\"credit_policy\":{\"id\":3,\"institution\":\"Bank
        C\",\"minimum_credit_score\":700,\"credit_score_to_use\":\"maximum\",\"minimum_pay_stub_count\":1}}}\n\nYou
        will answer with the name of the next command to run and, if needed, its inputs.
        Choose whichever command is best to make progress towards accomplishing the
        current goal based on the progress made so far. If the goal has been accomplished
        then choose the NotifyUserThatCurrentGoalHasBeenAccomplished command. If you
        are stuck either due to errors or because you do not have the command you
        need to accomplish the goal, then choose GiveUp.\n\nYou can get more details
        about the inputs and result schemas for a specific command by choosing the
        DescribeCommand command.\n\nYour result type is described by the following
        JSON schema:\n\n{\"type\":\"object\",\"required\":[\"command\"],\"properties\":{\"command\":{\"type\":\"string\"},\"inputs\":{\"type\":[\"object\",\"null\"]}}}\n\nYou
        will reply with nothing more than the JSON that you''ve generated that adheres
        to this result type schema so that the calling code can successfully parse
        your answer."}'
    headers:
      Content-Type:
      - application/json
      X-Api-Key:
      - "<SCRUBBED_ANTHROPIC_API_KEY>"
      Anthropic-Version:
      - '2023-06-01'
      Accept-Encoding:
      - gzip;q=1.0,deflate;q=0.6,identity;q=0.3
      Accept:
      - "*/*"
      User-Agent:
      - Ruby
  response:
    status:
      code: 200
      message: OK
    headers:
      Date:
      - Wed, 23 Jul 2025 20:43:43 GMT
      Content-Type:
      - application/json
      Transfer-Encoding:
      - chunked
      Connection:
      - keep-alive
      Anthropic-Ratelimit-Input-Tokens-Limit:
      - '80000'
      Anthropic-Ratelimit-Input-Tokens-Remaining:
      - '80000'
      Anthropic-Ratelimit-Input-Tokens-Reset:
      - '2025-07-23T20:43:43Z'
      Anthropic-Ratelimit-Output-Tokens-Limit:
      - '16000'
      Anthropic-Ratelimit-Output-Tokens-Remaining:
      - '16000'
      Anthropic-Ratelimit-Output-Tokens-Reset:
      - '2025-07-23T20:43:44Z'
      Anthropic-Ratelimit-Requests-Limit:
      - '2000'
      Anthropic-Ratelimit-Requests-Remaining:
      - '1999'
      Anthropic-Ratelimit-Requests-Reset:
      - '2025-07-23T20:43:41Z'
      Anthropic-Ratelimit-Tokens-Limit:
      - '96000'
      Anthropic-Ratelimit-Tokens-Remaining:
      - '96000'
      Anthropic-Ratelimit-Tokens-Reset:
      - '2025-07-23T20:43:43Z'
      Request-Id:
      - req_011CRQbrTLj6WkzFD4jnyiWb
      Strict-Transport-Security:
      - max-age=31536000; includeSubDomains; preload
      Anthropic-Organization-Id:
      - 7a8e3751-3b70-4f90-a3ce-07f57c9d0bfc
      Via:
      - 1.1 google
      Cf-Cache-Status:
      - DYNAMIC
      X-Robots-Tag:
      - none
      Server:
      - cloudflare
      Cf-Ray:
      - 963e02edc93c9e58-SJC
    body:
      encoding: ASCII-8BIT
      string: '{"id":"msg_011aAy6pPLsvCZnKz9j7yH6P","type":"message","role":"assistant","model":"claude-opus-4-20250514","content":[{"type":"text","text":"{\"command\":\"Foobara::Agent::ReviewLoanFile::NotifyUserThatCurrentGoalHasBeenAccomplished\",\"inputs\":{\"decision\":\"approved\",\"credit_score_used\":750}}"}],"stop_reason":"end_turn","stop_sequence":null,"usage":{"input_tokens":2495,"cache_creation_input_tokens":0,"cache_read_input_tokens":0,"output_tokens":49,"service_tier":"standard"}}'
  recorded_at: Wed, 23 Jul 2025 20:43:44 GMT
recorded_with: VCR 6.3.1
